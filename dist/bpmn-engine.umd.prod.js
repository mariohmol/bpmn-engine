!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("tty"),require("util"),require("os"),require("vm"),require("events")):"function"==typeof define&&define.amd?define(["exports","tty","util","os","vm","events"],t):t((e=e||self).BpmnEngine={},e.tty,e.util,e.os,e.vm,e.events)}(this,(function(e,t,n,r,i,o){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i,o=o&&o.hasOwnProperty("default")?o.default:o;var s=Object.prototype.toString,a=Object.prototype.hasOwnProperty;function c(e){var t=s.call(e);return"[object Function]"===t||"[object AsyncFunction]"===t||"[object GeneratorFunction]"===t||"[object AsyncGeneratorFunction]"===t||"[object Proxy]"===t}function u(e){return"[object String]"===s.call(e)}function p(e,t){return a.call(e,t)}function l(e,t){var n;return t=function(e){return c(e)?e:function(t){return t===e}}(t),f(e,(function(e,r){if(t(e,r))return n=e,!1})),n}function d(e,t){var n=[];return f(e,(function(e,r){t(e,r)&&n.push(e)})),n}function f(e,t){var n;if(void 0!==e){var r=function(e){return"[object Array]"===s.call(e)}(e)?g:m;for(var i in e)if(p(e,i)&&!1===t(n=e[i],r(i)))return n}}function m(e){return e}function g(e){return Number(e)}function y(e,t){return e.bind(t)}function h(){return(h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function b(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return h.apply(void 0,[e].concat(n))}function v(){}function x(e,t){this.model=e,this.properties=t}v.prototype.get=function(e){return this.$model.properties.get(this,e)},v.prototype.set=function(e,t){this.$model.properties.set(this,e,t)},x.prototype.createType=function(e){var t=this.model,n=this.properties,r=Object.create(v.prototype);f(e.properties,(function(e){e.isMany||void 0===e.default||(r[e.name]=e.default)})),n.defineModel(r,t),n.defineDescriptor(r,e);var i=e.ns.name;function o(e){n.define(this,"$type",{value:i,enumerable:!0}),n.define(this,"$attrs",{value:{}}),n.define(this,"$parent",{writable:!0}),f(e,y((function(e,t){this.set(t,e)}),this))}return o.prototype=r,o.hasType=r.$instanceOf=this.model.hasType,n.defineModel(o,t),n.defineDescriptor(o,e),o};var w={String:!0,Boolean:!0,Integer:!0,Real:!0,Element:!0},$={String:function(e){return e},Boolean:function(e){return"true"===e},Integer:function(e){return parseInt(e,10)},Real:function(e){return parseFloat(e,10)}};function E(e,t){var n=$[e];return n?n(t):t}function A(e){return!!w[e]}function C(e){return!!$[e]}function k(e,t){var n,r,i=e.split(/:/);if(1===i.length)n=e,r=t;else{if(2!==i.length)throw new Error("expected <prefix:localName> or <localName>, got "+e);n=i[1],r=i[0]}return{name:e=(r?r+":":"")+n,prefix:r,localName:n}}function I(e){this.ns=e,this.name=e.name,this.allTypes=[],this.allTypesByName={},this.properties=[],this.propertiesByName={}}function R(e,t){this.packageMap={},this.typeMap={},this.packages=[],this.properties=t,f(e,y(this.registerPackage,this))}function S(e,t,n){var r=t[n];if(r in e)throw new Error("package with "+n+" <"+r+"> already defined")}function T(e){this.model=e}function O(e,t,n){Object.defineProperty(e,t.name,{enumerable:!t.isReference,writable:!0,value:n,configurable:!0})}function P(e){this.properties=new T(this),this.factory=new x(this,this.properties),this.registry=new R(e,this.properties),this.typeCache={}}I.prototype.build=function(){return e=this,t=["ns","name","allTypes","allTypesByName","properties","propertiesByName","bodyProperty","idProperty"],n={},r=Object(e),f(t,(function(t){t in r&&(n[t]=e[t])})),n;var e,t,n,r},I.prototype.addProperty=function(e,t,n){"boolean"==typeof t&&(n=t,t=void 0),this.addNamedProperty(e,!1!==n);var r=this.properties;void 0!==t?r.splice(t,0,e):r.push(e)},I.prototype.replaceProperty=function(e,t,n){var r=e.ns,i=this.properties,o=this.propertiesByName,s=e.name!==t.name;if(e.isId){if(!t.isId)throw new Error("property <"+t.ns.name+"> must be id property to refine <"+e.ns.name+">");this.setIdProperty(t,!1)}if(e.isBody){if(!t.isBody)throw new Error("property <"+t.ns.name+"> must be body property to refine <"+e.ns.name+">");this.setBodyProperty(t,!1)}var a=i.indexOf(e);if(-1===a)throw new Error("property <"+r.name+"> not found in property list");i.splice(a,1),this.addProperty(t,n?void 0:a,s),o[r.name]=o[r.localName]=t},I.prototype.redefineProperty=function(e,t,n){var r=e.ns.prefix,i=t.split("#"),o=k(i[0],r),s=k(i[1],o.prefix).name,a=this.propertiesByName[s];if(!a)throw new Error("refined property <"+s+"> not found");this.replaceProperty(a,e,n),delete e.redefines},I.prototype.addNamedProperty=function(e,t){var n=e.ns,r=this.propertiesByName;t&&(this.assertNotDefined(e,n.name),this.assertNotDefined(e,n.localName)),r[n.name]=r[n.localName]=e},I.prototype.removeNamedProperty=function(e){var t=e.ns,n=this.propertiesByName;delete n[t.name],delete n[t.localName]},I.prototype.setBodyProperty=function(e,t){if(t&&this.bodyProperty)throw new Error("body property defined multiple times (<"+this.bodyProperty.ns.name+">, <"+e.ns.name+">)");this.bodyProperty=e},I.prototype.setIdProperty=function(e,t){if(t&&this.idProperty)throw new Error("id property defined multiple times (<"+this.idProperty.ns.name+">, <"+e.ns.name+">)");this.idProperty=e},I.prototype.assertNotDefined=function(e,t){var n=e.name,r=this.propertiesByName[n];if(r)throw new Error("property <"+n+"> already defined; override of <"+r.definedBy.ns.name+"#"+r.ns.name+"> by <"+e.definedBy.ns.name+"#"+e.ns.name+"> not allowed without redefines")},I.prototype.hasProperty=function(e){return this.propertiesByName[e]},I.prototype.addTrait=function(e,t){var n=this.allTypesByName,r=this.allTypes,i=e.name;i in n||(f(e.properties,y((function(n){n=b({},n,{name:n.ns.localName,inherited:t}),Object.defineProperty(n,"definedBy",{value:e});var r=n.replaces,i=n.redefines;r||i?this.redefineProperty(n,r||i,r):(n.isBody&&this.setBodyProperty(n),n.isId&&this.setIdProperty(n),this.addProperty(n))}),this)),r.push(e),n[i]=e)},R.prototype.getPackage=function(e){return this.packageMap[e]},R.prototype.getPackages=function(){return this.packages},R.prototype.registerPackage=function(e){e=b({},e);var t=this.packageMap;S(t,e,"prefix"),S(t,e,"uri"),f(e.types,y((function(t){this.registerType(t,e)}),this)),t[e.uri]=t[e.prefix]=e,this.packages.push(e)},R.prototype.registerType=function(e,t){var n=k((e=b({},e,{superClass:(e.superClass||[]).slice(),extends:(e.extends||[]).slice(),properties:(e.properties||[]).slice(),meta:b(e.meta||{})})).name,t.prefix),r=n.name,i={};f(e.properties,y((function(e){var t=k(e.name,n.prefix),r=t.name;A(e.type)||(e.type=k(e.type,t.prefix).name),b(e,{ns:t,name:r}),i[r]=e}),this)),b(e,{ns:n,name:r,propertiesByName:i}),f(e.extends,y((function(e){var t=this.typeMap[e];t.traits=t.traits||[],t.traits.push(r)}),this)),this.definePackage(e,t),this.typeMap[r]=e},R.prototype.mapTypes=function(e,t,n){var r=A(e.name)?{name:e.name}:this.typeMap[e.name],i=this;function o(e){return s(e,!0)}function s(n,r){var o=k(n,A(n)?"":e.prefix);i.mapTypes(o,t,r)}if(!r)throw new Error("unknown type <"+e.name+">");f(r.superClass,n?o:s),t(r,!n),f(r.traits,o)},R.prototype.getEffectiveDescriptor=function(e){var t=k(e),n=new I(t);this.mapTypes(t,(function(e,t){n.addTrait(e,t)}));var r=n.build();return this.definePackage(r,r.allTypes[r.allTypes.length-1].$pkg),r},R.prototype.definePackage=function(e,t){this.properties.define(e,"$pkg",{value:t})},T.prototype.set=function(e,t,n){var r=this.model.getPropertyDescriptor(e,t),i=r&&r.name;void 0===n?r?delete e[i]:delete e.$attrs[t]:r?i in e?e[i]=n:O(e,r,n):e.$attrs[t]=n},T.prototype.get=function(e,t){var n=this.model.getPropertyDescriptor(e,t);if(!n)return e.$attrs[t];var r=n.name;return!e[r]&&n.isMany&&O(e,n,[]),e[r]},T.prototype.define=function(e,t,n){Object.defineProperty(e,t,n)},T.prototype.defineDescriptor=function(e,t){this.define(e,"$descriptor",{value:t})},T.prototype.defineModel=function(e,t){this.define(e,"$model",{value:t})},P.prototype.create=function(e,t){var n=this.getType(e);if(!n)throw new Error("unknown type <"+e+">");return new n(t)},P.prototype.getType=function(e){var t=this.typeCache,n=u(e)?e:e.ns.name,r=t[n];return r||(e=this.registry.getEffectiveDescriptor(n),r=t[n]=this.factory.createType(e)),r},P.prototype.createAny=function(e,t,n){var r=k(e),i={$type:e,$instanceOf:function(e){return e===this.$type}},o={name:e,isGeneric:!0,ns:{prefix:r.prefix,localName:r.localName,uri:t}};return this.properties.defineDescriptor(i,o),this.properties.defineModel(i,this),this.properties.define(i,"$parent",{enumerable:!1,writable:!0}),f(n,(function(e,t){var n;n=e,"[object Object]"===s.call(n)&&void 0!==e.value?i[e.name]=e.value:i[t]=e})),i},P.prototype.getPackage=function(e){return this.registry.getPackage(e)},P.prototype.getPackages=function(){return this.registry.getPackages()},P.prototype.getElementDescriptor=function(e){return e.$descriptor},P.prototype.hasType=function(e,t){return void 0===t&&(t=e,e=this),t in e.$model.getElementDescriptor(e).allTypesByName},P.prototype.getPropertyDescriptor=function(e,t){return this.getElementDescriptor(e).propertiesByName[t]},P.prototype.getTypeDescriptor=function(e){return this.registry.typeMap[e]};var D=String.fromCharCode,M=Object.prototype.hasOwnProperty,B=/&#(\d+);|&#x([0-9a-f]+);|&(\w+);/gi,_={amp:"&",apos:"'",gt:">",lt:"<",quot:'"'};function F(e,t,n,r){return r?M.call(_,r)?_[r]:"&"+r+";":D(t||parseInt(n,16))}function N(e){return e.length>3&&-1!==e.indexOf("&")?e.replace(B,F):e}Object.keys(_).forEach((function(e){_[e.toUpperCase()]=_[e]}));var q="http://www.w3.org/2001/XMLSchema-instance",j="xsi",L="xsi:type",Q="non-whitespace outside of root node";function V(e){return new Error(e)}function z(e){return"missing namespace for prefix <"+e+">"}function K(e){return{get:e,enumerable:!0}}function G(e){var t,n={};for(t in e)n[t]=e[t];return n}function U(e){return e+"$uri"}function H(){return{line:0,column:0}}function W(e){throw e}function X(e){if(!this)return new X(e);var t,n,r,i,o,s,a,c,u,p=e&&e.proxy,l=W,d=H,f=!1,m=!1,g=null,y=!1;function h(e){e instanceof Error||(e=V(e)),g=e,l(e,d)}function b(e){o&&(e instanceof Error||(e=V(e)),o(e,d))}this.on=function(e,u){if("function"!=typeof u)throw V("required args <name, cb>");switch(e){case"openTag":n=u;break;case"text":t=u;break;case"closeTag":r=u;break;case"error":l=u;break;case"warn":o=u;break;case"cdata":i=u;break;case"attention":c=u;break;case"question":a=u;break;case"comment":s=u;break;default:throw V("unsupported event: "+e)}return this},this.ns=function(e){if(void 0===e&&(e={}),"object"!=typeof e)throw V("required args <nsMap={}>");var t,n={};for(t in e)n[t]=e[t];return n[q]=j,m=!0,u=n,this},this.parse=function(e){if("string"!=typeof e)throw V("required args <xml=string>");return g=null,function(e){var o,l,g,v,x,w,$,E,A,C,k=m?[]:null,I=m?function(e){var t,n,r={};for(t in e)r[n=e[t]]=n,r[U(n)]=t;return r}(u):null,R=[],S=0,T=!1,O=!1,P=0,D=0,M="",B=0;function _(){if(null!==C)return C;var e,t,n,r,i,o,s,a,c,p,l,d=m&&I.xmlns,g=m&&f?[]:null,y=B,h=M,v=h.length,x={},w={};e:for(;y<v;y++)if(c=!1,!(32===(p=h.charCodeAt(y))||p<14&&p>8)){for((p<65||p>122||p>90&&p<97)&&95!==p&&58!==p&&(b("illegal first char attribute name"),c=!0),l=y+1;l<v;l++)if(!((p=h.charCodeAt(l))>96&&p<123||p>64&&p<91||p>47&&p<59||46===p||45===p||95===p)){if(32===p||p<14&&p>8){b("missing attribute value"),y=l;continue e}if(61===p)break;b("illegal attribute name char"),c=!0}if("xmlns:xmlns"===(a=h.substring(y,l))&&(b("illegal declaration of xmlns"),c=!0),34===(p=h.charCodeAt(l+1)))-1===(l=h.indexOf('"',y=l+2))&&-1!==(l=h.indexOf("'",y))&&(b("attribute value quote missmatch"),c=!0);else if(39===p)-1===(l=h.indexOf("'",y=l+2))&&-1!==(l=h.indexOf('"',y))&&(b("attribute value quote missmatch"),c=!0);else for(b("missing attribute value quotes"),c=!0,l+=1;l<v&&!(32===(p=h.charCodeAt(l+1))||p<14&&p>8);l++);for(-1===l&&(b("missing closing quotes"),l=v,c=!0),c||(o=h.substring(y,l)),y=l;l+1<v&&!(32===(p=h.charCodeAt(l+1))||p<14&&p>8);l++)y===l&&(b("illegal character after attribute end"),c=!0);if(y=l+1,!c)if(a in w)b("attribute <"+a+"> already defined");else if(w[a]=!0,m)if(f){if(null!==(i="xmlns"===a?"xmlns":120===a.charCodeAt(0)&&"xmlns:"===a.substr(0,6)?a.substr(6):null)){if(e=N(o),t=U(i),!(s=u[e])){if("xmlns"===i||t in I&&I[t]!==e)do{s="ns"+S++}while(void 0!==I[s]);else s=i;u[e]=s}I[i]!==s&&(r||(I=G(I),r=!0),I[i]=s,"xmlns"===i&&(I[U(s)]=e,d=s),I[t]=e),x[a]=o;continue}g.push(a,o)}else-1!==(p=a.indexOf(":"))?(n=I[a.substring(0,p)])?((a=d===n?a.substr(p+1):n+a.substr(p))===L&&(-1!==(p=o.indexOf(":"))?(n=o.substring(0,p),o=(n=I[n]||n)+o.substring(p)):o=d+":"+o),x[a]=o):b(z(a.substring(0,p))):x[a]=o;else x[a]=o}if(f)for(y=0,v=g.length;y<v;y++){if(a=g[y++],o=g[y],-1!==(p=a.indexOf(":"))){if(!(n=I[a.substring(0,p)])){b(z(a.substring(0,p)));continue}(a=d===n?a.substr(p+1):n+a.substr(p))===L&&(-1!==(p=o.indexOf(":"))?(n=o.substring(0,p),o=(n=I[n]||n)+o.substring(p)):o=d+":"+o)}x[a]=o}return C=x}d=function(){var t,n,r=/(\r\n|\r|\n)/g,i=0,o=0,s=0,a=D;for(;P>=s&&(t=r.exec(e))&&!((a=t[0].length+t.index)>P);)i+=1,s=a;-1==P?(o=a,n=e.substring(D)):0===D?(console.log(P-s),n=e.substring(D,P)):(o=P-s,n=-1==D?e.substring(P):e.substring(P,D+1));return{data:n,line:i,column:o}},p&&(A=Object.create({},{name:K((function(){return $})),originalName:K((function(){return E})),attrs:K(_),ns:K((function(){return I}))}));for(;-1!==D;){if(-1===(P=60===e.charCodeAt(D)?D:e.indexOf("<",D)))return R.length?h("unexpected end of file"):0===D?h("missing start tag"):void(D<e.length&&e.substring(D).trim()&&b(Q));if(D!==P)if(R.length){if(t&&(t(e.substring(D,P),N,d),y))return}else if(e.substring(D,P).trim()&&(b(Q),y))return;if(33!==(x=e.charCodeAt(P+1)))if(63!==x){if(-1==(D=e.indexOf(">",P+1)))return h("unclosed tag");if(C={},47===x){if(T=!1,O=!0,!R.length)return h("missing open tag");if(l=$=R.pop(),v=P+2+l.length,e.substring(P+2,v)!==l)return h("closing tag mismatch");for(;v<D;v++)if(!(32===(x=e.charCodeAt(v))||x>8&&x<14))return h("close tag")}else{if(47===e.charCodeAt(D-1)?(l=$=e.substring(P+1,D-1),T=!0,O=!0):(l=$=e.substring(P+1,D),T=!0,O=!1),!(x>96&&x<123||x>64&&x<91||95===x||58===x))return h("illegal first char nodeName");for(v=1,g=l.length;v<g;v++)if(!((x=l.charCodeAt(v))>96&&x<123||x>64&&x<91||x>47&&x<59||45===x||95===x||46==x)){if(32===x||x<14&&x>8){$=l.substring(0,v),C=null;break}return h("invalid nodeName")}O||R.push($)}if(m){if(o=I,T&&(O||k.push(o),null===C&&(f=-1!==l.indexOf("xmlns",v))&&(B=v,M=l,_(),f=!1)),E=$,-1!==(x=$.indexOf(":"))){if(!(w=I[$.substring(0,x)]))return h("missing namespace on <"+E+">");$=$.substr(x+1)}else w=I.xmlns;w&&($=w+":"+$)}if(T&&(B=v,M=l,n&&(p?n(A,N,O,d):n($,_,N,O,d),y)))return;if(O){if(r&&(r(p?A:$,N,T,d),y))return;m&&(I=T?o:k.pop())}D+=1}else{if(-1===(D=e.indexOf("?>",P)))return h("unclosed question");if(a&&(a(e.substring(P,D+2),d),y))return;D+=2}else{if(91===(x=e.charCodeAt(P+2))&&"CDATA["===e.substr(P+3,6)){if(-1===(D=e.indexOf("]]>",P)))return h("unclosed cdata");if(i&&(i(e.substring(P+9,D),d),y))return;D+=3;continue}if(45===x&&45===e.charCodeAt(P+3)){if(-1===(D=e.indexOf("--\x3e",P)))return h("unclosed comment");if(s&&(s(e.substring(P+4,D),N,d),y))return;D+=3;continue}if(-1===(D=e.indexOf(">",P+1)))return h("unclosed tag");if(c&&(c(e.substring(P,D+1),N,d),y))return;D+=1}}}(e),d=H,y=!1,g},this.stop=function(){y=!0}}function J(e){return e.xml&&"lowerCase"===e.xml.tagAlias}var Y={xsi:"http://www.w3.org/2001/XMLSchema-instance"},Z="xsi:type";function ee(e){return e.xml&&e.xml.serialize}function te(e){return ee(e)===Z}function ne(e,t){return J(t)?e.prefix+":"+((n=e.localName).charAt(0).toUpperCase()+n.slice(1)):e.name;var n}function re(e){return new Error(e)}function ie(e){return e.$descriptor}function oe(e){b(this,e),this.elementsById={},this.references=[],this.warnings=[],this.addReference=function(e){this.references.push(e)},this.addElement=function(e){if(!e)throw re("expected element");var t,n=this.elementsById,r=ie(e).idProperty;if(r&&(t=e.get(r.name))){if(!/^([a-z][\w-.]*:)?[a-z_][\w-.]*$/i.test(t))throw new Error("illegal ID <"+t+">");if(n[t])throw re("duplicate ID <"+t+">");n[t]=e}},this.addWarning=function(e){this.warnings.push(e)}}function se(){}function ae(){}function ce(){}function ue(e,t){this.property=e,this.context=t}function pe(e,t){this.element=t,this.propertyDesc=e}function le(){}function de(e,t,n){this.model=e,this.type=e.getType(t),this.context=n}function fe(e,t,n){de.call(this,e,t,n)}function me(e,t,n){this.model=e,this.context=n}function ge(e){e instanceof P&&(e={model:e}),b(this,{lax:!1},e)}se.prototype.handleEnd=function(){},se.prototype.handleText=function(){},se.prototype.handleNode=function(){},ae.prototype=Object.create(se.prototype),ae.prototype.handleNode=function(){return this},ce.prototype=Object.create(se.prototype),ce.prototype.handleText=function(e){this.body=(this.body||"")+e},ue.prototype=Object.create(ce.prototype),ue.prototype.handleNode=function(e){if(this.element)throw re("expected no sub nodes");return this.element=this.createReference(e),this},ue.prototype.handleEnd=function(){this.element.id=this.body},ue.prototype.createReference=function(e){return{property:this.property.ns.name,id:""}},pe.prototype=Object.create(ce.prototype),pe.prototype.handleEnd=function(){var e=this.body||"",t=this.element,n=this.propertyDesc;e=E(n.type,e),n.isMany?t.get(n.name).push(e):t.set(n.name,e)},le.prototype=Object.create(ce.prototype),le.prototype.handleNode=function(e){var t=this,n=this.element;return n?t=this.handleChild(e):(n=this.element=this.createElement(e),this.context.addElement(n)),t},de.prototype=Object.create(le.prototype),de.prototype.addReference=function(e){this.context.addReference(e)},de.prototype.handleText=function(e){if(!ie(this.element).bodyProperty)throw re("unexpected body text <"+e+">");ce.prototype.handleText.call(this,e)},de.prototype.handleEnd=function(){var e=this.body,t=this.element,n=ie(t).bodyProperty;n&&void 0!==e&&(e=E(n.type,e),t.set(n.name,e))},de.prototype.createElement=function(e){var t,n=e.attributes,r=this.type,i=ie(r),o=this.context,s=new r({}),a=this.model;return f(n,(function(e,n){var r=i.propertiesByName[n];r&&r.isReference?r.isMany?f(e.split(" "),(function(e){o.addReference({element:s,property:r.ns.name,id:e})})):o.addReference({element:s,property:r.ns.name,id:e}):(r?e=E(r.type,e):"xmlns"!==n&&(t=k(n,i.ns.prefix),a.getPackage(t.prefix)&&o.addWarning({message:"unknown attribute <"+n+">",element:s,property:n,value:e})),s.set(n,e))})),s},de.prototype.getPropertyForNode=function(e){var t,n,r=k(e.name),i=this.type,o=this.model,s=ie(i),a=r.name,c=s.propertiesByName[a];if(c)return te(c)&&(t=e.attributes[Z])?(t=function(e,t){var n=k(e);return function(e,t){var n=e.name,r=e.localName,i=t.xml&&t.xml.typePrefix;return i&&0===r.indexOf(i)?e.prefix+":"+r.slice(i.length):n}(n,t.getPackage(n.prefix))}(t,o),b({},c,{effectiveType:ie(n=o.getType(t)).name})):c;var u=o.getPackage(r.prefix);if(u){if(t=ne(r,u),n=o.getType(t),c=l(s.properties,(function(e){return!e.isVirtual&&!e.isReference&&!e.isAttribute&&n.hasType(e.type)})))return b({},c,{effectiveType:ie(n).name})}else if(c=l(s.properties,(function(e){return!e.isReference&&!e.isAttribute&&"Element"===e.type})))return c;throw re("unrecognized element <"+r.name+">")},de.prototype.toString=function(){return"ElementDescriptor["+ie(this.type).name+"]"},de.prototype.valueHandler=function(e,t){return new pe(e,t)},de.prototype.referenceHandler=function(e){return new ue(e,this.context)},de.prototype.handler=function(e){return"Element"===e?new me(this.model,e,this.context):new de(this.model,e,this.context)},de.prototype.handleChild=function(e){var t,n,r,i;if(t=this.getPropertyForNode(e),r=this.element,C(n=t.effectiveType||t.type))return this.valueHandler(t,r);var o=(i=t.isReference?this.referenceHandler(t).handleNode(e):this.handler(n).handleNode(e)).element;return void 0!==o&&(t.isMany?r.get(t.name).push(o):r.set(t.name,o),t.isReference?(b(o,{element:r}),this.context.addReference(o)):o.$parent=r),i},fe.prototype=Object.create(de.prototype),fe.prototype.createElement=function(e){var t=e.name,n=k(t),r=this.model,i=this.type,o=r.getPackage(n.prefix),s=o&&ne(n,o)||t;if(!i.hasType(s))throw re("unexpected element <"+e.originalName+">");return de.prototype.createElement.call(this,e)},me.prototype=Object.create(le.prototype),me.prototype.createElement=function(e){var t=e.name,n=k(t).prefix,r=e.ns[n+"$uri"],i=e.attributes;return this.model.createAny(t,r,i)},me.prototype.handleChild=function(e){var t=new me(this.model,"Element",this.context).handleNode(e),n=this.element,r=t.element;return void 0!==r&&((n.$children=n.$children||[]).push(r),r.$parent=n),t},me.prototype.handleEnd=function(){this.body&&(this.element.$body=this.body)},ge.prototype.fromXML=function(e,t,n){var r=t.rootHandler;t instanceof de?(r=t,t={}):"string"==typeof t?(r=this.handler(t),t={}):"string"==typeof r&&(r=this.handler(r));var i=this.model,o=this.lax,s=new oe(b({},t,{rootHandler:r})),a=new X({proxy:!0}),c=function(){var e=[];return Object.defineProperty(e,"peek",{value:function(){return this[this.length-1]}}),e}();function u(e,t,n){var r=t(),i=r.line,o=r.column,a=r.data;"<"===a.charAt(0)&&-1!==a.indexOf(" ")&&(a=a.slice(0,a.indexOf(" "))+">");var c="unparsable content "+(a?a+" ":"")+"detected\n\tline: "+i+"\n\tcolumn: "+o+"\n\tnested error: "+e.message;if(n)return s.addWarning({message:c,error:e}),!0;throw re(c)}function p(e,t){return u(e,t,!0)}r.context=s,c.push(r);var l=/^<\?xml /i,d=/ encoding="([^"]+)"/i,f=/^utf-8$/i;function m(e,t){try{c.peek().handleText(e)}catch(e){p(e,t)}}var g=i.getPackages().reduce((function(e,t){return e[t.uri]=t.prefix,e}),{});a.ns(g).on("openTag",(function(e,t,n,r){var i=e.attrs||{},s=Object.keys(i).reduce((function(e,n){var r=t(i[n]);return e[n]=r,e}),{});!function(e,t){var n=c.peek();try{c.push(n.handleNode(e))}catch(e){u(e,t,o)&&c.push(new ae)}}({name:e.name,originalName:e.originalName,attributes:s,ns:e.ns},r)})).on("question",(function(e){if(l.test(e)){var t=d.exec(e),n=t&&t[1];n&&!f.test(n)&&s.addWarning({message:"unsupported document encoding <"+n+">, falling back to UTF-8"})}})).on("closeTag",(function(){c.pop().handleEnd()})).on("cdata",m).on("text",(function(e,t,n){!function(e,t){(e=e.trim())&&m(e,t)}(t(e),n)})).on("error",u).on("warn",p),setTimeout((function(){var t;try{a.parse(e),function(){var e,t,n=s.elementsById,r=s.references;for(e=0;t=r[e];e++){var i=t.element,o=n[t.id],a=ie(i).propertiesByName[t.property];if(o||s.addWarning({message:"unresolved reference <"+t.id+">",element:t.element,property:t.property,value:t.id}),a.isMany){var c=i.get(a.name),u=c.indexOf(t);-1===u&&(u=c.length),o?c[u]=o:c.splice(u,1)}else i.set(a.name,o)}}()}catch(e){t=e}var i=r.element;t||i||(t=re("failed to parse document as <"+r.type.$descriptor.name+">")),n(t,t?void 0:i,s)}),0)},ge.prototype.handler=function(e){return new fe(this.model,e)};var ye='<?xml version="1.0" encoding="UTF-8"?>\n',he=/<|>|'|"|&|\n\r|\n/g,be=/<|>|&/g;function ve(e){var t={},n={},r={},i=[],o=[];this.byUri=function(t){return n[t]||e&&e.byUri(t)},this.add=function(e,t){n[e.uri]=e,t?i.push(e):o.push(e),this.mapPrefix(e.prefix,e.uri)},this.uriByPrefix=function(e){return t[e||"xmlns"]},this.mapPrefix=function(e,n){t[e||"xmlns"]=n},this.logUsed=function(e){var t=e.uri;r[t]=this.byUri(t)},this.getUsed=function(e){return[].concat(i,o).filter((function(e){return r[e.uri]}))}}function xe(e,t){return J(t)?(n=e).charAt(0).toLowerCase()+n.slice(1):e;var n}function we(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}function $e(e){return u(e)?e:(e.prefix?e.prefix+":":"")+e.localName}function Ee(e){return t=e.getUsed(),n=function(e){return{name:"xmlns"+(e.prefix?":"+e.prefix:""),value:e.uri}},r=[],f(t,(function(e,t){r.push(n(e,t))})),r;var t,n,r}var Ae={"\n":"#10","\n\r":"#10",'"':"#34","'":"#39","<":"#60",">":"#62","&":"#38"},Ce={"<":"lt",">":"gt","&":"amp"};function ke(e,t,n){return(e=u(e)?e:""+e).replace(t,(function(e){return"&"+n[e]+";"}))}function Ie(e){this.tagName=e}function Re(){}function Se(e){this.tagName=e}function Te(e,t){this.body=[],this.attrs=[],this.parent=e,this.propertyDescriptor=t}function Oe(e,t){Te.call(this,e,t)}function Pe(){this.value="",this.write=function(e){this.value+=e}}function De(e,t){var n=[""];this.append=function(t){return e.write(t),this},this.appendNewLine=function(){return t&&e.write("\n"),this},this.appendIndent=function(){return t&&e.write(n.join("  ")),this},this.indent=function(){return n.push(""),this},this.unindent=function(){return n.pop(),this}}function Me(e){return e=b({format:!1,preamble:!0},e||{}),{toXML:function(t,n){var r=n||new Pe,i=new De(r,e.format);if(e.preamble&&i.append(ye),(new Te).build(t).serializeTo(i),!n)return r.value}}}function Be(e,t){P.call(this,e,t)}Ie.prototype.build=function(e){return this.element=e,this},Ie.prototype.serializeTo=function(e){e.appendIndent().append("<"+this.tagName+">"+this.element.id+"</"+this.tagName+">").appendNewLine()},Re.prototype.serializeValue=Re.prototype.serializeTo=function(e){e.append(this.escape?ke(this.value,be,Ce):this.value)},Re.prototype.build=function(e,t){return this.value=t,"String"===e.type&&-1!==t.search(be)&&(this.escape=!0),this},we(Se,Re),Se.prototype.serializeTo=function(e){e.appendIndent().append("<"+this.tagName+">"),this.serializeValue(e),e.append("</"+this.tagName+">").appendNewLine()},Te.prototype.build=function(e){this.element=e;var t,n,r=e.$descriptor,i=this.propertyDescriptor,o=r.isGeneric;return t=o?this.parseGeneric(e):this.parseNsAttributes(e),this.ns=i?this.nsPropertyTagName(i):this.nsTagName(r),this.tagName=this.addTagName(this.ns),o||(n=function(e){return d(e.$descriptor.properties,(function(t){var n=t.name;if(t.isVirtual)return!1;if(!e.hasOwnProperty(n))return!1;var r=e[n];return r!==t.default&&(null!==r&&(!t.isMany||r.length))}))}(e),this.parseAttributes(d(n,(function(e){return e.isAttr}))),this.parseContainments(function(e){return d(e,(function(e){return!e.isAttr}))}(n))),this.parseGenericAttributes(e,t),this},Te.prototype.nsTagName=function(e){return function(e,t){return t.isGeneric?b({localName:t.ns.localName},e):b({localName:xe(t.ns.localName,t.$pkg)},e)}(this.logNamespaceUsed(e.ns),e)},Te.prototype.nsPropertyTagName=function(e){return function(e,t){return b({localName:t.ns.localName},e)}(this.logNamespaceUsed(e.ns),e)},Te.prototype.isLocalNs=function(e){return e.uri===this.ns.uri},Te.prototype.nsAttributeName=function(e){var t;if(t=u(e)?k(e):e.ns,e.inherited)return{localName:t.localName};var n=this.logNamespaceUsed(t);return this.getNamespaces().logUsed(n),this.isLocalNs(n)?{localName:t.localName}:b({localName:t.localName},n)},Te.prototype.parseGeneric=function(e){var t=this,n=this.body,r=[];return f(e,(function(i,o){"$body"===o?n.push((new Re).build({type:"String"},i)):"$children"===o?f(i,(function(e){n.push(new Te(t).build(e))})):0!==o.indexOf("$")&&t.parseNsAttribute(e,o,i)&&r.push({name:o,value:i})})),r},Te.prototype.parseNsAttribute=function(e,t,n){var r,i=e.$model,o=k(t);if("xmlns"===o.prefix&&(r={prefix:o.localName,uri:n}),o.prefix||"xmlns"!==o.localName||(r={uri:n}),!r)return{name:t,value:n};if(i&&i.getPackage(n))this.logNamespace(r,!0,!0);else{var s=this.logNamespaceUsed(r,!0);this.getNamespaces().logUsed(s)}},Te.prototype.parseNsAttributes=function(e,t){var n=this,r=e.$attrs,i=[];return f(r,(function(t,r){var o=n.parseNsAttribute(e,r,t);o&&i.push(o)})),i},Te.prototype.parseGenericAttributes=function(e,t){var n=this;f(t,(function(t){if(t.name!==Z)try{n.addAttribute(n.nsAttributeName(t.name),t.value)}catch(n){console.warn("missing namespace information for ",t.name,"=",t.value,"on",e,n)}}))},Te.prototype.parseContainments=function(e){var t=this,n=this.body,r=this.element;f(e,(function(e){var i=r.get(e.name),o=e.isReference;if(e.isMany||(i=[i]),e.isBody)n.push((new Re).build(e,i[0]));else if(C(e.type))f(i,(function(r){n.push(new Se(t.addTagName(t.nsPropertyTagName(e))).build(e,r))}));else if(o)f(i,(function(r){n.push(new Ie(t.addTagName(t.nsPropertyTagName(e))).build(r))}));else{var s=te(e),a=function(e){return"property"===ee(e)}(e);f(i,(function(r){var i;i=s?new Oe(t,e):a?new Te(t,e):new Te(t),n.push(i.build(r))}))}}))},Te.prototype.getNamespaces=function(e){var t,n=this.namespaces,r=this.parent;return n||(t=r&&r.getNamespaces(),e||!t?this.namespaces=n=new ve(t):n=t),n},Te.prototype.logNamespace=function(e,t,n){var r=this.getNamespaces(n),i=e.uri,o=e.prefix;return r.byUri(i)||r.add(e,t),r.mapPrefix(o,i),e},Te.prototype.logNamespaceUsed=function(e,t){var n,r,i,o=this.element.$model,s=this.getNamespaces(t),a=e.prefix,c=e.uri;if(!a&&!c)return{localName:e.localName};if(i=Y[a]||o&&(o.getPackage(a)||{}).uri,!(c=c||i||s.uriByPrefix(a)))throw new Error("no namespace uri given for prefix <"+a+">");if(!(e=s.byUri(c))){for(n=a,r=1;s.uriByPrefix(n);)n=a+"_"+r++;e=this.logNamespace({prefix:n,uri:c},i===c)}return a&&s.mapPrefix(a,c),e},Te.prototype.parseAttributes=function(e){var t=this,n=this.element;f(e,(function(e){var r=n.get(e.name);if(e.isReference)if(e.isMany){var i=[];f(r,(function(e){i.push(e.id)})),r=i.join(" ")}else r=r.id;t.addAttribute(t.nsAttributeName(e),r)}))},Te.prototype.addTagName=function(e){var t=this.logNamespaceUsed(e);return this.getNamespaces().logUsed(t),$e(e)},Te.prototype.addAttribute=function(e,t){var n=this.attrs;u(t)&&(t=ke(t,he,Ae)),n.push({name:e,value:t})},Te.prototype.serializeAttributes=function(e){var t=this.attrs,n=this.namespaces;n&&(t=Ee(n).concat(t)),f(t,(function(t){e.append(" ").append($e(t.name)).append('="').append(t.value).append('"')}))},Te.prototype.serializeTo=function(e){var t=this.body[0],n=t&&t.constructor!==Re;e.appendIndent().append("<"+this.tagName),this.serializeAttributes(e),e.append(t?">":" />"),t&&(n&&e.appendNewLine().indent(),f(this.body,(function(t){t.serializeTo(e)})),n&&e.unindent().appendIndent(),e.append("</"+this.tagName+">")),e.appendNewLine()},we(Oe,Te),Oe.prototype.parseNsAttributes=function(e){var t=Te.prototype.parseNsAttributes.call(this,e),n=e.$descriptor;if(n.name===this.propertyDescriptor.type)return t;var r=this.typeNs=this.nsTagName(n);this.getNamespaces().logUsed(this.typeNs);var i=e.$model.getPackage(r.uri),o=i.xml&&i.xml.typePrefix||"";return this.addAttribute(this.nsAttributeName(Z),(r.prefix?r.prefix+":":"")+o+n.ns.localName),t},Oe.prototype.isLocalNs=function(e){return e.uri===(this.typeNs||this.ns).uri},Be.prototype=Object.create(P.prototype),Be.prototype.fromXML=function(e,t,n,r){u(t)||(r=n,n=t,t="bpmn:Definitions"),c(n)&&(r=n,n={});var i=new ge(b({model:this,lax:!0},n)),o=i.handler(t);i.fromXML(e,o,r)},Be.prototype.toXML=function(e,t,n){c(t)&&(n=t,t={});var r,i,o=new Me(t);try{r=o.toXML(e)}catch(e){i=e}return n(i,r)};var _e={bpmn:{name:"BPMN20",uri:"http://www.omg.org/spec/BPMN/20100524/MODEL",associations:[],types:[{name:"Interface",superClass:["RootElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"operations",type:"Operation",isMany:!0},{name:"implementationRef",type:"String",isAttr:!0}]},{name:"Operation",superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"inMessageRef",type:"Message",isReference:!0},{name:"outMessageRef",type:"Message",isReference:!0},{name:"errorRef",type:"Error",isMany:!0,isReference:!0},{name:"implementationRef",type:"String",isAttr:!0}]},{name:"EndPoint",superClass:["RootElement"]},{name:"Auditing",superClass:["BaseElement"]},{name:"GlobalTask",superClass:["CallableElement"],properties:[{name:"resources",type:"ResourceRole",isMany:!0}]},{name:"Monitoring",superClass:["BaseElement"]},{name:"Performer",superClass:["ResourceRole"]},{name:"Process",superClass:["FlowElementsContainer","CallableElement"],properties:[{name:"processType",type:"ProcessType",isAttr:!0},{name:"isClosed",isAttr:!0,type:"Boolean"},{name:"auditing",type:"Auditing"},{name:"monitoring",type:"Monitoring"},{name:"properties",type:"Property",isMany:!0},{name:"laneSets",type:"LaneSet",isMany:!0,replaces:"FlowElementsContainer#laneSets"},{name:"flowElements",type:"FlowElement",isMany:!0,replaces:"FlowElementsContainer#flowElements"},{name:"artifacts",type:"Artifact",isMany:!0},{name:"resources",type:"ResourceRole",isMany:!0},{name:"correlationSubscriptions",type:"CorrelationSubscription",isMany:!0},{name:"supports",type:"Process",isMany:!0,isReference:!0},{name:"definitionalCollaborationRef",type:"Collaboration",isAttr:!0,isReference:!0},{name:"isExecutable",isAttr:!0,type:"Boolean"}]},{name:"LaneSet",superClass:["BaseElement"],properties:[{name:"lanes",type:"Lane",isMany:!0},{name:"name",isAttr:!0,type:"String"}]},{name:"Lane",superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"partitionElementRef",type:"BaseElement",isAttr:!0,isReference:!0},{name:"partitionElement",type:"BaseElement"},{name:"flowNodeRef",type:"FlowNode",isMany:!0,isReference:!0},{name:"childLaneSet",type:"LaneSet",xml:{serialize:"xsi:type"}}]},{name:"GlobalManualTask",superClass:["GlobalTask"]},{name:"ManualTask",superClass:["Task"]},{name:"UserTask",superClass:["Task"],properties:[{name:"renderings",type:"Rendering",isMany:!0},{name:"implementation",isAttr:!0,type:"String"}]},{name:"Rendering",superClass:["BaseElement"]},{name:"HumanPerformer",superClass:["Performer"]},{name:"PotentialOwner",superClass:["HumanPerformer"]},{name:"GlobalUserTask",superClass:["GlobalTask"],properties:[{name:"implementation",isAttr:!0,type:"String"},{name:"renderings",type:"Rendering",isMany:!0}]},{name:"Gateway",isAbstract:!0,superClass:["FlowNode"],properties:[{name:"gatewayDirection",type:"GatewayDirection",default:"Unspecified",isAttr:!0}]},{name:"EventBasedGateway",superClass:["Gateway"],properties:[{name:"instantiate",default:!1,isAttr:!0,type:"Boolean"},{name:"eventGatewayType",type:"EventBasedGatewayType",isAttr:!0,default:"Exclusive"}]},{name:"ComplexGateway",superClass:["Gateway"],properties:[{name:"activationCondition",type:"Expression",xml:{serialize:"xsi:type"}},{name:"default",type:"SequenceFlow",isAttr:!0,isReference:!0}]},{name:"ExclusiveGateway",superClass:["Gateway"],properties:[{name:"default",type:"SequenceFlow",isAttr:!0,isReference:!0}]},{name:"InclusiveGateway",superClass:["Gateway"],properties:[{name:"default",type:"SequenceFlow",isAttr:!0,isReference:!0}]},{name:"ParallelGateway",superClass:["Gateway"]},{name:"RootElement",isAbstract:!0,superClass:["BaseElement"]},{name:"Relationship",superClass:["BaseElement"],properties:[{name:"type",isAttr:!0,type:"String"},{name:"direction",type:"RelationshipDirection",isAttr:!0},{name:"source",isMany:!0,isReference:!0,type:"Element"},{name:"target",isMany:!0,isReference:!0,type:"Element"}]},{name:"BaseElement",isAbstract:!0,properties:[{name:"id",isAttr:!0,type:"String",isId:!0},{name:"documentation",type:"Documentation",isMany:!0},{name:"extensionDefinitions",type:"ExtensionDefinition",isMany:!0,isReference:!0},{name:"extensionElements",type:"ExtensionElements"}]},{name:"Extension",properties:[{name:"mustUnderstand",default:!1,isAttr:!0,type:"Boolean"},{name:"definition",type:"ExtensionDefinition",isAttr:!0,isReference:!0}]},{name:"ExtensionDefinition",properties:[{name:"name",isAttr:!0,type:"String"},{name:"extensionAttributeDefinitions",type:"ExtensionAttributeDefinition",isMany:!0}]},{name:"ExtensionAttributeDefinition",properties:[{name:"name",isAttr:!0,type:"String"},{name:"type",isAttr:!0,type:"String"},{name:"isReference",default:!1,isAttr:!0,type:"Boolean"},{name:"extensionDefinition",type:"ExtensionDefinition",isAttr:!0,isReference:!0}]},{name:"ExtensionElements",properties:[{name:"valueRef",isAttr:!0,isReference:!0,type:"Element"},{name:"values",type:"Element",isMany:!0},{name:"extensionAttributeDefinition",type:"ExtensionAttributeDefinition",isAttr:!0,isReference:!0}]},{name:"Documentation",superClass:["BaseElement"],properties:[{name:"text",type:"String",isBody:!0},{name:"textFormat",default:"text/plain",isAttr:!0,type:"String"}]},{name:"Event",isAbstract:!0,superClass:["FlowNode","InteractionNode"],properties:[{name:"properties",type:"Property",isMany:!0}]},{name:"IntermediateCatchEvent",superClass:["CatchEvent"]},{name:"IntermediateThrowEvent",superClass:["ThrowEvent"]},{name:"EndEvent",superClass:["ThrowEvent"]},{name:"StartEvent",superClass:["CatchEvent"],properties:[{name:"isInterrupting",default:!0,isAttr:!0,type:"Boolean"}]},{name:"ThrowEvent",isAbstract:!0,superClass:["Event"],properties:[{name:"dataInputs",type:"DataInput",isMany:!0},{name:"dataInputAssociations",type:"DataInputAssociation",isMany:!0},{name:"inputSet",type:"InputSet"},{name:"eventDefinitions",type:"EventDefinition",isMany:!0},{name:"eventDefinitionRef",type:"EventDefinition",isMany:!0,isReference:!0}]},{name:"CatchEvent",isAbstract:!0,superClass:["Event"],properties:[{name:"parallelMultiple",isAttr:!0,type:"Boolean",default:!1},{name:"dataOutputs",type:"DataOutput",isMany:!0},{name:"dataOutputAssociations",type:"DataOutputAssociation",isMany:!0},{name:"outputSet",type:"OutputSet"},{name:"eventDefinitions",type:"EventDefinition",isMany:!0},{name:"eventDefinitionRef",type:"EventDefinition",isMany:!0,isReference:!0}]},{name:"BoundaryEvent",superClass:["CatchEvent"],properties:[{name:"cancelActivity",default:!0,isAttr:!0,type:"Boolean"},{name:"attachedToRef",type:"Activity",isAttr:!0,isReference:!0}]},{name:"EventDefinition",isAbstract:!0,superClass:["RootElement"]},{name:"CancelEventDefinition",superClass:["EventDefinition"]},{name:"ErrorEventDefinition",superClass:["EventDefinition"],properties:[{name:"errorRef",type:"Error",isAttr:!0,isReference:!0}]},{name:"TerminateEventDefinition",superClass:["EventDefinition"]},{name:"EscalationEventDefinition",superClass:["EventDefinition"],properties:[{name:"escalationRef",type:"Escalation",isAttr:!0,isReference:!0}]},{name:"Escalation",properties:[{name:"structureRef",type:"ItemDefinition",isAttr:!0,isReference:!0},{name:"name",isAttr:!0,type:"String"},{name:"escalationCode",isAttr:!0,type:"String"}],superClass:["RootElement"]},{name:"CompensateEventDefinition",superClass:["EventDefinition"],properties:[{name:"waitForCompletion",isAttr:!0,type:"Boolean",default:!0},{name:"activityRef",type:"Activity",isAttr:!0,isReference:!0}]},{name:"TimerEventDefinition",superClass:["EventDefinition"],properties:[{name:"timeDate",type:"Expression",xml:{serialize:"xsi:type"}},{name:"timeCycle",type:"Expression",xml:{serialize:"xsi:type"}},{name:"timeDuration",type:"Expression",xml:{serialize:"xsi:type"}}]},{name:"LinkEventDefinition",superClass:["EventDefinition"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"target",type:"LinkEventDefinition",isAttr:!0,isReference:!0},{name:"source",type:"LinkEventDefinition",isMany:!0,isReference:!0}]},{name:"MessageEventDefinition",superClass:["EventDefinition"],properties:[{name:"messageRef",type:"Message",isAttr:!0,isReference:!0},{name:"operationRef",type:"Operation",isAttr:!0,isReference:!0}]},{name:"ConditionalEventDefinition",superClass:["EventDefinition"],properties:[{name:"condition",type:"Expression",xml:{serialize:"xsi:type"}}]},{name:"SignalEventDefinition",superClass:["EventDefinition"],properties:[{name:"signalRef",type:"Signal",isAttr:!0,isReference:!0}]},{name:"Signal",superClass:["RootElement"],properties:[{name:"structureRef",type:"ItemDefinition",isAttr:!0,isReference:!0},{name:"name",isAttr:!0,type:"String"}]},{name:"ImplicitThrowEvent",superClass:["ThrowEvent"]},{name:"DataState",superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"}]},{name:"ItemAwareElement",superClass:["BaseElement"],properties:[{name:"itemSubjectRef",type:"ItemDefinition",isAttr:!0,isReference:!0},{name:"dataState",type:"DataState"}]},{name:"DataAssociation",superClass:["BaseElement"],properties:[{name:"assignment",type:"Assignment",isMany:!0},{name:"sourceRef",type:"ItemAwareElement",isMany:!0,isReference:!0},{name:"targetRef",type:"ItemAwareElement",isReference:!0},{name:"transformation",type:"FormalExpression",xml:{serialize:"property"}}]},{name:"DataInput",superClass:["ItemAwareElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"isCollection",default:!1,isAttr:!0,type:"Boolean"},{name:"inputSetRef",type:"InputSet",isVirtual:!0,isMany:!0,isReference:!0},{name:"inputSetWithOptional",type:"InputSet",isVirtual:!0,isMany:!0,isReference:!0},{name:"inputSetWithWhileExecuting",type:"InputSet",isVirtual:!0,isMany:!0,isReference:!0}]},{name:"DataOutput",superClass:["ItemAwareElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"isCollection",default:!1,isAttr:!0,type:"Boolean"},{name:"outputSetRef",type:"OutputSet",isVirtual:!0,isMany:!0,isReference:!0},{name:"outputSetWithOptional",type:"OutputSet",isVirtual:!0,isMany:!0,isReference:!0},{name:"outputSetWithWhileExecuting",type:"OutputSet",isVirtual:!0,isMany:!0,isReference:!0}]},{name:"InputSet",superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"dataInputRefs",type:"DataInput",isMany:!0,isReference:!0},{name:"optionalInputRefs",type:"DataInput",isMany:!0,isReference:!0},{name:"whileExecutingInputRefs",type:"DataInput",isMany:!0,isReference:!0},{name:"outputSetRefs",type:"OutputSet",isMany:!0,isReference:!0}]},{name:"OutputSet",superClass:["BaseElement"],properties:[{name:"dataOutputRefs",type:"DataOutput",isMany:!0,isReference:!0},{name:"name",isAttr:!0,type:"String"},{name:"inputSetRefs",type:"InputSet",isMany:!0,isReference:!0},{name:"optionalOutputRefs",type:"DataOutput",isMany:!0,isReference:!0},{name:"whileExecutingOutputRefs",type:"DataOutput",isMany:!0,isReference:!0}]},{name:"Property",superClass:["ItemAwareElement"],properties:[{name:"name",isAttr:!0,type:"String"}]},{name:"DataInputAssociation",superClass:["DataAssociation"]},{name:"DataOutputAssociation",superClass:["DataAssociation"]},{name:"InputOutputSpecification",superClass:["BaseElement"],properties:[{name:"dataInputs",type:"DataInput",isMany:!0},{name:"dataOutputs",type:"DataOutput",isMany:!0},{name:"inputSets",type:"InputSet",isMany:!0},{name:"outputSets",type:"OutputSet",isMany:!0}]},{name:"DataObject",superClass:["FlowElement","ItemAwareElement"],properties:[{name:"isCollection",default:!1,isAttr:!0,type:"Boolean"}]},{name:"InputOutputBinding",properties:[{name:"inputDataRef",type:"InputSet",isAttr:!0,isReference:!0},{name:"outputDataRef",type:"OutputSet",isAttr:!0,isReference:!0},{name:"operationRef",type:"Operation",isAttr:!0,isReference:!0}]},{name:"Assignment",superClass:["BaseElement"],properties:[{name:"from",type:"Expression",xml:{serialize:"xsi:type"}},{name:"to",type:"Expression",xml:{serialize:"xsi:type"}}]},{name:"DataStore",superClass:["RootElement","ItemAwareElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"capacity",isAttr:!0,type:"Integer"},{name:"isUnlimited",default:!0,isAttr:!0,type:"Boolean"}]},{name:"DataStoreReference",superClass:["ItemAwareElement","FlowElement"],properties:[{name:"dataStoreRef",type:"DataStore",isAttr:!0,isReference:!0}]},{name:"DataObjectReference",superClass:["ItemAwareElement","FlowElement"],properties:[{name:"dataObjectRef",type:"DataObject",isAttr:!0,isReference:!0}]},{name:"ConversationLink",superClass:["BaseElement"],properties:[{name:"sourceRef",type:"InteractionNode",isAttr:!0,isReference:!0},{name:"targetRef",type:"InteractionNode",isAttr:!0,isReference:!0},{name:"name",isAttr:!0,type:"String"}]},{name:"ConversationAssociation",superClass:["BaseElement"],properties:[{name:"innerConversationNodeRef",type:"ConversationNode",isAttr:!0,isReference:!0},{name:"outerConversationNodeRef",type:"ConversationNode",isAttr:!0,isReference:!0}]},{name:"CallConversation",superClass:["ConversationNode"],properties:[{name:"calledCollaborationRef",type:"Collaboration",isAttr:!0,isReference:!0},{name:"participantAssociations",type:"ParticipantAssociation",isMany:!0}]},{name:"Conversation",superClass:["ConversationNode"]},{name:"SubConversation",superClass:["ConversationNode"],properties:[{name:"conversationNodes",type:"ConversationNode",isMany:!0}]},{name:"ConversationNode",isAbstract:!0,superClass:["InteractionNode","BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"participantRef",type:"Participant",isMany:!0,isReference:!0},{name:"messageFlowRefs",type:"MessageFlow",isMany:!0,isReference:!0},{name:"correlationKeys",type:"CorrelationKey",isMany:!0}]},{name:"GlobalConversation",superClass:["Collaboration"]},{name:"PartnerEntity",superClass:["RootElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"participantRef",type:"Participant",isMany:!0,isReference:!0}]},{name:"PartnerRole",superClass:["RootElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"participantRef",type:"Participant",isMany:!0,isReference:!0}]},{name:"CorrelationProperty",superClass:["RootElement"],properties:[{name:"correlationPropertyRetrievalExpression",type:"CorrelationPropertyRetrievalExpression",isMany:!0},{name:"name",isAttr:!0,type:"String"},{name:"type",type:"ItemDefinition",isAttr:!0,isReference:!0}]},{name:"Error",superClass:["RootElement"],properties:[{name:"structureRef",type:"ItemDefinition",isAttr:!0,isReference:!0},{name:"name",isAttr:!0,type:"String"},{name:"errorCode",isAttr:!0,type:"String"}]},{name:"CorrelationKey",superClass:["BaseElement"],properties:[{name:"correlationPropertyRef",type:"CorrelationProperty",isMany:!0,isReference:!0},{name:"name",isAttr:!0,type:"String"}]},{name:"Expression",superClass:["BaseElement"],isAbstract:!1,properties:[{name:"body",type:"String",isBody:!0}]},{name:"FormalExpression",superClass:["Expression"],properties:[{name:"language",isAttr:!0,type:"String"},{name:"evaluatesToTypeRef",type:"ItemDefinition",isAttr:!0,isReference:!0}]},{name:"Message",superClass:["RootElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"itemRef",type:"ItemDefinition",isAttr:!0,isReference:!0}]},{name:"ItemDefinition",superClass:["RootElement"],properties:[{name:"itemKind",type:"ItemKind",isAttr:!0},{name:"structureRef",type:"String",isAttr:!0},{name:"isCollection",default:!1,isAttr:!0,type:"Boolean"},{name:"import",type:"Import",isAttr:!0,isReference:!0}]},{name:"FlowElement",isAbstract:!0,superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"auditing",type:"Auditing"},{name:"monitoring",type:"Monitoring"},{name:"categoryValueRef",type:"CategoryValue",isMany:!0,isReference:!0}]},{name:"SequenceFlow",superClass:["FlowElement"],properties:[{name:"isImmediate",isAttr:!0,type:"Boolean"},{name:"conditionExpression",type:"Expression",xml:{serialize:"xsi:type"}},{name:"sourceRef",type:"FlowNode",isAttr:!0,isReference:!0},{name:"targetRef",type:"FlowNode",isAttr:!0,isReference:!0}]},{name:"FlowElementsContainer",isAbstract:!0,superClass:["BaseElement"],properties:[{name:"laneSets",type:"LaneSet",isMany:!0},{name:"flowElements",type:"FlowElement",isMany:!0}]},{name:"CallableElement",isAbstract:!0,superClass:["RootElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"ioSpecification",type:"InputOutputSpecification",xml:{serialize:"property"}},{name:"supportedInterfaceRef",type:"Interface",isMany:!0,isReference:!0},{name:"ioBinding",type:"InputOutputBinding",isMany:!0,xml:{serialize:"property"}}]},{name:"FlowNode",isAbstract:!0,superClass:["FlowElement"],properties:[{name:"incoming",type:"SequenceFlow",isMany:!0,isReference:!0},{name:"outgoing",type:"SequenceFlow",isMany:!0,isReference:!0},{name:"lanes",type:"Lane",isVirtual:!0,isMany:!0,isReference:!0}]},{name:"CorrelationPropertyRetrievalExpression",superClass:["BaseElement"],properties:[{name:"messagePath",type:"FormalExpression"},{name:"messageRef",type:"Message",isAttr:!0,isReference:!0}]},{name:"CorrelationPropertyBinding",superClass:["BaseElement"],properties:[{name:"dataPath",type:"FormalExpression"},{name:"correlationPropertyRef",type:"CorrelationProperty",isAttr:!0,isReference:!0}]},{name:"Resource",superClass:["RootElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"resourceParameters",type:"ResourceParameter",isMany:!0}]},{name:"ResourceParameter",superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"isRequired",isAttr:!0,type:"Boolean"},{name:"type",type:"ItemDefinition",isAttr:!0,isReference:!0}]},{name:"CorrelationSubscription",superClass:["BaseElement"],properties:[{name:"correlationKeyRef",type:"CorrelationKey",isAttr:!0,isReference:!0},{name:"correlationPropertyBinding",type:"CorrelationPropertyBinding",isMany:!0}]},{name:"MessageFlow",superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"sourceRef",type:"InteractionNode",isAttr:!0,isReference:!0},{name:"targetRef",type:"InteractionNode",isAttr:!0,isReference:!0},{name:"messageRef",type:"Message",isAttr:!0,isReference:!0}]},{name:"MessageFlowAssociation",superClass:["BaseElement"],properties:[{name:"innerMessageFlowRef",type:"MessageFlow",isAttr:!0,isReference:!0},{name:"outerMessageFlowRef",type:"MessageFlow",isAttr:!0,isReference:!0}]},{name:"InteractionNode",isAbstract:!0,properties:[{name:"incomingConversationLinks",type:"ConversationLink",isVirtual:!0,isMany:!0,isReference:!0},{name:"outgoingConversationLinks",type:"ConversationLink",isVirtual:!0,isMany:!0,isReference:!0}]},{name:"Participant",superClass:["InteractionNode","BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"interfaceRef",type:"Interface",isMany:!0,isReference:!0},{name:"participantMultiplicity",type:"ParticipantMultiplicity"},{name:"endPointRefs",type:"EndPoint",isMany:!0,isReference:!0},{name:"processRef",type:"Process",isAttr:!0,isReference:!0}]},{name:"ParticipantAssociation",superClass:["BaseElement"],properties:[{name:"innerParticipantRef",type:"Participant",isAttr:!0,isReference:!0},{name:"outerParticipantRef",type:"Participant",isAttr:!0,isReference:!0}]},{name:"ParticipantMultiplicity",properties:[{name:"minimum",default:0,isAttr:!0,type:"Integer"},{name:"maximum",default:1,isAttr:!0,type:"Integer"}],superClass:["BaseElement"]},{name:"Collaboration",superClass:["RootElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"isClosed",isAttr:!0,type:"Boolean"},{name:"participants",type:"Participant",isMany:!0},{name:"messageFlows",type:"MessageFlow",isMany:!0},{name:"artifacts",type:"Artifact",isMany:!0},{name:"conversations",type:"ConversationNode",isMany:!0},{name:"conversationAssociations",type:"ConversationAssociation"},{name:"participantAssociations",type:"ParticipantAssociation",isMany:!0},{name:"messageFlowAssociations",type:"MessageFlowAssociation",isMany:!0},{name:"correlationKeys",type:"CorrelationKey",isMany:!0},{name:"choreographyRef",type:"Choreography",isMany:!0,isReference:!0},{name:"conversationLinks",type:"ConversationLink",isMany:!0}]},{name:"ChoreographyActivity",isAbstract:!0,superClass:["FlowNode"],properties:[{name:"participantRef",type:"Participant",isMany:!0,isReference:!0},{name:"initiatingParticipantRef",type:"Participant",isAttr:!0,isReference:!0},{name:"correlationKeys",type:"CorrelationKey",isMany:!0},{name:"loopType",type:"ChoreographyLoopType",default:"None",isAttr:!0}]},{name:"CallChoreography",superClass:["ChoreographyActivity"],properties:[{name:"calledChoreographyRef",type:"Choreography",isAttr:!0,isReference:!0},{name:"participantAssociations",type:"ParticipantAssociation",isMany:!0}]},{name:"SubChoreography",superClass:["ChoreographyActivity","FlowElementsContainer"],properties:[{name:"artifacts",type:"Artifact",isMany:!0}]},{name:"ChoreographyTask",superClass:["ChoreographyActivity"],properties:[{name:"messageFlowRef",type:"MessageFlow",isMany:!0,isReference:!0}]},{name:"Choreography",superClass:["Collaboration","FlowElementsContainer"]},{name:"GlobalChoreographyTask",superClass:["Choreography"],properties:[{name:"initiatingParticipantRef",type:"Participant",isAttr:!0,isReference:!0}]},{name:"TextAnnotation",superClass:["Artifact"],properties:[{name:"text",type:"String"},{name:"textFormat",default:"text/plain",isAttr:!0,type:"String"}]},{name:"Group",superClass:["Artifact"],properties:[{name:"categoryValueRef",type:"CategoryValue",isAttr:!0,isReference:!0}]},{name:"Association",superClass:["Artifact"],properties:[{name:"associationDirection",type:"AssociationDirection",isAttr:!0},{name:"sourceRef",type:"BaseElement",isAttr:!0,isReference:!0},{name:"targetRef",type:"BaseElement",isAttr:!0,isReference:!0}]},{name:"Category",superClass:["RootElement"],properties:[{name:"categoryValue",type:"CategoryValue",isMany:!0},{name:"name",isAttr:!0,type:"String"}]},{name:"Artifact",isAbstract:!0,superClass:["BaseElement"]},{name:"CategoryValue",superClass:["BaseElement"],properties:[{name:"categorizedFlowElements",type:"FlowElement",isVirtual:!0,isMany:!0,isReference:!0},{name:"value",isAttr:!0,type:"String"}]},{name:"Activity",isAbstract:!0,superClass:["FlowNode"],properties:[{name:"isForCompensation",default:!1,isAttr:!0,type:"Boolean"},{name:"default",type:"SequenceFlow",isAttr:!0,isReference:!0},{name:"ioSpecification",type:"InputOutputSpecification",xml:{serialize:"property"}},{name:"boundaryEventRefs",type:"BoundaryEvent",isMany:!0,isReference:!0},{name:"properties",type:"Property",isMany:!0},{name:"dataInputAssociations",type:"DataInputAssociation",isMany:!0},{name:"dataOutputAssociations",type:"DataOutputAssociation",isMany:!0},{name:"startQuantity",default:1,isAttr:!0,type:"Integer"},{name:"resources",type:"ResourceRole",isMany:!0},{name:"completionQuantity",default:1,isAttr:!0,type:"Integer"},{name:"loopCharacteristics",type:"LoopCharacteristics"}]},{name:"ServiceTask",superClass:["Task"],properties:[{name:"implementation",isAttr:!0,type:"String"},{name:"operationRef",type:"Operation",isAttr:!0,isReference:!0}]},{name:"SubProcess",superClass:["Activity","FlowElementsContainer","InteractionNode"],properties:[{name:"triggeredByEvent",default:!1,isAttr:!0,type:"Boolean"},{name:"artifacts",type:"Artifact",isMany:!0}]},{name:"LoopCharacteristics",isAbstract:!0,superClass:["BaseElement"]},{name:"MultiInstanceLoopCharacteristics",superClass:["LoopCharacteristics"],properties:[{name:"isSequential",default:!1,isAttr:!0,type:"Boolean"},{name:"behavior",type:"MultiInstanceBehavior",default:"All",isAttr:!0},{name:"loopCardinality",type:"Expression",xml:{serialize:"xsi:type"}},{name:"loopDataInputRef",type:"ItemAwareElement",isReference:!0},{name:"loopDataOutputRef",type:"ItemAwareElement",isReference:!0},{name:"inputDataItem",type:"DataInput",xml:{serialize:"property"}},{name:"outputDataItem",type:"DataOutput",xml:{serialize:"property"}},{name:"complexBehaviorDefinition",type:"ComplexBehaviorDefinition",isMany:!0},{name:"completionCondition",type:"Expression",xml:{serialize:"xsi:type"}},{name:"oneBehaviorEventRef",type:"EventDefinition",isAttr:!0,isReference:!0},{name:"noneBehaviorEventRef",type:"EventDefinition",isAttr:!0,isReference:!0}]},{name:"StandardLoopCharacteristics",superClass:["LoopCharacteristics"],properties:[{name:"testBefore",default:!1,isAttr:!0,type:"Boolean"},{name:"loopCondition",type:"Expression",xml:{serialize:"xsi:type"}},{name:"loopMaximum",type:"Integer",isAttr:!0}]},{name:"CallActivity",superClass:["Activity"],properties:[{name:"calledElement",type:"String",isAttr:!0}]},{name:"Task",superClass:["Activity","InteractionNode"]},{name:"SendTask",superClass:["Task"],properties:[{name:"implementation",isAttr:!0,type:"String"},{name:"operationRef",type:"Operation",isAttr:!0,isReference:!0},{name:"messageRef",type:"Message",isAttr:!0,isReference:!0}]},{name:"ReceiveTask",superClass:["Task"],properties:[{name:"implementation",isAttr:!0,type:"String"},{name:"instantiate",default:!1,isAttr:!0,type:"Boolean"},{name:"operationRef",type:"Operation",isAttr:!0,isReference:!0},{name:"messageRef",type:"Message",isAttr:!0,isReference:!0}]},{name:"ScriptTask",superClass:["Task"],properties:[{name:"scriptFormat",isAttr:!0,type:"String"},{name:"script",type:"String"}]},{name:"BusinessRuleTask",superClass:["Task"],properties:[{name:"implementation",isAttr:!0,type:"String"}]},{name:"AdHocSubProcess",superClass:["SubProcess"],properties:[{name:"completionCondition",type:"Expression",xml:{serialize:"xsi:type"}},{name:"ordering",type:"AdHocOrdering",isAttr:!0},{name:"cancelRemainingInstances",default:!0,isAttr:!0,type:"Boolean"}]},{name:"Transaction",superClass:["SubProcess"],properties:[{name:"protocol",isAttr:!0,type:"String"},{name:"method",isAttr:!0,type:"String"}]},{name:"GlobalScriptTask",superClass:["GlobalTask"],properties:[{name:"scriptLanguage",isAttr:!0,type:"String"},{name:"script",isAttr:!0,type:"String"}]},{name:"GlobalBusinessRuleTask",superClass:["GlobalTask"],properties:[{name:"implementation",isAttr:!0,type:"String"}]},{name:"ComplexBehaviorDefinition",superClass:["BaseElement"],properties:[{name:"condition",type:"FormalExpression"},{name:"event",type:"ImplicitThrowEvent"}]},{name:"ResourceRole",superClass:["BaseElement"],properties:[{name:"resourceRef",type:"Resource",isReference:!0},{name:"resourceParameterBindings",type:"ResourceParameterBinding",isMany:!0},{name:"resourceAssignmentExpression",type:"ResourceAssignmentExpression"},{name:"name",isAttr:!0,type:"String"}]},{name:"ResourceParameterBinding",properties:[{name:"expression",type:"Expression",xml:{serialize:"xsi:type"}},{name:"parameterRef",type:"ResourceParameter",isAttr:!0,isReference:!0}],superClass:["BaseElement"]},{name:"ResourceAssignmentExpression",properties:[{name:"expression",type:"Expression",xml:{serialize:"xsi:type"}}],superClass:["BaseElement"]},{name:"Import",properties:[{name:"importType",isAttr:!0,type:"String"},{name:"location",isAttr:!0,type:"String"},{name:"namespace",isAttr:!0,type:"String"}]},{name:"Definitions",superClass:["BaseElement"],properties:[{name:"name",isAttr:!0,type:"String"},{name:"targetNamespace",isAttr:!0,type:"String"},{name:"expressionLanguage",default:"http://www.w3.org/1999/XPath",isAttr:!0,type:"String"},{name:"typeLanguage",default:"http://www.w3.org/2001/XMLSchema",isAttr:!0,type:"String"},{name:"imports",type:"Import",isMany:!0},{name:"extensions",type:"Extension",isMany:!0},{name:"rootElements",type:"RootElement",isMany:!0},{name:"diagrams",isMany:!0,type:"bpmndi:BPMNDiagram"},{name:"exporter",isAttr:!0,type:"String"},{name:"relationships",type:"Relationship",isMany:!0},{name:"exporterVersion",isAttr:!0,type:"String"}]}],enumerations:[{name:"ProcessType",literalValues:[{name:"None"},{name:"Public"},{name:"Private"}]},{name:"GatewayDirection",literalValues:[{name:"Unspecified"},{name:"Converging"},{name:"Diverging"},{name:"Mixed"}]},{name:"EventBasedGatewayType",literalValues:[{name:"Parallel"},{name:"Exclusive"}]},{name:"RelationshipDirection",literalValues:[{name:"None"},{name:"Forward"},{name:"Backward"},{name:"Both"}]},{name:"ItemKind",literalValues:[{name:"Physical"},{name:"Information"}]},{name:"ChoreographyLoopType",literalValues:[{name:"None"},{name:"Standard"},{name:"MultiInstanceSequential"},{name:"MultiInstanceParallel"}]},{name:"AssociationDirection",literalValues:[{name:"None"},{name:"One"},{name:"Both"}]},{name:"MultiInstanceBehavior",literalValues:[{name:"None"},{name:"One"},{name:"All"},{name:"Complex"}]},{name:"AdHocOrdering",literalValues:[{name:"Parallel"},{name:"Sequential"}]}],prefix:"bpmn",xml:{tagAlias:"lowerCase",typePrefix:"t"}},bpmndi:{name:"BPMNDI",uri:"http://www.omg.org/spec/BPMN/20100524/DI",types:[{name:"BPMNDiagram",properties:[{name:"plane",type:"BPMNPlane",redefines:"di:Diagram#rootElement"},{name:"labelStyle",type:"BPMNLabelStyle",isMany:!0}],superClass:["di:Diagram"]},{name:"BPMNPlane",properties:[{name:"bpmnElement",isAttr:!0,isReference:!0,type:"bpmn:BaseElement",redefines:"di:DiagramElement#modelElement"}],superClass:["di:Plane"]},{name:"BPMNShape",properties:[{name:"bpmnElement",isAttr:!0,isReference:!0,type:"bpmn:BaseElement",redefines:"di:DiagramElement#modelElement"},{name:"isHorizontal",isAttr:!0,type:"Boolean"},{name:"isExpanded",isAttr:!0,type:"Boolean"},{name:"isMarkerVisible",isAttr:!0,type:"Boolean"},{name:"label",type:"BPMNLabel"},{name:"isMessageVisible",isAttr:!0,type:"Boolean"},{name:"participantBandKind",type:"ParticipantBandKind",isAttr:!0},{name:"choreographyActivityShape",type:"BPMNShape",isAttr:!0,isReference:!0}],superClass:["di:LabeledShape"]},{name:"BPMNEdge",properties:[{name:"label",type:"BPMNLabel"},{name:"bpmnElement",isAttr:!0,isReference:!0,type:"bpmn:BaseElement",redefines:"di:DiagramElement#modelElement"},{name:"sourceElement",isAttr:!0,isReference:!0,type:"di:DiagramElement",redefines:"di:Edge#source"},{name:"targetElement",isAttr:!0,isReference:!0,type:"di:DiagramElement",redefines:"di:Edge#target"},{name:"messageVisibleKind",type:"MessageVisibleKind",isAttr:!0,default:"initiating"}],superClass:["di:LabeledEdge"]},{name:"BPMNLabel",properties:[{name:"labelStyle",type:"BPMNLabelStyle",isAttr:!0,isReference:!0,redefines:"di:DiagramElement#style"}],superClass:["di:Label"]},{name:"BPMNLabelStyle",properties:[{name:"font",type:"dc:Font"}],superClass:["di:Style"]}],enumerations:[{name:"ParticipantBandKind",literalValues:[{name:"top_initiating"},{name:"middle_initiating"},{name:"bottom_initiating"},{name:"top_non_initiating"},{name:"middle_non_initiating"},{name:"bottom_non_initiating"}]},{name:"MessageVisibleKind",literalValues:[{name:"initiating"},{name:"non_initiating"}]}],associations:[],prefix:"bpmndi"},dc:{name:"DC",uri:"http://www.omg.org/spec/DD/20100524/DC",types:[{name:"Boolean"},{name:"Integer"},{name:"Real"},{name:"String"},{name:"Font",properties:[{name:"name",type:"String",isAttr:!0},{name:"size",type:"Real",isAttr:!0},{name:"isBold",type:"Boolean",isAttr:!0},{name:"isItalic",type:"Boolean",isAttr:!0},{name:"isUnderline",type:"Boolean",isAttr:!0},{name:"isStrikeThrough",type:"Boolean",isAttr:!0}]},{name:"Point",properties:[{name:"x",type:"Real",default:"0",isAttr:!0},{name:"y",type:"Real",default:"0",isAttr:!0}]},{name:"Bounds",properties:[{name:"x",type:"Real",default:"0",isAttr:!0},{name:"y",type:"Real",default:"0",isAttr:!0},{name:"width",type:"Real",isAttr:!0},{name:"height",type:"Real",isAttr:!0}]}],prefix:"dc",associations:[]},di:{name:"DI",uri:"http://www.omg.org/spec/DD/20100524/DI",types:[{name:"DiagramElement",isAbstract:!0,properties:[{name:"id",type:"String",isAttr:!0,isId:!0},{name:"extension",type:"Extension"},{name:"owningDiagram",type:"Diagram",isReadOnly:!0,isVirtual:!0,isReference:!0},{name:"owningElement",type:"DiagramElement",isReadOnly:!0,isVirtual:!0,isReference:!0},{name:"modelElement",isReadOnly:!0,isVirtual:!0,isReference:!0,type:"Element"},{name:"style",type:"Style",isReadOnly:!0,isVirtual:!0,isReference:!0},{name:"ownedElement",type:"DiagramElement",isReadOnly:!0,isVirtual:!0,isMany:!0}]},{name:"Node",isAbstract:!0,superClass:["DiagramElement"]},{name:"Edge",isAbstract:!0,superClass:["DiagramElement"],properties:[{name:"source",type:"DiagramElement",isReadOnly:!0,isVirtual:!0,isReference:!0},{name:"target",type:"DiagramElement",isReadOnly:!0,isVirtual:!0,isReference:!0},{name:"waypoint",isUnique:!1,isMany:!0,type:"dc:Point",xml:{serialize:"xsi:type"}}]},{name:"Diagram",isAbstract:!0,properties:[{name:"id",type:"String",isAttr:!0,isId:!0},{name:"rootElement",type:"DiagramElement",isReadOnly:!0,isVirtual:!0},{name:"name",isAttr:!0,type:"String"},{name:"documentation",isAttr:!0,type:"String"},{name:"resolution",isAttr:!0,type:"Real"},{name:"ownedStyle",type:"Style",isReadOnly:!0,isVirtual:!0,isMany:!0}]},{name:"Shape",isAbstract:!0,superClass:["Node"],properties:[{name:"bounds",type:"dc:Bounds"}]},{name:"Plane",isAbstract:!0,superClass:["Node"],properties:[{name:"planeElement",type:"DiagramElement",subsettedProperty:"DiagramElement-ownedElement",isMany:!0}]},{name:"LabeledEdge",isAbstract:!0,superClass:["Edge"],properties:[{name:"ownedLabel",type:"Label",isReadOnly:!0,subsettedProperty:"DiagramElement-ownedElement",isVirtual:!0,isMany:!0}]},{name:"LabeledShape",isAbstract:!0,superClass:["Shape"],properties:[{name:"ownedLabel",type:"Label",isReadOnly:!0,subsettedProperty:"DiagramElement-ownedElement",isVirtual:!0,isMany:!0}]},{name:"Label",isAbstract:!0,superClass:["Node"],properties:[{name:"bounds",type:"dc:Bounds"}]},{name:"Style",isAbstract:!0,properties:[{name:"id",type:"String",isAttr:!0,isId:!0}]},{name:"Extension",properties:[{name:"values",type:"Element",isMany:!0}]}],associations:[],prefix:"di",xml:{tagAlias:"lowerCase"}},bioc:{name:"bpmn.io colors for BPMN",uri:"http://bpmn.io/schema/bpmn/biocolor/1.0",prefix:"bioc",types:[{name:"ColoredShape",extends:["bpmndi:BPMNShape"],properties:[{name:"stroke",isAttr:!0,type:"String"},{name:"fill",isAttr:!0,type:"String"}]},{name:"ColoredEdge",extends:["bpmndi:BPMNEdge"],properties:[{name:"stroke",isAttr:!0,type:"String"},{name:"fill",isAttr:!0,type:"String"}]}],enumerations:[],associations:[]}};function Fe(e,t){return new Be(b({},_e,e),t)}function Ne(e,t){return e(t={exports:{}},t.exports),t.exports}var qe=1e3,je=60*qe,Le=60*je,Qe=24*Le,Ve=7*Qe,ze=365.25*Qe,Ke=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*ze;case"weeks":case"week":case"w":return n*Ve;case"days":case"day":case"d":return n*Qe;case"hours":case"hour":case"hrs":case"hr":case"h":return n*Le;case"minutes":case"minute":case"mins":case"min":case"m":return n*je;case"seconds":case"second":case"secs":case"sec":case"s":return n*qe;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===n&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=Qe)return Ge(e,t,Qe,"day");if(t>=Le)return Ge(e,t,Le,"hour");if(t>=je)return Ge(e,t,je,"minute");if(t>=qe)return Ge(e,t,qe,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=Qe)return Math.round(e/Qe)+"d";if(t>=Le)return Math.round(e/Le)+"h";if(t>=je)return Math.round(e/je)+"m";if(t>=qe)return Math.round(e/qe)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function Ge(e,t,n,r){var i=t>=1.5*n;return Math.round(e/n)+" "+r+(i?"s":"")}var Ue=function(e){function t(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return n.colors[Math.abs(t)%n.colors.length]}function n(e){let o;function s(...e){if(!s.enabled)return;const t=s,r=Number(new Date),i=r-(o||r);t.diff=i,t.prev=o,t.curr=r,o=r,e[0]=n.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(r,i)=>{if("%%"===r)return r;a++;const o=n.formatters[i];if("function"==typeof o){const n=e[a];r=o.call(t,n),e.splice(a,1),a--}return r}),n.formatArgs.call(t,e),(t.log||n.log).apply(t,e)}return s.namespace=e,s.enabled=n.enabled(e),s.useColors=n.useColors(),s.color=t(e),s.destroy=r,s.extend=i,"function"==typeof n.init&&n.init(s),n.instances.push(s),s}function r(){const e=n.instances.indexOf(this);return-1!==e&&(n.instances.splice(e,1),!0)}function i(e,t){const r=n(this.namespace+(void 0===t?":":t)+e);return r.log=this.log,r}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return n.debug=n,n.default=n,n.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},n.disable=function(){const e=[...n.names.map(o),...n.skips.map(o).map(e=>"-"+e)].join(",");return n.enable(""),e},n.enable=function(e){let t;n.save(e),n.names=[],n.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),i=r.length;for(t=0;t<i;t++)r[t]&&("-"===(e=r[t].replace(/\*/g,".*?"))[0]?n.skips.push(new RegExp("^"+e.substr(1)+"$")):n.names.push(new RegExp("^"+e+"$")));for(t=0;t<n.instances.length;t++){const e=n.instances[t];e.enabled=n.enabled(e.namespace)}},n.enabled=function(e){if("*"===e[e.length-1])return!0;let t,r;for(t=0,r=n.skips.length;t<r;t++)if(n.skips[t].test(e))return!1;for(t=0,r=n.names.length;t<r;t++)if(n.names[t].test(e))return!0;return!1},n.humanize=Ke,Object.keys(e).forEach(t=>{n[t]=e[t]}),n.instances=[],n.names=[],n.skips=[],n.formatters={},n.selectColor=t,n.enable(n.load()),n},He=Ne((function(e,t){t.log=function(...e){return"object"==typeof console&&console.log&&console.log(...e)},t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let r=0,i=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(r++,"%c"===e&&(i=r))}),t.splice(i,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.exports=Ue(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}})),We=(He.log,He.formatArgs,He.save,He.load,He.useColors,He.storage,He.colors,(e,t)=>{t=t||process.argv;const n=e.startsWith("-")?"":1===e.length?"-":"--",r=t.indexOf(n+e),i=t.indexOf("--");return-1!==r&&(-1===i||r<i)});const Xe=process.env;let Je;function Ye(e){return function(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}(function(e){if(!1===Je)return 0;if(We("color=16m")||We("color=full")||We("color=truecolor"))return 3;if(We("color=256"))return 2;if(e&&!e.isTTY&&!0!==Je)return 0;const t=Je?1:0;if("win32"===process.platform){const e=r.release().split(".");return Number(process.versions.node.split(".")[0])>=8&&Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in Xe)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI"].some(e=>e in Xe)||"codeship"===Xe.CI_NAME?1:t;if("TEAMCITY_VERSION"in Xe)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(Xe.TEAMCITY_VERSION)?1:0;if("truecolor"===Xe.COLORTERM)return 3;if("TERM_PROGRAM"in Xe){const e=parseInt((Xe.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(Xe.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(Xe.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(Xe.TERM)?1:"COLORTERM"in Xe?1:(Xe.TERM,t)}(e))}We("no-color")||We("no-colors")||We("color=false")?Je=!1:(We("color")||We("colors")||We("color=true")||We("color=always"))&&(Je=!0),"FORCE_COLOR"in Xe&&(Je=0===Xe.FORCE_COLOR.length||0!==parseInt(Xe.FORCE_COLOR,10));var Ze={supportsColor:Ye,stdout:Ye(process.stdout),stderr:Ye(process.stderr)},et=Ne((function(e,r){r.init=function(e){e.inspectOpts={};const t=Object.keys(r.inspectOpts);for(let n=0;n<t.length;n++)e.inspectOpts[t[n]]=r.inspectOpts[t[n]]},r.log=function(...e){return process.stderr.write(n.format(...e)+"\n")},r.formatArgs=function(t){const{namespace:n,useColors:i}=this;if(i){const r=this.color,i="[3"+(r<8?r:"8;5;"+r),o=`  ${i};1m${n} [0m`;t[0]=o+t[0].split("\n").join("\n"+o),t.push(i+"m+"+e.exports.humanize(this.diff)+"[0m")}else t[0]=function(){if(r.inspectOpts.hideDate)return"";return(new Date).toISOString()+" "}()+n+" "+t[0]},r.save=function(e){e?process.env.DEBUG=e:delete process.env.DEBUG},r.load=function(){return process.env.DEBUG},r.useColors=function(){return"colors"in r.inspectOpts?Boolean(r.inspectOpts.colors):t.isatty(process.stderr.fd)},r.colors=[6,2,3,4,5,1];try{const e=Ze;e&&(e.stderr||e).level>=2&&(r.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch(e){}r.inspectOpts=Object.keys(process.env).filter(e=>/^debug_/i.test(e)).reduce((e,t)=>{const n=t.substring(6).toLowerCase().replace(/_([a-z])/g,(e,t)=>t.toUpperCase());let r=process.env[t];return r=!!/^(yes|on|true|enabled)$/i.test(r)||!/^(no|off|false|disabled)$/i.test(r)&&("null"===r?null:Number(r)),e[n]=r,e},{}),e.exports=Ue(r);const{formatters:i}=e.exports;i.o=function(e){return this.inspectOpts.colors=this.useColors,n.inspect(e,this.inspectOpts).replace(/\s*\n\s*/g," ")},i.O=function(e){return this.inspectOpts.colors=this.useColors,n.inspect(e,this.inspectOpts)}})),tt=(et.init,et.log,et.formatArgs,et.save,et.load,et.useColors,et.colors,et.inspectOpts,Ne((function(e){"undefined"==typeof process||"renderer"===process.type||!0===process.browser||process.__nwjs?e.exports=He:e.exports=et}))),nt=function(e){return{debug:tt("bpmn-engine:"+e),error:tt("bpmn-engine:error:"+e),warn:tt("bpmn-engine:warn:"+e)}};function rt(e,t){const{discardSequence:n,inbound:r,outbound:i,parent:o,sequence:s}=e,a={...e,...t};return o&&(a.parent=ot(o)),n&&(a.discardSequence=n.slice()),r&&(a.inbound=r.map(e=>rt(e))),i&&(a.outbound=i.map(e=>rt(e))),s&&(a.sequence=s.map(e=>rt(e))),a}function it(e,t){return{fields:{...e.fields},content:rt(e.content,t),properties:{...e.properties}}}function ot(e){const{path:t}=e,n={...e};return t?(n.path=t.map(e=>({...e})),n):n}function st(e,t){const{id:n,type:r,executionId:i}=t;if(!e)return{id:n,type:r,executionId:i};const o=ot(e),{id:s,type:a,executionId:c}=e;return o.id=n,o.executionId=i,o.type=r,(o.path=o.path||[]).unshift({id:s,type:a,executionId:c}),o}function at(e){if(!e)return;if(!e.path||!e.path.length)return;const t=ot(e),{id:n,executionId:r,type:i}=t.path.shift();return t.id=n,t.executionId=r,t.type=i,t.path=t.path.length?t.path:void 0,t}function ct(e,t){const{id:n,type:r,executionId:i}=t;if(!e)return{id:n,type:r,executionId:i};const o=ot(e);if(o.id===n)return i&&(o.executionId=i),o;const s=o.path=o.path||[];for(const e of s)if(e.id===n)return i&&(e.executionId=i),o;return s.push({id:n,type:r,executionId:i}),o}function ut(e,t,n){return ft("activity",e,t,n)}function pt(e,t,n){return ft("definition",e,t,n)}function lt(e,t,n){return ft("process",e,t,n)}function dt(e,t,n){return ft("flow",e,t,n)}function ft(e,t,n,r){if(!n)throw new Error("Api requires message");const i=it(n),o=i.content,s=o.executionId,a=t.owner;return r=r||t.owner.environment,{id:o.id,type:o.type,name:o.name,executionId:s,environment:r,fields:i.fields,content:o,messageProperties:i.properties,get owner(){return a},cancel(){c("cancel")},discard(){c("discard")},signal(e,t){c("signal",{message:e},t)},stop(){c("stop")},resolveExpression:e=>r.resolveExpression(e,i,t.owner),sendApiMessage:c,createMessage:u,getPostponed:function(...e){return a.getPostponed?a.getPostponed(...e):a.isSubProcess&&a.execution?a.execution.getPostponed(...e):[]}};function c(n,r,i={}){let o=`${e}.${n}`;s&&(o+=`.${s}`),t.publish("api",o,u(r),{...i,type:n})}function u(e={}){return{...o,...e}}}function mt(e,t){const{id:n,broker:r,logger:i,isSubProcess:o,Behaviour:s}=e,a=[];let c,u,p,l=!1;const d=r.assertQueue("execute-q",{durable:!0,autoDelete:!1}),f={get completed(){return l},get source(){return c},discard:function(){if(l)return;if(!u)return i.warn(`<${n}> is not executing`);x(u).discard()},execute:function(o){if(!o)throw new Error("Execution requires message");if(!o.content||!o.content.executionId)throw new Error("Execution requires execution id");const l=o.fields.redelivered;if(p=o.content.executionId,(u=it(o)).content={...u.content,executionId:p,state:"start",isRootScope:!0},l)return a.splice(0),i.debug(`<${p} (${n})> resume execution`),c||(c=s(e,t)),g(),r.publish("execution","execute.resume.execution",rt(u.content),{persistent:!1});i.debug(`<${p} (${n})> execute`),g(),c=s(e,t),r.publish("execution","execute.start",rt(u.content))},getApi:x,getPostponed:m,getState:function(){const e={completed:l};return c&&c.getState?{...e,...c.getState()}:e},recover:function(n){if(a.splice(0),!n)return f;"completed"in n&&(l=n.completed);(c=s(e,t)).recover&&c.recover(n);return f},stop:function(){if(!u)return;x(u).stop()}};return f;function m(){let e=a.map(e=>x(e));return o&&c?e=e.concat(c.getPostponed()):e}function g(){if(!l){if(r.bindQueue(d.name,"execution","execute.#",{priority:100}),d.assertConsumer(b,{exclusive:!0,prefetch:100,priority:100,consumerTag:"_activity-execute"}),l)return y();r.subscribeTmp("api",`activity.*.${p}`,h,{noAck:!0,consumerTag:"_activity-api-execution",priority:200})}}function y(){r.cancel("_activity-api-execution"),r.cancel("_activity-execute"),r.unbindQueue(d.name,"execution","execute.#")}function h(e,t){switch(t.properties.type){case"discard":d.queueMessage({routingKey:"execute.discard"},rt(u.content));break;case"stop":!function(e){const t=e&&e.content&&e.content.executionId;m().forEach(e=>{t!==e.content.executionId&&e.stop()}),r.cancel("_activity-execute"),r.cancel("_activity-api-execution")}(t)}}function b(e,t){const{fields:o={},content:s={},properties:p={}}=t,d=o.redelivered,{isRootScope:f,ignoreIfExecuting:g,keep:h,executionId:b,error:x}=s;if(d&&!1===p.persistent)return t.ack();switch(e){case"execute.resume.execution":if(!a.length)return r.publish("execution","execute.start",rt(u.content));break;case"execute.error":case"execute.discard":!function(){const e=v(t);if(!f&&!e)return;if(!x&&!f)return t.ack(),1===a.length&&a[0].content.isRootScope?r.publish("execution","execute.discard",{...a[0].content}):void 0;t.ack(!0),y();const n=m();a.splice(0),n.forEach(e=>e.discard()),E(x?"error":"discard",{...s})}();break;case"execute.cancel":case"execute.completed":if(d)return t.ack(),r.publish("execution",e,$().content);!function(){const e=v(t);if(!e)return;if(!f)return i.debug(`<${b} (${n})> completed sub execution`),h||t.ack(),1===a.length&&a[0].content.isRootScope&&!a[0].content.preventComplete?r.publish("execution","execute.completed",rt(a[0].content)):void 0;i.debug(`<${b} (${n})> completed execution`),l=!0,t.ack(!0),y();const o=m();a.splice(0),o.forEach(e=>e.discard()),E("completed",{...e.content,...t.content})}();break;case"execute.start":if(!w())return;return c.execute($());case"execute.outbound.take":if(d){t.ack();break}r.publish("execution","execution.outbound.take",rt(s),{type:"outbound"});break;default:if(!w())return;if(d)return c.execute($())}function w(){const e=a.findIndex(e=>e.content.executionId===b);let n;return e>-1?g?(t.ack(),!1):((n=a.splice(e,1,t)[0]).ack(),!0):(a.push(t),!0)}function $(){const e=it(t);return e.content.ignoreIfExecuting=void 0,e}function E(e,t){l=!0,r.publish("execution",`execution.${e}`,{...t,state:e},{type:e})}}function v(e){const{executionId:t}=e.content,n=a.findIndex(({content:e})=>e.executionId===t);if(-1===n)return;const[r]=a.splice(n,1);return r.ack(),r}function x(e){if(e||(e=u),c.getApi){const t=c.getApi(e);if(t)return t}const t=ut(r,e);return t.getExecuting=function(){return a.reduce((t,n)=>n.content.executionId===e.content.executionId?t:(t.push(x(n)),t),[])},t}}const gt=/[./\\#*:\s]/g;function yt(e){return e.replace(gt,"_")}function ht(e){return`${yt(e)}_${(Math.floor(899999999*Math.random())+1e8).toString(16)}`}function bt(){return(Math.floor(9889999*Math.random())+11e4).toString(16)}function vt(e){const t=e.length,n=e.indexOf("#"),r=e.indexOf("*");if(-1===n){if(-1===r)return{test:function(t){return t===e}}}else if(n===t-1&&-1===r)return function(){const t=e.replace("#","");return{test:function(e){return 0===e.indexOf(t)}}}();const i=e.replace(".","\\.").replace("*","[^.]+?").replace("#",".+?");return new RegExp(`^${i}$`)}function xt(e,t){return(t.options.priority||0)-(e.options.priority||0)}function wt(e={},t,n={},r){let i,o=!1;const s=n.messageId||`smq.mid-${bt()}`,a={...n,messageId:s},c=a.timestamp=n.timestamp||Date.now();let u;n.expiration&&(u=a.ttl=c+parseInt(n.expiration));const p={fields:{...e,consumerTag:void 0},content:t,properties:a,consume:function({consumerTag:e}={},t){o=!0,p.fields.consumerTag=e,i=t},ack:function(e){if(!o)return;f("ack",e)},nack:d,reject:function(e=!0){d(!1,e)}};return Object.defineProperty(p,"messageId",{get:()=>s}),Object.defineProperty(p,"ttl",{value:u}),Object.defineProperty(p,"consumerTag",{get:()=>p.fields.consumerTag,set:e=>{p.fields.consumerTag=e}}),Object.defineProperty(p,"pending",{get:()=>o}),p;function l(){o=!1}function d(e,t=!0){o&&f("nack",e,t)}function f(e,t,n){[i,r,l].forEach(r=>{r&&r(p,e,t,n)})}}function $t(e,t={},n){e||(e=`smq.qname-${bt()}`);const r=[],i=[];let o,s,a=0,c="maxLength"in(t={autoDelete:!0,...t})?t.maxLength:1/0;const u=t.messageTtl,{deadLetterExchange:p,deadLetterRoutingKey:l}=t,d={name:e,options:t,messages:r,ack:function(e,t){b(e,"ack",t)},ackAll:function(){x().forEach(e=>e.ack(!1))},assertConsumer:function(e,t={},n){if(!i.length)return m(e,t,n);for(const n of i)if(n.onMessage===e&&!(t.consumerTag&&t.consumerTag!==n.consumerTag||"exclusive"in t&&t.exclusive!==n.options.exclusive))return n;return m(e,t,n)},cancel:function(e){const t=i.findIndex(t=>t.consumerTag===e);if(-1===t)return;return w(i[t])},close:function(){i.splice(0).forEach(e=>e.cancel()),o=!1},consume:m,delete:A,dequeueMessage:function(e){if(e.pending)return h(e,!1,!1);e.consume({}),h(e,!1,!1)},dismiss:function(e){const t=i.find(t=>t.onMessage===e);if(!t)return;w(t)},get:g,getState:function(){return JSON.parse(JSON.stringify(d))},nack:h,nackAll:v,off:function(e,t){if(!n||!n.off)return;const r=`queue.${e}`;return n.off(r,t)},on:function(e,t){if(!n||!n.on)return;const r=`queue.${e}`;return n.on(r,t)},peek:function(e){const t=r[0];if(!t)return;if(!e)return t;if(!t.pending)return t;for(let e=1;e<r.length;e++)if(!r[e].pending)return r[e]},purge:function(){const e=r.filter(({pending:e})=>!e);a=0,e.forEach(E),r.length||$("depleted",d);return e.length},queueMessage:function(e,t,n,i){if(s)return;const o={...n};u&&(o.expiration=o.expiration||u);const c=wt(e,t,o,b),p=C();let l;switch(r.push(c),a++,p){case 0:l=function(){const e=g();if(!e)return;return e.nack(!1,!1),e===c}();case 1:$("saturated")}i&&i(c);return $("message",c),l?0:f()},recover:function(t){if(s=!1,!t)return f();let n;e=d.name=t.name,r.splice(0),i.length&&(i.forEach(e=>e.nackAll(!1)),n=!0);t.messages.forEach(({fields:e,content:t,properties:n})=>{if(!1===n.persistent)return;const i=wt({...e,redelivered:!0},t,n,b);r.push(i)}),a=r.length,i.forEach(e=>e.recover()),n&&f()},reject:function(e,t=!0){b(e,"nack",!1,t)},stop:function(){s=!0},unbindConsumer:w};return Object.defineProperty(d,"messageCount",{enumerable:!0,get:()=>r.length}),Object.defineProperty(d,"consumers",{get:()=>i.slice()}),Object.defineProperty(d,"consumerCount",{get:()=>i.length}),Object.defineProperty(d,"stopped",{get:()=>s}),Object.defineProperty(d,"exclusive",{get:()=>o}),Object.defineProperty(d,"maxLength",{set(e){c=t.maxLength=e},get:()=>c}),Object.defineProperty(d,"capacity",{get:C}),d;function f(){if(s)return;if(!a)return;if(!i.length)return;const e=i.filter(e=>e.ready);if(!e.length)return 0;let t=0;for(const n of e){const e=y(n.capacity,n.options);if(!e.length)return t;n.push(e),t+=e.length}return t}function m(t,r={},s){if(o&&i.length)throw new Error(`Queue ${e} is exclusively consumed by ${i[0].consumerTag}`);if(r.exclusive&&i.length)throw new Error(`Queue ${e} already has consumers and cannot be exclusively consumed`);const a=function(e,t,n={},r,i){if("function"!=typeof t)throw new Error("message callback is required and must be a function");(n={prefetch:1,priority:0,noAck:!1,...n}).consumerTag||(n.consumerTag=`smq.ctag-${bt()}`);let o,s=!0,a=!1;const c=$t(`${n.consumerTag}-q`,{maxLength:n.prefetch},{emit:function(e){switch(e){case"queue.saturated":s=!1;break;case"queue.depleted":case"queue.ready":s=!0}}}),u={queue:e,options:n,on:function(e,t){if(!i)return;const n=`consumer.${e}`;return i.on(n,t)},onMessage:t,ackAll:function(){c.messages.slice().forEach(e=>{e.content.ack(!1)})},cancel:function(e=!0){(function(e,t){if(!i)return;const n=`consumer.${e}`;i.emit(n,t)})("cancel",u),l(e)},nackAll:l,prefetch:function(e){n.prefetch=c.maxLength=e},push:function(e){e.forEach(e=>{c.queueMessage(e.fields,e,e.properties,p)}),o||function e(){if(a)return;o=!0;const i=c.get();if(!i)return void(o=!1);i.consume(n);const s=i.content;s.consume(n,(function(){i.nack(!1,!1)}));n.noAck&&i.content.ack();t(i.fields.routingKey,i.content,r);o=!1;return e()}()},recover:function(){a=!1},stop:function(){a=!0}};return Object.defineProperty(u,"consumerTag",{value:n.consumerTag}),Object.defineProperty(u,"messageCount",{get:()=>c.messageCount}),Object.defineProperty(u,"capacity",{get:()=>c.capacity}),Object.defineProperty(u,"queueName",{get:()=>e.name}),Object.defineProperty(u,"ready",{get:()=>s&&!a}),Object.defineProperty(u,"stopped",{get:()=>a}),u;function p(e){e.content.consume(n,(function(){c.dequeueMessage(e)}))}function l(e){c.messages.slice().forEach(t=>{t.content.nack(!1,e)})}}(d,t,r,s,{emit:function(e,...t){"consumer.cancel"===e&&w(a),$(e,...t)},on:function(...e){n&&n.on||n.on(...e)}});i.push(a),i.sort(xt),o=a.options.exclusive,$("consume",a);const c=y(a.capacity,a.options);return c.length&&a.push(c),a}function g({noAck:e,consumerTag:t}={}){const n=y(1,{noAck:e,consumerTag:t})[0];if(n)return e&&E(n),n}function y(e,t){if(s||!a||!e)return[];const n=Date.now(),i=[],o=[];for(const s of r)if(!s.pending)if(s.ttl&&s.ttl<n)o.push(s);else if(s.consume(t),a--,i.push(s),!--e)break;for(const e of o)h(e,!1,!1);return i}function h(e,t,n=!0){b(e,"nack",t,n)}function b(e,t,n,i){if(s)return;const o=n&&x(e);let c,u=!1;switch(t){case"ack":if(!E(e))return;break;case"nack":if(i){!function(e){const t=r.indexOf(e);if(-1===t)return;a++,r.splice(t,1,wt({...e.fields,redelivered:!0},e.content,e.properties,b))}(e);break}if(!E(e))return;u=!!p}if(r.length?1===(c=C())&&$("ready",c):$("depleted",d),o&&o.length||f(),u){const t=wt(e.fields,e.content,{...e.properties,expiration:void 0});l&&(t.fields.routingKey=l),$("dead-letter",{deadLetterExchange:p,message:t})}o&&o.length&&o.forEach(e=>e[t](!1,i))}function v(e=!0){x().forEach(t=>t.nack(!1,e))}function x(e){if(!e)return r.filter(e=>e.pending);const t=r.indexOf(e);return-1===t?[]:r.slice(0,t).filter(e=>e.pending)}function w(e){const n=i.indexOf(e);if(-1!==n){if(i.splice(n,1),o&&(o=!1),e.stop(),t.autoDelete&&!i.length)return A();e.nackAll(!0)}}function $(e,t){if(!n||!n.emit)return;const r=`queue.${e}`;n.emit(r,t)}function E(e){const t=r.indexOf(e);if(-1!==t)return r.splice(t,1),!0}function A({ifUnused:e,ifEmpty:t}={}){if(e&&i.length)return;if(t&&r.length)return;const n=r.length;return d.stop(),i.splice(0).forEach(e=>{e.cancel()}),p?v(!1):r.splice(0),$("delete",d),{messageCount:n}}function C(){return c-r.length}}function Et(e){return e||(e=`smq.ename-${bt()}`),At(e,!1,"topic",{durable:!1,autoDelete:!0})}function At(e,t,n="topic",r={},i){if(!e)throw new Error("Exchange name is required");if(-1===["topic","direct"].indexOf(n))throw Error("Exchange type must be one of topic or direct");const o=$t("delivery-q",{},{emit:function(){}});let s=o.consume("topic"===n?l:d);t||(i=void 0);const a=[];let c;r={durable:!0,autoDelete:!0,...r};const u={name:e,type:n,options:r,bind:y,close:function(){a.slice().forEach(e=>e.close()),o.unbindConsumer(s),o.close()},emit:b,getBinding:function(e,t){return a.find(n=>n.queue.name===e&&n.pattern===t)},getState:function(){return JSON.parse(JSON.stringify({name:e,type:n,options:{...r},deliveryQueue:o,bindings:a.reduce((e,t)=>t.queue.options.durable?(e||(e=[]),e.push(t),e):e,void 0)}))},on:function(e,n,r={}){if(t)return i.on(`exchange.${e}`,n);const o=$t(null,{durable:!1,autoDelete:!0});return y(o,e),o.consume(n,{...r,noAck:!0},u)},off:function(e,n){if(t)return i.off(`exchange.${e}`,n);for(const t of a)t.pattern===e&&t.queue.dismiss(n)},publish:p,recover:function(t,r){c=!1,function(){if(!t||!t.bindings)return;t.bindings.forEach(e=>{const t=r(e.queueName);t&&y(t,e.pattern,e.options)})}(),t&&(e=u.name=t.name,o.recover(t.deliveryQueue),s=o.consume("topic"===n?l:d));return u},stop:function(){c=!0},unbind:h,unbindQueueByName:function(e){a.filter(t=>t.queue.name===e).forEach(e=>{h(e.queue,e.pattern)})}};return Object.defineProperty(u,"bindingCount",{enumerable:!0,get:()=>a.length}),Object.defineProperty(u,"bindings",{enumerable:!0,get:()=>a.slice()}),Object.defineProperty(u,"stopped",{enumerable:!0,get:()=>c}),u;function p(e,t,n={}){if(!c)return o.queueMessage({routingKey:e},{content:t,properties:n})}function l(e,t){const n=g(e),r=t.content;if(!n.length)return t.ack(),r.properties.mandatory&&m(e,r),0;t.ack(),n.forEach(({queue:t})=>f(t,e,r.content,r.properties))}function d(e,t){const n=g(e),r=t.content,i=n[0];if(!i)return t.ack(),r.properties.mandatory&&m(e,r),0;n.length>1&&function(e){const t=a.indexOf(e);a.splice(t,1),a.push(e)}(n[0]),t.ack(),f(i.queue,e,r.content,r.properties)}function f(t,n,r,i){t.queueMessage({routingKey:n,exchange:e},r,i)}function m(t,n){b("return",wt({routingKey:t,exchange:e},n.content,n.properties))}function g(e){return a.reduce((t,n)=>(n.testPattern(e)&&t.push(n),t),[])}function y(e,t,n){const r=a.find(n=>n.queue===e&&n.pattern===t);if(r)return r;const i=function(e,t,n={}){const r=vt(t);e.on("delete",o);const i={id:`${e.name}/${t}`,options:{priority:0,...n},pattern:t,close:o,testPattern:function(e){return r.test(e)}};return Object.defineProperty(i,"queue",{enumerable:!1,value:e}),Object.defineProperty(i,"queueName",{enumerable:!0,get:()=>e.name}),i;function o(){h(e,t)}}(e,t,n);return a.push(i),a.sort(xt),b("bind",i),i}function h(e,t){const n=a.findIndex(n=>n.queue===e&&n.pattern===t);if(-1===n)return;const[i]=a.splice(n,1);i.close(),b("unbind",i),!a.length&&r.autoDelete&&b("delete",u)}function b(e,n){if(t)return i.publish(`exchange.${e}`,n);p(e,n)}}function Ct(e){const t=[],n=[],r=[],i=Et(),o={owner:e,subscribe:s,subscribeOnce:function(e,t,n,r={}){if("function"!=typeof n)throw new Error("message callback is required");r&&r.consumerTag&&h(r.consumerTag);a(e);const i={autoDelete:!0,durable:!1,priority:r.priority||0},o=m(null,i);return u(o.name,e,t,{...i}),p(o.name,(function(...e){o.delete(),n(...e)}),{noAck:!0,consumerTag:r.consumerTag})},subscribeTmp:function(e,t,n,r={}){return s(e,t,null,n,{...r,durable:!1})},unsubscribe:function(e,t){const n=g(e);if(!n)return;n.dismiss(t)},assertExchange:a,ack:function(e,t){e.ack(t)},ackAll:function(){for(const e of n)e.ackAll()},nack:function(e,t,n){e.nack(t,n)},nackAll:function(e){for(const t of n)t.nackAll(e)},cancel:function(e){const t=r.find(t=>t.consumerTag===e);return!!t&&(t.cancel(!1),!0)},close:f,deleteExchange:function(e,{ifUnused:n}={}){const r=t.findIndex(t=>t.name===e);if(-1===r)return!1;const i=t[r];return(!n||!i.bindingCount)&&(t.splice(r,1),i.close(),!0)},bindExchange:function(){},bindQueue:u,assertQueue:y,consume:p,createQueue:m,deleteQueue:function(e,t){if(!e)return!1;const n=g(e);return!!n&&n.delete(t)},get:function(e,{noAck:t}={}){const n=g(e);if(!n)return;return n.get({noAck:t})},getExchange:l,getQueue:g,getState:function(){return{exchanges:t.reduce((e,t)=>t.options.durable?(e||(e=[]),e.push(t.getState()),e):e,void 0),queues:n.reduce((e,t)=>t.options.durable?(e||(e=[]),e.push(t.getState()),e):e,void 0)}},on:function(e,t){switch(e){case"return":return i.on("return",(function(e,n){t(n.content.content)}),{origin:t})}},off:function(e,t){for(const n of i.bindings)if(n.pattern===e)for(const e of n.queue.consumers)e.options&&e.options.origin===t&&e.cancel()},prefetch:function(){},publish:function(e,t,n,r){const i=c(e);if(!i)return;return i.publish(t,n,r)},purgeQueue:function(e){const t=g(e);if(!t)return;return t.purge()},recover:function(e){if(e){if(e.queues)for(const t of e.queues)r(t);if(e.exchanges)for(const t of e.exchanges)i(t)}else{for(const e of n)e.stopped&&e.recover();for(const e of t)e.stopped&&e.recover(null,g)}return o;function r(e){y(e.name,e.options).recover(e)}function i(e){a(e.name,e.type,e.options).recover(e,g)}},reject:function(e,t){e.reject(t)},reset:function(){d(),f(),t.splice(0),n.splice(0),r.splice(0)},sendToQueue:function(e,t,n){const r=g(e);if(!r)throw new Error(`Queue named ${e} doesn't exists`);return r.queueMessage(null,t,n)},stop:d,unbindExchange:function(){},unbindQueue:function(e,t,n){const r=l(t);if(!r)return;const i=g(e);if(!i)return;r.unbind(i,n)}};return Object.defineProperty(o,"exchangeCount",{enumerable:!0,get:()=>t.length}),Object.defineProperty(o,"queueCount",{enumerable:!0,get:()=>n.length}),Object.defineProperty(o,"consumerCount",{enumerable:!0,get:()=>r.length}),o;function s(t,n,r,i,o={durable:!0}){if(!t||!n||"function"!=typeof i)throw new Error("exchange name, pattern, and message callback are required");o&&o.consumerTag&&h(o.consumerTag),a(t);const s=y(r,o);return u(s.name,t,n,o),s.assertConsumer(i,o,e)}function a(e,n,r){let o=c(e);if(o){if(n&&o.type!==n)throw new Error("Type doesn't match")}else(o=function(e,t,n){return At(e,!0,t,n,Et())}(e,n||"topic",r)).on("delete",()=>{const e=t.indexOf(o);-1!==e&&t.splice(e,1)}),o.on("return",(e,t)=>{i.publish("return",t)}),t.push(o);return o}function c(e){return t.find(t=>t.name===e)}function u(e,t,n,r){const i=l(t),o=g(e);i.bind(o,n,r)}function p(t,n,r){const i=g(t);if(!i)throw new Error(`Queue with name <${t}> was not found`);return r&&h(r.consumerTag),i.consume(n,r,e)}function l(e){return t.find(({name:t})=>t===e)}function d(){for(const e of t)e.stop();for(const e of n)e.stop()}function f(){for(const e of t)e.close();for(const e of n)e.close()}function m(e,t){if(g(e))throw new Error(`Queue named ${e} already exists`);const i=$t(e,t,Et());return i.on("delete",(function(){const e=n.indexOf(i);if(-1===e)return;n.splice(e,1)})),i.on("dead-letter",(function(e,{content:t}){const n=l(t.deadLetterExchange);if(!n)return;n.publish(t.message.fields.routingKey,t.message.content,t.message.properties)})),i.on("consume",(e,t)=>r.push(t.content)),i.on("consumer.cancel",(e,t)=>{const n=r.indexOf(t.content);-1!==n&&r.splice(n,1)}),n.push(i),i}function g(e){if(!e)return;const t=n.findIndex(t=>t.name===e);return t>-1?n[t]:void 0}function y(e,t={}){if(!e)return m(null,t);const n=g(e);if(t={durable:!0,...t},!n)return m(e,t);if(n.options.durable!==t.durable)throw new Error("Durable doesn't match");return n}function h(e){if(!e)return!0;if(r.find(t=>t.consumerTag===e))throw new Error(`Consumer tag must be unique, ${e} is occupied`);return!0}}class kt extends Error{constructor(e,t,n){super(e),this.type="ActivityError",this.name=this.constructor.name,this.description=e,t&&(this.source=it(t,t.content&&t.content.error&&{error:void 0})),n&&(this.inner=n,n.name&&(this.name=n.name),n.code&&(this.code=n.code))}}class It extends Error{constructor(e,t={},n,r){const{errorCode:i}=t;super(e),this.type="BpmnError",this.name=t.name||this.constructor.name,this.description=e,this.code="errorCode"in t&&i&&i.toString()||t.code,this.id=t.id,n&&(this.source=it(n,n.content&&n.content.error&&{error:void 0})),r&&(this.inner=r)}}function Rt(e){const{content:t}=e;if(r(t))return t;const{error:n}=t;if(n){if(r(n))return n;switch(n.type){case"ActivityError":return new kt(n.message||n.description,n.source,n.inner?n.inner:{code:n.code,name:n.name});case"BpmnError":return new It(n.message||n.description,n,n.source)}return n}function r(e){return e instanceof Error?e:e instanceof kt?e:e instanceof It?e:void 0}}function St(e,t,n){const r=Tt(e,{prefix:t,autoDelete:!1,durable:!1},n),i=r.broker;i.assertExchange("api","topic",{autoDelete:!1,durable:!1}),i.assertExchange("run","topic",{autoDelete:!1}),i.assertExchange("format","topic",{autoDelete:!1}),i.assertExchange("execution","topic",{autoDelete:!1});const o=i.assertQueue("run-q",{durable:!0,autoDelete:!1}),s=i.assertQueue("format-run-q",{durable:!0,autoDelete:!1}),a=i.assertQueue("execution-q",{durable:!0,autoDelete:!1});return i.bindQueue(o.name,"run","run.#"),i.bindQueue(s.name,"format","run.#"),i.bindQueue(a.name,"execution","execution.#"),r}function Tt(e,t,n){const r=Ct(e),i=t.prefix;return r.assertExchange("event","topic",t),r.on("return",n||function(e){if("error"===e.properties.type){throw Rt(e)}}),{eventPrefix:i,broker:r,on:o,once:function(e,t,n={}){return o(e,t,{...n,once:!0})},waitFor:function(e,t){const n=s(e);return new Promise((e,i)=>{const o=[r.subscribeTmp("event",n,(function(n,r,i){if(t&&!t(n,r,i))return;return s(),e(i.getApi(r))}),{noAck:!0}),r.subscribeTmp("event","*.error",(function(e,t,n){if(!t.properties.mandatory)return;return s(),i(Rt(t))}),{noAck:!0})];function s(){o.forEach(e=>e.cancel())}})},emit:a,emitFatal:function(e,t={}){a("error",{...t,error:e},{mandatory:!0})}};function o(e,t,n={once:!1}){const i=s(e);return n.once?r.subscribeOnce("event",i,o,n):r.subscribeTmp("event",i,o,{...n,noAck:!0});function o(n,r,i){if("error"===e)return t(Rt(r));t(i.getApi(r))}}function s(e){if(e.indexOf(".")>-1)return e;switch(e){case"wait":return`activity.${e}`;case"error":return`${i}.error`;default:return`${i}.${e}`}}function a(e,t={},n={}){r.publish("event",`${i}.${e}`,{...t},{type:e,...n})}}function Ot(e,t,n){const{id:r,type:i="activity",name:o,parent:s={},behaviour:a={},isParallelGateway:c,isSubProcess:u,triggeredByEvent:p,isThrowing:l}=t,d=a.isForCompensation,f=ot(s),{environment:m,getInboundSequenceFlows:g,getOutboundSequenceFlows:y,getInboundAssociations:h}=n,b=m.Logger(i.toLowerCase()),{step:v}=m.settings,{attachedTo:x,ioSpecification:w,eventDefinitions:$}=a;let E,A;x&&(A=x.id,E=n.getActivityById(x.id));const C=g(r)||[],k=y(r)||[],I=h(r)||[],R=0===C.length&&!A&&!p&&!d,S=0===k.length,T=C.length>1&&c,O=!!a.loopCharacteristics;let P,D,M,B,_,F,N,q=!1;const j=E?[E]:C.slice(),L=[];let Q={taken:0,discarded:0};const V={id:r,type:i,name:o,isEnd:S,isStart:R,isSubProcess:u,isThrowing:l,isForCompensation:d,triggeredByEvent:p,parent:ot(f),behaviour:{...a,eventDefinitions:$},attachedTo:E,environment:m,inbound:C,outbound:k,get counters(){return{...Q}},get executionId(){return M},get status(){return _},get stopped(){return q},get isRunning(){return!!N&&!!_},Behaviour:e,activate:se,deactivate:ae,logger:b,discard:function(e){if(!_)return oe(e);if(P&&!P.completed)return P.discard();le(),W.purge(),z.publish("run","run.discard",rt(B.content)),ce()},getApi:Ee,getActivityById:function(e){return n.getActivityById(e)},getState:function(){return{...ie(),status:_,executionId:M,stopped:q,behaviour:{...a},counters:{...Q},broker:z.getState(),execution:P&&P.getState()}},init:ne,recover:function(e){if(V.isRunning)throw new Error(`cannot recover running activity <${r}>`);if(!e)return;q=e.stopped,_=e.status,M=e.executionId,e.counters&&(Q={...Q,...e.counters});e.execution&&(P=mt(V,n).recover(e.execution));return z.recover(e.broker),V},resume:function(){if(N)throw new Error(`cannot resume running activity <${r}>`);if(!_)return se();q=!1,ue();const e=ie();z.publish("run","run.resume",e,{persistent:!1}),ce()},run:re,shake:function(){ve({content:ie()})},stop:function(){if(!V.isRunning)return;Ee().stop()},next:v&&function(){if(!v)return;if(!B)return;if("executing"===_)return!1;if("formatting"===_)return!1;const e=B;return B.ack(),e}},{broker:z,on:K,once:G,waitFor:U,emitFatal:H}=St(V,"activity");V.on=K,V.once=G,V.waitFor=U,V.emitFatal=H;const W=z.getQueue("run-q"),X=z.getQueue("execution-q"),J=z.getQueue("format-run-q"),Y=z.assertQueue("inbound-q",{durable:!0,autoDelete:!1});d?I.forEach(e=>{e.broker.subscribeTmp("event","#",de,{noAck:!0,consumerTag:`_inbound-${r}`})}):j.forEach(e=>{e.isSequenceFlow?e.broker.subscribeTmp("event","flow.#",de,{noAck:!0,consumerTag:`_inbound-${r}`}):e.broker.subscribeTmp("event","activity.#",de,{noAck:!0,consumerTag:`_inbound-${r}`})}),Object.defineProperty(V,"broker",{enumerable:!0,get:()=>z}),Object.defineProperty(V,"execution",{enumerable:!0,get:()=>P});const Z=w&&w.Behaviour(V,w,n),ee=$&&$.map(e=>e.Behaviour(V,e,n));Object.defineProperty(V,"eventDefinitions",{enumerable:!0,get:()=>ee});const te=n.loadExtensions(V);return Object.defineProperty(V,"extensions",{enumerable:!0,get:()=>te}),V;function ne(e){D=D||ht(r),b.debug(`<${r}> initialized with executionId <${D}>`),xe("init",ie({...e,executionId:D}))}function re(e){if(V.isRunning)throw new Error(`activity <${r}> is already running`);M=D||ht(r),D=void 0,ue();const t=ie({...e,executionId:M});z.publish("run","run.enter",t),z.publish("run","run.start",rt(t)),ce()}function ie(e={}){const t={...e,id:r,type:i,name:o,parent:ot(f)},n={isEnd:S,isStart:R,isSubProcess:u,isMultiInstance:O,isForCompensation:d,attachedTo:A};for(const e in n)n[e]&&(t[e]=n[e]);return t}function oe(e={}){M=D||ht(r),ue(),D=void 0;const t=ie({...e,executionId:M});z.publish("run","run.discard",t),ce()}function se(){if(!d)return pe()}function ae(){z.cancel("_run-on-inbound"),z.cancel("_format-consumer")}function ce(){N||(N=!0,W.assertConsumer(ge,{exclusive:!0,consumerTag:"_activity-run"}))}function ue(){M&&(z.cancel("_activity-api"),z.subscribeTmp("api",`activity.*.${M}`,be,{noAck:!0,consumerTag:"_activity-api",priority:100}))}function pe(){if(!_)return T?Y.consume(me,{consumerTag:"_run-on-inbound",prefetch:1e3}):Y.consume(fe,{consumerTag:"_run-on-inbound"})}function le(){z.cancel("_activity-api"),z.cancel("_activity-run"),z.cancel("_activity-execution"),N=!1}function de(e,t){const{fields:n,content:i,properties:o}=t;switch(e){case"activity.enter":case"activity.discard":i.id===E.id&&Y.queueMessage(n,rt(i),o);break;case"flow.shake":ve(t);break;case"association.take":case"flow.take":case"flow.discard":Y.queueMessage(n,rt(i),o);break;case"association.discard":b.debug(`<${r}> compensation discarded`),Y.purge();break;case"association.complete":{if(!d)break;Y.queueMessage(n,rt(i),o);const e=`${yt(r)}_${yt(i.sequenceId)}`;xe("compensation.start",ie({executionId:e,placeholder:!0})),b.debug(`<${r}> start compensation with id <${e}>`),pe();break}}}function fe(e,t){t.ack(),z.cancel("_run-on-inbound");const n=t.content,i=[rt(n)];switch(e){case"association.take":case"flow.take":case"activity.enter":re({message:n.message,inbound:i});break;case"flow.discard":case"activity.discard":{let e;n.discardSequence&&(e=n.discardSequence.slice()),oe({inbound:i,discardSequence:e});break}case"association.complete":{z.cancel("_run-on-inbound");const e=`${yt(r)}_${yt(n.sequenceId)}`;b.debug(`<${r}> completed compensation with id <${e}>`),xe("compensation.end",ie({executionId:e}));break}}}function me(e,t){const{content:n}=t,i=L.findIndex(e=>e.content.id===n.id);if(L.push(t),i>-1)return;if(!(L.length>=j.length)){const e=C.filter((e,t,n)=>n.indexOf(e)===t).length-L.length;return b.debug(`<${r}> inbound ${t.content.action} from <${t.content.id}>, ${e} remaining`),ne({inbound:L.map(e=>rt(e.content))})}const o=L.splice(0);let s;const a=o.map(e=>("flow.take"===e.fields.routingKey&&(s=!0),e.ack(),rt(e.content))),c=!s&&o.reduce((e,t)=>t.content.discardSequence?(t.content.discardSequence.forEach(t=>{-1===e.indexOf(t)&&e.push(t)}),e):e,[]);return z.cancel("_run-on-inbound"),s?re({inbound:a}):oe({inbound:a,discardSequence:c})}function ge(e,t,n){switch(e){case"run.next":return ye(e,t);case"run.resume":return function(){t.ack();const{fields:e}=B;switch(e.routingKey){case"run.enter":case"run.start":case"run.discarded":case"run.end":case"run.leave":break;default:return}if(!e.redelivered)return;return b.debug(`<${r}> resume from ${_}`),z.publish("run",e.routingKey,rt(B.content),B.properties)}()}return function(e,t,n){const i=e.get();if(!i)return n(null,t.content);const o=[],{fields:s,content:a}=t,c={id:a.id,type:a.type,parent:ot(a.parent),attachedTo:a.attachedTo,executionId:a.executionId,isSubProcess:a.isSubProcess,isMultiInstance:a.isMultiInstance};a.inbound&&(c.inbound=a.inbound.slice());a.outbound&&(c.outbound=a.outbound.slice());let u=rt(a);const p=e.on("depleted",()=>{o.length||(p.cancel(),b.debug(`<${r}> completed formatting ${s.routingKey}`),z.cancel("_format-consumer"),n(null,function(e){return Object.keys(e).reduce((t,n)=>{const r=e[n];return void 0!==r&&(t[n]=r),t},{})}(u)))});function l(e,t){if(t.content.endRoutingKey)return o.push(t),b.debug(`<${r}> start formatting ${s.routingKey} message content with formatter ${e}`);!function(e){for(let t=0;t<o.length;t++){const n=o[t];if(vt(n.content.endRoutingKey).test(e)){b.debug(`<${r}> completed formatting ${s.routingKey} message content with formatter ${e}`),o.splice(t,1),n.ack();break}}}(e),b.debug(`<${r}> format ${s.routingKey} message content`),u={...u,...t.content,...c},t.ack()}_="formatting",l(i.fields.routingKey,i),e.assertConsumer(l,{consumerTag:"_format-consumer",prefetch:100})}(J,t,(n,r)=>{if(n)return z.publish("run","run.error",n);t.content=r,ye(e,t)})}function ye(e,t){z.cancel("_format-consumer");const{fields:i,content:o,ack:s}=t,a=i.redelivered,c=rt(o);switch(B=t,e){case"run.enter":b.debug(`<${r}> enter`,a?"redelivered":""),_="entered",a||(P=void 0),te&&te.activate(it(t),V),Z&&Z.activate(t),a||xe("enter",c);break;case"run.discard":b.debug(`<${r}> discard`,a?"redelivered":""),_="discard",P=void 0,te&&te.activate(it(t),V),Z&&Z.activate(t),a||(z.publish("run","run.discarded",c),xe("discard",c));break;case"run.start":b.debug(`<${r}> start`,a?"redelivered":""),_="started",a||(z.publish("run","run.execute",c),xe("start",c));break;case"run.execute":return _="executing",F=t,a&&(te&&te.activate(it(t),V),Z&&Z.activate(t)),X.assertConsumer(he,{exclusive:!0,consumerTag:"_activity-execution"}),(P=P||mt(V,n)).execute(t);case"run.end":if("end"===_)break;Q.taken++,_="end",a||(z.publish("run","run.leave",c),xe("end",c));break;case"run.error":xe("error",rt(c,{error:i.redelivered?Rt(t):c.error}));break;case"run.discarded":b.debug(`<${M} (${r})> discarded`),Q.discarded++,_="discarded",c.outbound=void 0,a||z.publish("run","run.leave",c);break;case"run.leave":{const e="discarded"===_;if(_=void 0,z.cancel("_activity-api"),te&&te.deactivate(t),a)break;const n=c.ignoreOutbound;let r,i;n?i=c:(r=we(c,e),i={...c,outbound:r.slice()}),z.publish("run","run.next",c),xe("leave",i),n||$e(r);break}case"run.next":pe()}v||s()}function he(e,t){const n=rt({...F.content,...t.content,executionId:F.content.executionId,parent:{...f}});switch(xe(e,n,t.properties),e){case"execution.outbound.take":return t.ack(),$e(we(n));case"execution.stopped":return t.ack(),ae(),le(),z.cancel("_activity-execution"),xe("stop");case"execution.error":_="error",z.publish("run","run.error",n),z.publish("run","run.discarded",n);break;case"execution.discard":_="discarded",z.publish("run","run.discarded",n);break;default:if(n.outbound&&n.outbound.discarded===k.length){_="discarded",z.publish("run","run.discarded",n);break}_="executed",z.publish("run","run.end",n)}if(t.ack(),!v&&F){const e=F;F=null,e.ack()}}function be(e,t){switch(t.properties.type){case"discard":!function(){if(_&&(!P||P.completed)){switch(_){case"executing":case"error":case"discarded":return}le(),W.purge(),z.publish("run","run.discard",rt(B.content)),ce()}}();break;case"stop":!function(e){if(!V.isRunning)return;q=!0,N=!1,z.cancel("_activity-run"),z.cancel("_activity-api"),z.cancel("_activity-execution"),z.cancel("_run-on-inbound"),z.cancel("_format-consumer"),te&&te.deactivate(e||ie());xe("stop")}(t);break;case"shake":ve(t)}}function ve(e){const t=it(e);if(t.content.sequence=t.content.sequence||[],t.content.sequence.push({id:r,type:i}),!k.length)return z.publish("event","activity.shake.end",t.content,{persistent:!1,type:"shake"});k.forEach(e=>e.shake(t))}function xe(e,t,n={}){e&&(t||(t=ie()),z.publish("event",`activity.${e}`,{...t,state:e},{...n,type:e,mandatory:"error"===e,persistent:"persistent"in n?n.persistent:"stop"!==e}))}function we(e,t){if(!k.length)return[];const{message:n,outbound:r=[]}=e;let i=e.discardSequence;return t&&!i&&A&&e.inbound&&e.inbound[0]&&(i=[e.inbound[0].id]),k.map(e=>{const o=function(e){let o=r.filter(t=>t.id===e).pop();o||(o={id:e,action:t?"discard":"take"},void 0!==n&&(o.message=n));o.discardSequence=i,void 0===n||"message"in o||(o.message=n);return o}(e.id),s=e.preFlight(o.action);return o.sequenceId=s,o})}function $e(e){e&&k.forEach((t,n)=>{const r=e[n];t[r.action](r)})}function Ee(e){return P&&!P.completed?P.getApi(e):ut(z,e||B)}}function Pt(e,t,n="execute.completed"){const{id:r,broker:i,logger:o}=e,s="_eventdefinition-execution-execute-tag",a="_eventdefinition-execution-api-tag";let c,u,p=!1,l=!1;return{execute:function(e){const d=e.content,f=e.fields.redelivered,{isRootScope:m,isDefinitionScope:g,executionId:y}=d;if(g)return function(){const n=t[d.index];if(!n)return o.warn(`<${y} (${r})> found no event definition on index ${d.index}`);o.debug(`<${y} (${r})> execute event definition ${n.type}, index ${d.index}`),n.execute(e)}();let h;m&&(h=y,c=d,i.subscribeTmp("execution","execute.#",(function(e,t){switch(e){case"execute.completed":if(b(),t.content.isDefinitionScope)return function(){const e=rt(t.content);p=!0,o.debug(`<${e.executionId} (${r})> event definition ${e.type} completed, index ${e.index}`),i.publish("execution",n,{...rt(e),executionId:h,isRootScope:!0,parent:at(e.parent)})}();break;case"execute.discard":if(t.content.isDefinitionScope){o.debug(`<${t.content.executionId} (${r})> event definition ${t.content.type} discarded, index ${t.content.index}`);break}b(),o.debug(`<${t.content.executionId} (${r})> event definition parent execution discarded`)}}),{noAck:!0,consumerTag:s,priority:300}),i.subscribeTmp("api",`activity.*.${h}`,(function(e,t){switch(t.properties.type){case"stop":l=!0;case"discard":return b()}}),{noAck:!0,consumerTag:a,priority:300}),u=st(c.parent,c),i.publish("execution","execute.update",{...rt(c),preventComplete:!0}));if(f)return;for(let e=0;e<t.length&&!p&&!l;++e){const n=t[e],s=`${y}_${e}`;o.debug(`<${y} (${r})> start event definition ${n.type}, index ${e}`),i.publish("execution","execute.start",{...rt(c),isRootScope:void 0,type:n.type,executionId:s,isDefinitionScope:!0,index:e,parent:u})}function b(){i.cancel(s),i.cancel(a)}},get completed(){return p}}}function Dt(e){const{id:t,type:n="BoundaryEvent",broker:r,environment:i,attachedTo:o,behaviour:s={},eventDefinitions:a,logger:c}=e,u=o.id,p=!("cancelActivity"in s)||s.cancelActivity,l=a&&Pt(e,a,"execute.bound.completed");return{id:t,type:n,attachedTo:o,cancelActivity:p,execute:function(e){const n=rt(e.content),{isRootScope:s,executionId:a,inbound:d}=n;let f,m;const g=[];s&&(f=a,l&&!i.settings.strict&&r.subscribeTmp("execution","execute.expect",(function(e,t){const n=`_bound-error-listener-${t.content.executionId}`;g.push(n),o.broker.subscribeTmp("event","activity.error",(i=t.content.expectRoutingKey,function(e,t){t.content.id===u&&r.publish("execution",i,rt(t.content))}),{noAck:!0,consumerTag:n,priority:300});var i}),{noAck:!0,consumerTag:"_expect-tag"}),o.broker.subscribeTmp("event","activity.leave",(function(e,t){if(t.content.id!==u)return;return h(),m?r.publish("execution","execute.completed",m):r.publish("execution","execute.discard",n)}),{noAck:!0,consumerTag:`_bound-listener-${f}`,priority:300}),r.subscribeOnce("execution","execute.detach",(function(e,{content:n}){c.debug(`<${f} (${t})> detach from activity <${o.id}>`),h(!0);const i=n.bindExchange;o.broker.subscribeTmp("execution","#",(function(e,t){r.publish(i,e,rt(t.content),t.properties)}),{noAck:!0,consumerTag:`_bound-listener-${f}`}),r.subscribeOnce("execution","execute.bound.completed",y,{consumerTag:`_execution-completed-${f}`})}),{consumerTag:"_detach-tag"}),r.subscribeOnce("api",`activity.#.${f}`,(function(e,t){switch(t.properties.type){case"discard":case"stop":h()}}),{consumerTag:`_api-${f}`}),r.subscribeOnce("execution","execute.bound.completed",(function(e,t){if(!p&&!t.content.cancelActivity)return h(),r.publish("execution","execute.completed",rt(t.content));m=t.content;const n=d&&d[0];c.debug(`<${a} (id)> cancel ${o.status} activity <${n.executionId} (${n.id})>`),o.getApi({content:n}).discard()}),{consumerTag:`_execution-completed-${f}`}));l&&l.execute(e);function y(e,t){return h(),r.publish("execution","execute.completed",rt(t.content))}function h(e){o.broker.cancel(`_bound-listener-${f}`),o.broker.cancel(`_bound-error-listener-${f}`),g.forEach(e=>o.broker.cancel(e)),r.cancel("_expect-tag"),r.cancel("_detach-tag"),r.cancel(`_execution-completed-${f}`),e||r.cancel(`_api-${f}`)}}}}const Mt=/(\w+)\((.*?)(?:\))|(\.|\[|^)(.+?)(?:\]|\[|\.|$)/,Bt=/^(['"])(.*)\1$/,_t=/^\W*-?\d+(.\d+)?\W*$/,Ft=/^-\d+$/;function Nt(e,t,n){if(!e)return;let r,i=function e(t,r,i){let o;const s=i.replace(Mt,(e,i,s,a,c)=>(o=i?function(e,t,r){if(!e)return;let i=[];t?i=(i=i.concat(t.split(","))).map(e=>(function(e,t,n){const r=t.match(Bt);if(r)return r[2];if(_t.test(t))return Number(t);return Nt(e,t,n)})(r,e,n)):i.push(r);return n?function(){return e.apply(this,i)}.call(n):e.apply(null,i)}(qt(r,i),s,t):qt(r,c),""));if(s===i)return;if(null==o)return;const a=()=>e(t,o,s);a.getResult=()=>{if(""===s)return o};return a}(e,e,t.trim());for(;i;)r=i.getResult(),i=i();return r}function qt(e,t){return Array.isArray(e)?function(e,t){if(Ft.test(t)){const n=Number(t),r=0===n?0:e.length+n;return e[r]}return e[t]}(e,t):e[t]}const jt=/\${(.+?)}/;const Lt=["extensions","output","services","scripts","settings","variables","Logger"];function Qt(e={}){const t=Vt(e);let n=e.variables||{};const r={...e.settings||{}},i=e.output||{},o=e.services||{},s=e.scripts||{getScript:function(){},register:function(){}},a=e.Logger||zt,c=e.extensions,u={options:t,extensions:c,output:i,scripts:s,services:o,settings:r,get variables(){return n},addService:function(e,t){o[e]=t},assignVariables:function(e){if(!e||"object"!=typeof e)return;n={...n,...e}},clone:function(e={}){const u={settings:{...r},variables:{...n},output:{...i},Logger:a,extensions:c,scripts:s,...t,...e,services:o};e.services&&(u.services={...o,...e.services});return Qt(u)},getScript:function(...e){return s.getScript(...e)},getServiceByName:function(e){return o[e]},getState:function(){return{settings:{...r},variables:{...n},output:{...i}}},registerScript:function(...e){return s.register(...e)},resolveExpression:function(e,t={},n){const r={environment:u,...t};return function(e,t,n){let r=e;for(;jt.test(r);){const e=r.match(jt),i=e[1];if("true"===i)return!0;if("false"===i)return!1;const o=Nt(t,i,n);if(e.input===e[0])return o;r=r.replace(e[0],void 0===o?"":o)}return r}(e,r,n)},recover:function(t){if(!t)return u;const o=Vt(t);Object.assign(e,o),t.settings&&Object.assign(r,t.settings);t.variables&&Object.assign(n,t.variables);t.output&&Object.assign(i,t.output);return u},Logger:a};return u}function Vt(e){const t={};for(const n in e)-1===Lt.indexOf(n)&&(t[n]=e[n]);if(e.scripts){if("function"!=typeof e.scripts.register)throw new Error("scripts.register is not a function");if("function"!=typeof e.scripts.getScript)throw new Error("scripts.getScript is not a function")}if(e.extensions){if("object"!=typeof e.extensions)throw new Error("extensions is not an object");for(const t in e.extensions)if("function"!=typeof e.extensions[t])throw new Error(`extensions[${t}] is not a function`)}return t}function zt(){return{debug:function(){},error:function(){},warn:function(){}}}function Kt(e){const{id:t,type:n,broker:r,logger:i,environment:o}=e,s=e.getProcesses(),a=s.map(({id:e})=>e),c=e.getExecutableProcesses(),u=[];r.assertExchange("execution","topic",{autoDelete:!1,durable:!0});let p,l,d,f,m,g="init",y=!1;const h={id:t,type:n,broker:r,get environment(){return o},get executionId(){return l},get completed(){return y},get status(){return g},get stopped(){return d},get postponedCount(){return u.length},get isRunning(){return!!f},processes:s,createMessage:R,getApi:S,getState:function(){return{executionId:l,stopped:d,completed:y,status:g,processes:s.map(e=>e.getState())}},getPostponed:function(...e){return s.reduce((t,n)=>t=t.concat(n.getPostponed(...e)),[])},execute:function(e){if(!e)throw new Error("Definition execution requires message");if(!e.content||!e.content.executionId)throw new Error("Definition execution requires execution id");const n=e.fields.redelivered;if(l=e.content.executionId,(m=it(e)).content={...m.content,executionId:l,state:"start"},d=!1,p=r.assertQueue(`execute-${l}-q`,{durable:!0,autoDelete:!1}),n)return b();return i.debug(`<${l} (${t})> execute definition`),x(),v(),!0},resume:b,recover:function(n){return n?(l=n.executionId,d=n.stopped,y=n.completed,g=n.status,i.debug(`<${l} (${t})> recover`,g,"definition execution"),n.processes.forEach(t=>{const n=e.getProcessById(t.id);n&&n.recover(t)}),h):h},stop:function(){S().stop()}};return Object.defineProperty(h,"stopped",{enumerable:!0,get:()=>d}),h;function b(){if(i.debug(`<${l} (${t})> resume`,g,"definition execution"),y)return A("completed");if(x(),u.splice(0),p.consume($,{prefetch:1e3,consumerTag:`_definition-activity-${l}`}),y)return A("completed");switch(g){case"init":return v();case"executing":if(!u.length)return A("completed")}s.forEach(e=>e.resume())}function v(){return s.length?c.length?(g="start",c.forEach(e=>e.init()),c.forEach(e=>e.run()),u.splice(0),void p.assertConsumer($,{prefetch:1e3,consumerTag:`_definition-activity-${l}`})):(w(),e.emitFatal(new Error("No executable process"))):function(e,n){w(),i.debug(`<${l} (${t})> ${e}`),n||(n=R());return r.publish("execution",`execution.${e}.${l}`,n,{type:e})}("completed")}function x(){function e(e,i){const o=it(i),s=o.content,c=s.parent=s.parent||{},u=a.indexOf(s.id)>-1;u?c.executionId=l:s.parent=ct(c,{id:t,type:n,executionId:l}),r.publish("event",e,s,{...o.properties,mandatory:!1}),u&&p.queueMessage(o.fields,rt(s),o.properties)}r.subscribeTmp("api","#",E,{noAck:!0,consumerTag:"_definition-api-consumer"}),s.forEach(t=>{t.broker.subscribeTmp("message","message.outbound",C,{noAck:!0,consumerTag:"_definition-outbound-message-consumer"}),t.broker.subscribeTmp("event","activity.signal",k,{noAck:!0,consumerTag:"_definition-signal-consumer",priority:200}),t.broker.subscribeTmp("event","activity.message",k,{noAck:!0,consumerTag:"_definition-message-consumer",priority:200}),t.broker.subscribeTmp("event","#",e,{noAck:!0,consumerTag:"_definition-activity-consumer",priority:100})}),f=!0}function w(){r.cancel("_definition-api-consumer"),r.cancel(`_definition-activity-${l}`),s.forEach(e=>{e.broker.cancel("_definition-outbound-message-consumer"),e.broker.cancel("_definition-activity-consumer"),e.broker.cancel("_definition-signal-consumer"),e.broker.cancel("_definition-message-consumer")}),f=!1}function $(e,n){const o=n.content,a=n.fields.redelivered,{id:c,type:f,executionId:y}=o;if(!a||!1!==n.properties.persistent){switch(e){case"execution.stop":if(y===l)return n.ack(),i.debug(`<${l} (${t})> stop definition execution (stop process executions ${u.length})`),p.close(),w(),s.slice().forEach(e=>{e.stop()}),d=!0,r.publish("execution",`execution.stopped.${l}`,{...m.content,...o},{type:"stopped",persistent:!1});break;case"process.leave":return function(){if(h(!1),a)return n.ack();i.debug(`<${l} (${t})> left <${c}> (${f}), pending runs ${u.length}`),u.length||(n.ack(),A("completed"))}()}switch(h(!0),e){case"process.discard":case"process.enter":g="executing";break;case"process.error":s.slice().forEach(e=>{e.id!==c&&e.stop()}),A("error",{error:o.error})}}function h(e=!0){const t=function(e){const t=u.findIndex(t=>t.content.id===e);if(t>-1)return u.splice(t,1)[0]}(c);t&&t.ack(),e&&u.push(n)}}function E(e,n){const r=n.properties.type;if(n.properties.delegate&&t===n.content.id){const e=Nt(n,"content.message.id");for(const n of s)n.isRunning||n.getStartActivities({referenceId:e,referenceType:r}).length&&(i.debug(`<${l} (${t})> start <${n.id}>`),n.run())}if(n.properties.delegate)for(const t of s)t.broker.publish("api",e,rt(n.content),n.properties);if(l===n.content.executionId)switch(r){case"stop":p.queueMessage({routingKey:"execution.stop"},rt(n.content),{persistent:!1})}}function A(e,n){return w(),i.debug(`<${l} (${t})> definition execution ${e}`),n||(n=R()),y=!0,"terminated"!==g&&(g=e),r.deleteQueue(p.name),r.publish("execution",`execution.${e}.${l}`,{...m.content,output:o.output,...n,state:e},{type:e,mandatory:"error"===e})}function C(e,n){const r=n.content,{target:o,source:s}=r;i.debug(`<${l} (${t})> conveying message from <${s.processId}.${s.id}> to`,o.id?`<${o.processId}.${o.id}>`:`<${o.processId}>`),I(o.processId).sendMessage(n)}function k(n,o){const s=o.content,a=o.properties.type,c=o.content.message,u=e.getElementById(c.id),p=u&&u.resolve(o);i.debug(`<${l} (${t})>`,u?`${a} <${c.id}>`:`anonymous ${a}`,`event received from <${s.parent.id}.${s.id}>. Delegating.`),S().sendApiMessage(a,{message:p,originalMessage:s.message},{delegate:!0,type:a}),r.publish("event",`definition.${a}`,R({message:p&&rt(p)}),{type:a})}function I(e){return s.find(t=>t.id===e)}function R(e={}){return{id:t,type:n,executionId:l,status:g,...e}}function S(e){e||(e=m||{content:R()});const t=e.content;if(t.executionId!==l)return function(e){const t=e.content;let n=r(t.id);if(n)return n;if(!t.parent)return;if(n=r(t.parent.id))return n;if(!t.parent.path)return;for(let e=0;e<t.parent.path.length;e++)if(n=r(t.parent.path[e].id))return n;function r(t){const n=I(t);if(n)return n.getApi(e)}}(e);const n=pt(r,e);return n.getExecuting=function(){return u.reduce((e,n)=>n.content.executionId===t.executionId?e:(e.push(S(n)),e),[])},n}}function Gt(e){const{id:t,type:n="dummy",name:r,parent:i={},behaviour:o={}}=e;return{id:t,type:n,name:r,behaviour:{...o},parent:ot(i),placeholder:!0}}function Ut(e){const{id:t,type:n,broker:r,eventDefinitions:i}=e,o=i&&Pt(e,i);return{id:t,type:n,execute:function(e){if(o)return o.execute(e);return r.publish("execution","execute.completed",rt(e.content))}}}function Ht(e,t){const{id:n,type:r,broker:i,logger:o,outbound:s=[]}=e;return{id:n,type:r,execute:function(e){const r=e.fields.redelivered,a=e.content,c=a.executionId,u=a.outbound=[],p=[];for(let e=0;e<s.length;e++){const n=s[e];p.push(t.getActivityById(n.targetId)),u.push({id:n.id,action:"take"})}const l=`_gateway-listener-${c}`;if(p.forEach(e=>{e.broker.subscribeOnce("event","activity.end",d,{consumerTag:l})}),i.subscribeOnce("api",`activity.stop.${c}`,(function(){p.forEach(e=>{e.broker.cancel(l)}),i.cancel(`_api-stop-${c}`)}),{noAck:!0,consumerTag:`_api-stop-${c}`}),!r)return i.publish("execution","execute.outbound.take",rt(a));function d(t,r,s){o.debug(`<${c} (${n})> <${r.content.executionId}> completed run, discarding the rest`),p.forEach(e=>{e!==s&&(e.broker.cancel(l),e.discard())});const a=rt(e.content,{ignoreOutbound:!0});i.publish("execution","execute.completed",a)}}}}function Wt(e){const{id:t,type:n,broker:r,logger:i,outbound:o=[]}=e;return{id:t,type:n,execute:function(e){const n=rt(e.content);if(!o.length)return p();let s,a,c;const u=n.outbound=[];for(let t=0;t<o.length;t++){const i=o[t];if(s)u.push({id:i.id,action:"discard"});else if(i.isDefault)a=i;else if(i.evaluateCondition(e,l))s=!0,u.push({id:i.id,action:"take"});else{if(c)return r.publish("execution","execute.error",rt(n,{error:c}));u.push({id:i.id,action:"discard"})}}if(a)s?u.push({id:a.id,action:"discard"}):(i.debug(`<${t}> take default flow <${a.id}>`),u.push({id:a.id,action:"take"}));else if(!s){const o=new kt(`<${t}> no conditional flow taken`,e);return i.error(`<${t}>`,o),r.publish("execution","execute.error",{...n,error:o})}return p();function p(){r.publish("execution","execute.completed",rt(n))}function l(e){c=e}}}}function Xt(e){const{id:t,type:n,broker:r,logger:i,outbound:o=[]}=e;return{id:t,type:n,execute:function(e){const n=rt(e.content);if(!o.length)return p();let s,a,c;const u=n.outbound=[];for(let t=0;t<o.length;t++){const i=o[t];if(i.isDefault)a=i;else if(i.evaluateCondition(e,l))s=!0,u.push({id:i.id,action:"take"});else{if(c)return r.publish("execution","execute.error",rt(n,{error:c}));u.push({id:i.id,action:"discard"})}}if(a)s?u.push({id:a.id,action:"discard"}):(i.debug(`<${t}> take default flow`),u.push({id:a.id,action:"take"}));else if(!s){const o=new kt(`<${t}> no conditional flow taken`,e);return i.error(`<${t}>`,o),r.publish("execution","execute.error",rt(n,{error:o}))}return p();function p(){r.publish("execution","execute.completed",rt(n))}function l(e){c=e}}}}function Jt(e){const{id:t,type:n,broker:r,eventDefinitions:i}=e,o=i&&Pt(e,i);return{id:t,type:n,execute:function(e){if(o)return o.execute(e);const t=rt(e.content),{executionId:n}=t;return r.subscribeTmp("api",`activity.#.${n}`,(function(e,n){switch(n.properties.type){case"message":case"signal":return o=n.content.message,i(),r.publish("execution","execute.completed",rt(t,{output:o}));case"discard":return i(),r.publish("execution","execute.discard",rt(t));case"stop":return i()}var o}),{noAck:!0,consumerTag:`_api-${n}`}),r.publish("event","activity.wait",rt(t));function i(){r.cancel(`_api-${n}`)}}}}function Yt(e){const{id:t,type:n,broker:r,eventDefinitions:i}=e,o=i&&Pt(e,i);return{id:t,type:n,execute:function(e){if(o)return o.execute(e);return r.publish("execution","execute.completed",rt(e.content))}}}function Zt(e,t){const{id:n,broker:r,environment:i}=e,{type:o="LoopCharacteristics",behaviour:s={}}=t,{isSequential:a=!1,collection:c,elementVariable:u="item"}=s;let p,l,d;"loopCardinality"in s&&(d=s.loopCardinality),"loopMaximum"in s&&(d=s.loopMaximum),s.loopCondition&&(s.testBefore?l=s.loopCondition:p=s.loopCondition),s.completionCondition&&(p=s.completionCondition);const f=function(){if(c)return"collection";if(p)return"complete condition";if(l)return"start condition";if(d)return"cardinality"}();if(!f)return;const{debug:m}=i.Logger(o.toLowerCase()),g="_execute-q-multi-instance-tag";r.cancel(g);const y="_api-multi-instance-tag";let h;return r.cancel(y),{type:o,loopType:f,collection:c,elementVariable:u,isSequential:a,loopCardinality:d,execute:function(t){if(!t)throw new Error("LoopCharacteristics execution requires message");const{routingKey:o,redelivered:s}=t.fields||{},{executionId:f}=t.content;return $(),a?function(){let e=0;s&&"execute.iteration.next"===o&&(e=t.content.index);return E((function(e,t){const{content:o}=t;if(o.isRootScope)return;if(!o.isMultiInstance)return;const s=$().output;void 0!==o.output&&(s[o.index]=o.output);if(r.publish("execution","execute.iteration.completed",{...t.content,...$().getContent(),preventComplete:!0,output:s.slice(),state:"iteration.completed"}),x(p,t,s))m(`<${f} (${n})> complete condition met`);else if(i(o.index+1))return;return m(`<${f} (${n})> sequential loop completed`),v(),r.publish("execution","execute.completed",{...t.content,...$().getContent(),output:s})})),i(e,s);function i(e,t){const i=w(e);if(!i)return;const o=$();if(!l||!x(l,{content:i}))return m(`<${i.executionId} (${n})>`,t?"resume":"start",`sequential iteration index ${i.index}`),r.publish("execution","execute.iteration.next",{...i,...o.getContent(),index:e,preventComplete:!0,output:o.output.slice(),state:"iteration.next"}),r.publish("execution","execute.start",{...i,ignoreIfExecuting:t}),i;m(`<${f} (${n})> start condition met`)}}():function(){if(E((function(e,t){const{content:n}=t;if(n.isRootScope)return r.cancel(g);if(!n.isMultiInstance)return;const i=$().output;void 0!==n.output&&(i[n.index]=n.output);if(r.publish("execution","execute.iteration.completed",{...n,...$().getContent(),index:n.index,output:i,state:"iteration.completed"}),x(p,t))return v(),r.publish("execution","execute.completed",{...n,...$().getContent(),output:$().output})})),s)return;let e,t=0;for(;e=w(t);)m(`<${f} (${n})> start parallel iteration index ${t}`),r.publish("execution","execute.start",{...e,keep:!0}),t++}();function w(e){const t=`${f}_${e}`,{cardinality:n,collection:r,parent:i,getContent:o}=$(),s={...o(),isRootScope:void 0,executionId:t,isMultiInstance:!0,index:e,parent:i};if(!function(){if(n>0&&e>=n)return!0;if(r&&e>=r.length)return!0}())return r&&(s[u]=r[e]),s}function $(){if(h)return h;const r=function(){if(!d)return;let r=d;if(!r)return;r=i.resolveExpression(r,t);const o=Number(r);return isNaN(o)?e.emitFatal(new kt(`<${n}> loopCardinality is not a Number >${r}<`,t)):o}(),o=function(){if(!c)return;return m(`<${n}> has collection`),i.resolveExpression(c,t)}(),s={...rt(t.content),loopCardinality:r,isSequential:a,output:void 0},u=t.content.output||[],p=st(t.content.parent,t.content);return h={cardinality:r,collection:o,messageContent:s,output:u,parent:p,getContent:()=>rt(s)}}function E(e){r.subscribeOnce("api",`activity.*.${f}`,b,{consumerTag:y},{priority:400}),r.subscribeTmp("execution","execute.completed",e,{noAck:!0,consumerTag:g,priority:300})}}};function b(e,t){switch(t.properties.type){case"stop":case"discard":v()}}function v(){r.cancel(g),r.cancel(y)}function x(e,t,n){if(!e)return!1;const r={...it(t),loopOutput:n};return i.resolveExpression(e,r)}}function en(e){const{id:t,type:n,broker:r}=e;return{id:t,type:n,execute:function({content:e}){r.publish("execution","execute.completed",rt(e))}}}function tn(e,t){const{id:n,type:r,broker:i,logger:o,isSubProcess:s}=e,{environment:a}=t,c=t.getActivities(n),u=t.getSequenceFlows(n),p=t.getAssociations(n),l=t.getMessageFlows(n),d=[],f=[],m=[],g=[],y={},h=s?"subprocess-execution":"execution";i.assertExchange(h,"topic",{autoDelete:!1,durable:!0});let b,v,x,w,$,E="init",A=!1;const C={id:n,type:r,broker:i,get environment(){return a},get executionId(){return v},get completed(){return A},get status(){return E},get stopped(){return x},get postponedCount(){return g.length},get isRunning(){return!!w},discard:M,execute:function(e){if(!e)throw new Error("Process execution requires message");if(!e.content||!e.content.executionId)throw new Error("Process execution requires execution id");const t=e.fields.redelivered;if(v=e.content.executionId,($=it(e)).content={...$.content,executionId:v,state:"start"},x=!1,a.assignVariables(e),b=i.assertQueue(`execute-${v}-q`,{durable:!0,autoDelete:!1}),t)return function(){if(o.debug(`<${v} (${n})> resume`,E,"process execution"),A)return D("completed");if(I(),g.splice(0),m.splice(0),b.consume(T,{prefetch:1e3,consumerTag:`_process-activity-${v}`}),A)return D("completed");switch(E){case"init":return k();case"executing":if(!g.length)return D("completed")}g.slice().forEach(({content:e})=>{const t=B(e.id);t&&(e.placeholder||t.resume())})}();return o.debug(`<${v} (${n})> execute`,s?"sub process":"process"),I(),k(),!0},getApi:N,getActivityById:B,getActivities:function(){return c.slice()},getPostponed:P,getSequenceFlows:F,getState:function(){return{executionId:v,stopped:x,completed:A,status:E,children:c.reduce((e,t)=>t.placeholder?e:(e.push(t.getState()),e),[]),flows:u.map(e=>e.getState()),messageFlows:l.map(e=>e.getState()),associations:p.map(e=>e.getState())}},recover:function(e){if(!e)return C;v=e.executionId,x=e.stopped,A=e.completed,E=e.status,o.debug(`<${v} (${n})> recover`,E,"process execution"),e.messageFlows&&e.messageFlows.forEach(e=>{const t=function(e){return l.find(t=>t.id===e)}(e.id);t&&t.recover(e)});e.associations&&e.associations.forEach(e=>{const t=function(e){return p.find(t=>t.id===e)}(e.id);t&&t.recover(e)});e.flows&&e.flows.forEach(e=>{const t=_(e.id);t&&t.recover(e)});e.children&&e.children.forEach(e=>{const t=B(e.id);t&&t.recover(e)});return C},stop:function(){N().stop()}};return C;function k(){if(0===c.length)return D("completed");E="start";const e={...$.content,state:E};i.publish(h,"execute.start",rt(e)),d.length>1&&d.forEach(e=>e.shake()),d.forEach(e=>e.init()),d.forEach(e=>e.run()),g.splice(0),m.splice(0),b.assertConsumer(T,{prefetch:1e3,consumerTag:`_process-activity-${v}`})}function I(){function e(e,t){const s=it(t);if(s.fields.redelivered&&!1===s.properties.persistent)return;const a=s.content,c=a.parent=a.parent||{};let u=s.properties.delegate;const p="shake"===s.properties.type,l=a.parent.id===n;if(l?c.executionId=v:a.parent=ct(c,{id:n,type:r,executionId:v}),u&&(u=function(e){const t=e.properties.type;let r=!0;const i=e.content;return o.debug(`<${v} (${n})> delegate`,t,i.message&&i.message.id?`event with id <${i.message.id}>`:"anonymous event"),f.forEach(e=>{e.getStartActivities({referenceId:i.message&&i.message.id,referenceType:t}).length&&(r=!1,e.run(i.message))}),N().sendApiMessage(t,i,{delegate:!0}),r}(s)),i.publish("event",e,a,{...s.properties,delegate:u,mandatory:!1}),p)return function(e){if("activity.shake.end"!==e.fields.routingKey)return;y[e.content.id]=it(e)}(s);if(l&&!a.isAssociation){switch(e){case"process.terminate":return b.queueMessage({routingKey:"execution.terminate"},rt(a),{type:"terminate",persistent:!0});case"activity.stop":return}b.queueMessage(s.fields,rt(a),{persistent:!0,...s.properties})}}i.subscribeTmp("api","#",O,{noAck:!0,consumerTag:`_process-api-consumer-${v}`,priority:200}),l.forEach(e=>{e.activate(),e.broker.subscribeTmp("event","#",S,{consumerTag:"_process-message-consumer",noAck:!0,priority:200})}),u.forEach(t=>{t.broker.subscribeTmp("event","#",e,{consumerTag:"_process-flight-controller",noAck:!0,priority:200})}),p.forEach(t=>{t.broker.subscribeTmp("event","#",e,{consumerTag:"_process-association-controller",noAck:!0,priority:200})}),d.splice(0),f.splice(0),c.forEach(t=>{t.placeholder||(t.activate(C),t.broker.subscribeTmp("event","#",e,{noAck:!0,consumerTag:"_process-activity-consumer",priority:200}),t.isStart&&d.push(t),t.triggeredByEvent&&f.push(t))}),w=!0}function R(){i.cancel(`_process-api-consumer-${v}`),i.cancel(`_process-activity-${v}`),c.forEach(e=>{e.placeholder||(e.broker.cancel("_process-activity-consumer"),e.deactivate())}),u.forEach(e=>{e.broker.cancel("_process-flight-controller")}),p.forEach(e=>{e.broker.cancel("_process-association-controller")}),l.forEach(e=>{e.deactivate(),e.broker.cancel("_process-message-consumer")}),w=!1}function S(e,t){i.publish("message",e,rt(t.content),t.properties)}function T(e,t){const r=t.content,s=t.fields.redelivered,{id:a,type:c,isEnd:u}=r;if(s&&!1===t.properties.persistent)return t.ack();switch(e){case"execution.stop":return t.ack(),function(){if(x)return;return o.debug(`<${v} (${n})> stop process execution (stop child executions ${g.length})`),P().forEach(e=>{e.stop()}),R(),x=!0,i.publish(h,`execution.stopped.${v}`,{...$.content,...r},{type:"stopped",persistent:!1})}();case"execution.terminate":return t.ack(),function(e){E="terminated",o.debug(`<${v} (${n})> terminating process execution`);const t=g.splice(0);F().forEach(e=>{e.stop()}),t.forEach(t=>{const{id:n,isSequenceFlow:r}=t.content;n!==e.content.id&&(r||(N(t).stop(),t.ack()))}),b.purge()}(t);case"execution.discard":return t.ack(),function(){R();const e=g.splice(0);return o.debug(`<${v} (${n})> discard process execution (discard child executions ${e.length})`),F().forEach(e=>{e.stop()}),e.forEach(e=>{N(e).discard()}),b.purge(),D("discard")}();case"activity.compensation.end":case"flow.looped":case"activity.leave":return function(){if(p(!1),s)return t.ack();o.debug(`<${v} (${n})> left <${a}> (${c}), pending runs ${g.length}`,g.map(e=>e.content.id));const e=g.length;if(!e)return t.ack(),D("completed");e===m.length&&P().forEach(e=>e.discard())}()}switch(p(!0),e){case"activity.detach":m.push(it(t));break;case"activity.discard":case"activity.compensation.start":case"activity.enter":E="executing",function(){if(!r.inbound)return;r.inbound.forEach(e=>{if(!e.isSequenceFlow)return;const t=l(e);t&&t.ack()})}();break;case"activity.end":u&&function(){for(const e of g){const t=e.content.id,n=y[t];n&&n.content.sequence.some(({id:e})=>e===a)&&N(e).discard()}}();break;case"flow.error":case"activity.error":if(g.find(e=>{if("activity.catch"===e.fields.routingKey)return e.content.source&&e.content.source.executionId===r.executionId})){o.debug(`<${v} (${n})> error was caught`);break}D("error",{error:r.error})}function p(e=!0){const n=l(r);n&&n.ack(),e&&g.push(t)}function l(e){const t=g.findIndex(t=>t.content.isSequenceFlow?t.content.sequenceId===e.sequenceId:t.content.executionId===e.executionId);let n;t>-1&&(n=g.splice(t,1)[0]);const r=m.findIndex(t=>t.content.executionId===e.executionId);return r>-1&&m.splice(r,1),n}}function O(e,t){if(t.properties.delegate)for(const n of c)n.placeholder||n.broker.publish("api",e,rt(t.content),t.properties);else{if(n!==t.content.id){const n=B(t.content.id);return n?n.broker.publish("api",e,t.content,t.properties):null}if(v===t.content.executionId)switch(t.properties.type){case"discard":return M();case"stop":b.queueMessage({routingKey:"execution.stop"},rt(t.content),{persistent:!1})}}}function P(e){return g.slice().reduce((t,n)=>{const r=N(n);if(r){if(e&&!e(r))return t;t.push(r)}return t},[])}function D(e,t={}){return R(),o.debug(`<${v} (${n})> process execution ${e}`),A=!0,"terminated"!==E&&(E=e),i.deleteQueue(b.name),i.publish(h,`execution.${e}.${v}`,{...$.content,output:a.output,...t,state:e},{type:e,mandatory:"error"===e})}function M(){return E="discard",b.queueMessage({routingKey:"execution.discard"},{id:n,type:r,executionId:v},{type:"discard"})}function B(e){return c.find(t=>t.id===e)}function _(e){return u.find(t=>t.id===e)}function F(){return u.slice()}function N(e){if(!e)return lt(i,$);const t=e.content;if(t.executionId!==v)return function(e){const t=e.content;let n=r(t.id);if(n)return n;if(!t.parent)return;if(n=r(t.parent.id))return n;if(!t.parent.path)return;for(let e=0;e<t.parent.path.length;e++)if(n=r(t.parent.path[e].id))return n;function r(t){const n=function(e){return B(e)||_(e)}(t);if(n)return n.getApi(e)}}(e);const n=lt(i,e);return n.getExecuting=function(){return g.reduce((e,n)=>n.content.executionId===t.executionId?e:(e.push(N(n)),e),[])},n}}function nn(e){const{id:t,type:n,broker:r,logger:i,behaviour:o={},getActivityById:s}=e,a=o.messageRef||{name:"anonymous"},c=a.id&&s(a.id),u=o.loopCharacteristics&&o.loopCharacteristics.Behaviour(e,o.loopCharacteristics);return{id:t,type:n,reference:{...a,referenceType:"message"},execute:function(e){const n=e.content;if(u&&n.isRootScope)return u.execute(e);let o;const{executionId:s}=n,{message:p,description:l}=function(e){if(!c)return{message:{...a},description:"anonymous message"};const t={message:c.resolve(e)};return t.description=`${t.message.name} <${t.message.id}>`,t}(e);if(r.consume("message",(function(e,o){if(Nt(o,"content.message.id")!==p.id)return;i.debug(`<${s} (${t})> caught ${l}`),r.publish("event","activity.catch",rt(n,{message:o.content.message}),{type:"catch"}),d(o.content.message)}),{noAck:!0,consumerTag:`_onmessage-${s}`}),o)return;function d(e){return o=!0,f(),r.publish("execution","execute.completed",rt(n,{output:e}))}function f(){r.cancel(`_onmessage-${s}`),r.cancel(`_api-${s}`),r.purgeQueue("message")}r.subscribeTmp("api",`activity.#.${s}`,(function(e,t){switch(t.properties.type){case"message":case"signal":return d(t.content.message);case"discard":return o=!0,f(),r.publish("execution","execute.discard",rt(n));case"stop":return f()}}),{noAck:!0,consumerTag:`_api-${s}`,priority:400}),i.debug(`<${s} (${t})> expect ${l}`),r.publish("event","activity.wait",rt(n,{message:{...p}}))}}}function rn(e,t={}){const{id:n,type:r,environment:i,logger:o}=e,{fields:s,content:a,properties:c}=it(t),u={id:n,type:r,fields:s,content:a,properties:c,environment:i,logger:o,resolveExpression:function(e){return i.resolveExpression(e,u)},ActivityError:kt,BpmnError:It};return u}function on(e){const{id:t,type:n,behaviour:r,broker:i,logger:o,environment:s,emitFatal:a}=e,{scriptFormat:c,script:u}=e.behaviour,p=r.loopCharacteristics&&r.loopCharacteristics.Behaviour(e,r.loopCharacteristics);return s.registerScript(e),{id:t,type:n,loopCharacteristics:p,execute:function(n){const r=n.content;if(p&&r.isRootScope)return p.execute(n);if(!u)return i.publish("execution","execute.completed",rt(r));const l=s.getScript(c,e);if(!l)return a(new kt(`Script format ${c} is unsupported or was not registered for <${e.id}>`,n),r);return l.execute(rn(e,n),(function(e,s){if(e)return o.error(`<${r.executionId} (${t})>`,e),i.publish("execution","execute.error",rt(r,{error:new kt(e.message,n,e)}));return i.publish("execution","execute.completed",rt(r,{output:s}))}))}}}function sn(e,t){return Ot(an,e,t)}function an(e){const{id:t,type:n,broker:r,logger:i,behaviour:o,environment:s,emitFatal:a}=e,c=o.loopCharacteristics&&o.loopCharacteristics.Behaviour(e,o.loopCharacteristics);return{id:t,type:n,loopCharacteristics:c,execute:function(e){const n=e.content;if(c&&n.isRootScope)return c.execute(e);const{executionId:o}=n,s=u(e);return s?(r.subscribeTmp("api",`activity.#.${n.executionId}`,(function(e,a){if("discard"===a.properties.type)return r.cancel(`_api-${o}`),s&&s.discard&&s.discard(a),i.debug(`<${n.executionId} (${t})> discarded`),r.publish("execution","execute.discard",rt(n,{state:"discard"}));if("stop"===a.properties.type)return r.cancel(`_api-${o}`),s&&s.stop&&s.stop(a),i.debug(`<${n.executionId} (${t})> stopped`)}),{consumerTag:`_api-${o}`}),s.execute(e,(s,a)=>(r.cancel(`_api-${o}`),s?(i.error(`<${n.executionId} (${t})>`,s),r.publish("execution","execute.error",rt(n,{error:new kt(s.message,e,s)}))):r.publish("execution","execute.completed",rt(n,{output:a,state:"complete"}))))):a(new kt(`<${t}> service not defined`,e),n)},getService:u};function u(n){const r=o.Service;return r?r(e,it(n)):s.settings.enableDummyService?(i.debug(`<${t}> returning dummy service`),{type:"dummyservice",execute:function(...e){i.debug(`<${t}> executing dummy service`),e.pop()()}}):null}}function cn(e,t){return Ot(un,e,t)}function un(e){const{id:t,type:n,behaviour:r,broker:i}=e,o=r.loopCharacteristics&&r.loopCharacteristics.Behaviour(e,r.loopCharacteristics);return{id:t,type:n,loopCharacteristics:o,execute:function(e){const t=e.content;if(o&&t.isRootScope)return o.execute(e);const{executionId:n}=t;i.subscribeTmp("api",`activity.#.${n}`,(function(r,o){switch(o.properties.type){case"stop":return i.cancel(`_api-${n}`);case"signal":return i.cancel(`_api-${n}`),i.publish("execution","execute.completed",rt(t,{output:o.content.message,state:"signal"}));case"error":return i.cancel(`_api-${n}`),i.publish("execution","execute.error",rt(t,{error:new kt(o.content.message,e,o.content)}));case"discard":return i.cancel(`_api-${n}`),i.publish("execution","execute.discard",rt(t))}}),{noAck:!0,consumerTag:`_api-${n}`}),i.publish("event","activity.wait",rt(t,{state:"wait",isRecovered:e.fields.redelivered}))}}}function pn(e){const{id:t,type:n="startevent",broker:r,eventDefinitions:i}=e,o=i&&Pt(e,i);return{id:t,type:n,execute:function(e){if(o)return o.execute(e);const t=rt(e.content);if(!t.form)return r.publish("execution","execute.completed",t);const{executionId:n}=t;r.subscribeTmp("api",`activity.#.${n}`,(function(e,i){switch(i.properties.type){case"stop":return r.cancel(`_api-${n}`);case"signal":return r.cancel(`_api-${n}`),r.publish("execution","execute.completed",rt(t,{output:i.content.message,state:"signal"}));case"discard":return r.cancel(`_api-${n}`),r.publish("execution","execute.discard",rt(t))}}),{noAck:!0,consumerTag:`_api-${n}`,priority:300}),r.publish("event","activity.wait",{...t,executionId:n,state:"wait"})}}}function ln(e,t){const{id:n,type:r,broker:i,behaviour:o,environment:s,logger:a}=e,c=o.loopCharacteristics&&o.loopCharacteristics.Behaviour(e,o.loopCharacteristics),u=[];let p;return{id:n,type:r,loopCharacteristics:c,get execution(){return u[0]},get executions(){return u},execute:function(n){const r=n.content;r.isRootScope&&(p=r.executionId);if(c&&r.isRootScope)return i.subscribeTmp("api",`activity.#.${p}`,(function(e,t){switch(t.properties.type){case"stop":i.cancel(`_api-${p}`),u.forEach(e=>{i.cancel(`_sub-process-execution-${e.executionId}`),i.cancel(`_sub-process-api-${e.executionId}`),e.stop()});break;case"discard":i.cancel(`_api-${p}`),u.forEach(e=>{i.cancel(`_sub-process-execution-${e.executionId}`),i.cancel(`_sub-process-api-${e.executionId}`),e.discard()})}}),{noAck:!0,consumerTag:`_api-${p}`,priority:200}),c.execute(n);const o=function(n){const r=n.content.executionId;let i=d(r);if(i)return n.fields.redelivered&&l(i,r),i;const o=s.clone({output:{}}),a=t.clone(o);return i=tn(e,a),u.push(i),l(i,r),i}(n);if(!o)return;return o.execute(n)},getApi:function(e){const t=e.content;if(t.id===n)return;let r;if(r=d(t.parent.executionId))return r.getApi(e);const i=t.parent.path;for(let t=0;t<i.length;t++)if(r=d(i[t].executionId))return r.getApi(e)},getState:function(){if(c)return{executions:u.map(e)};if(u.length)return e(u[0]);function e(e){const t=e.getState();return t.environment=e.environment.getState(),t}},getPostponed(){return this.executions.reduce((e,t)=>e=e.concat(t.getPostponed()),[])},recover:function n(r){if(!r)return;if(c&&r.executions)return u.splice(0),r.executions.forEach(n);c||u.splice(0);const i=s.clone().recover(r.environment);const o=t.clone(i);const a=tn(e,o).recover(r);u.push(a);return a}};function l(e,t){const r=`_sub-process-execution-${t}`;i.subscribeTmp("subprocess-execution",`execution.#.${t}`,(function(e,t){const o=t.content,s=t.properties.type;if(t.fields.redelivered&&!1===t.properties.persistent)return;switch(s){case"stopped":i.cancel(r);break;case"discard":i.cancel(r),i.publish("execution","execute.discard",rt(o));break;case"completed":i.cancel(r),i.publish("execution","execute.completed",rt(o));break;case"error":{i.cancel(r);const{error:e}=o;a.error(`<${n}>`,e),i.publish("execution","execute.error",rt(o));break}}}),{noAck:!0,consumerTag:r})}function d(e){return u.find(t=>t.executionId===e)}}function dn(e){const{id:t,type:n,behaviour:r,broker:i}=e,o=r.loopCharacteristics&&r.loopCharacteristics.Behaviour(e,r.loopCharacteristics);return{id:t,type:n,loopCharacteristics:o,execute:function(e){const t=e.content;if(o&&t.isRootScope)return o.execute(e);return i.publish("execution","execute.completed",{...t})}}}var fn,mn=Ne((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=["weeks","years","months","days","hours","minutes","seconds"],r=t.pattern=new RegExp("P(?:(\\d+(?:[\\.,]\\d+)?W)|(\\d+(?:[\\.,]\\d+)?Y)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?D)?(?:T(\\d+(?:[\\.,]\\d+)?H)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?S)?)?)"),i=t.parse=function(e){return e.match(r).slice(1).reduce((function(e,t,r){return e[n[r]]=parseFloat(t)||0,e}),{})},o=t.end=function(e,t){var n=t?t.getTime():Date.now(),r=new Date(n);return r.setFullYear(r.getFullYear()+e.years),r.setMonth(r.getMonth()+e.months),r.setDate(r.getDate()+e.days),r.setHours(r.getHours()+e.hours),r.setMinutes(r.getMinutes()+e.minutes),r.setMilliseconds(r.getMilliseconds()+1e3*e.seconds),r.setDate(r.getDate()+7*e.weeks),r},s=t.toSeconds=function(e,t){var n=t?t.getTime():Date.now(),r=new Date(n);return(o(e,r).getTime()-r.getTime())/1e3};t.default={end:o,toSeconds:s,pattern:r,parse:i}}));(fn=mn)&&fn.__esModule&&Object.prototype.hasOwnProperty.call(fn,"default")&&fn.default;mn.pattern;var gn=mn.parse,yn=(mn.end,mn.toSeconds);var hn=Object.freeze({__proto__:null,Association:function(e,{environment:t}){const{id:n,type:r="association",name:i,parent:o,targetId:s,sourceId:a,behaviour:c={}}=e,u=ot(o),p=t.Logger(r.toLowerCase()),l={complete:0,take:0,discard:0},d={id:n,type:r,name:i,parent:u,behaviour:c,sourceId:a,targetId:s,isAssociation:!0,environment:t,get counters(){return{...l}},complete:function(e={}){return p.debug(`<${n}> completed target <${s}>`),++l.complete,h("complete",e),!0},discard:function(e={}){return p.debug(`<${n}> discard target <${s}>`),++l.take,h("discard",e),!0},getApi:function(e){return dt(f,e||{content:b()})},getState:function(){const e={id:n,type:r,name:i,sourceId:a,targetId:s,counters:{...l}};return e.broker=f.getState(),e},recover:function(e){Object.assign(l,e.counters),f.recover(e.broker)},stop:function(){f.stop()},take:function(e={}){return p.debug(`<${n}> take target <${s}>`),++l.discard,h("take",e),!0}},{broker:f,on:m,once:g,waitFor:y}=Tt(d,{prefix:"association",durable:!0,autoDelete:!1});return d.on=m,d.once=g,d.waitFor=y,Object.defineProperty(d,"broker",{enumerable:!0,get:()=>f}),p.debug(`<${n}> init, <${a}> -> <${s}>`),d;function h(e,t){const r=b({action:e,message:t,sequenceId:ht(n)});f.publish("event",`association.${e}`,r,{type:e})}function b(e={}){return{...e,id:n,type:r,name:i,sourceId:a,targetId:s,isAssociation:!0,parent:ot(u)}}},Activity:Ot,BoundaryEvent:function(e,t){return Ot(Dt,e,t)},BpmnError:function(e,t){const{id:n,type:r,name:i="BpmnError",behaviour:o={}}=e,{environment:s}=t;return{id:n,type:r,name:i,errorCode:o.errorCode,resolve:function(e,t){const a={...e,error:t},c={id:n,type:r,messageType:"throw",name:i&&s.resolveExpression(i,a),code:o.errorCode&&s.resolveExpression(o.errorCode,a)};t&&(c.inner=t);return c}}},CompensateEventDefinition:function(e,t,n){const{id:r,broker:i,environment:o,isThrowing:s}=e,{type:a}=t,{debug:c}=o.Logger(a.toLowerCase()),u=`compensate-${yt(r)}-q`,p=n.getOutboundAssociations(r)||[];return s||(i.assertQueue(u,{autoDelete:!1,durable:!0}),i.bindQueue(u,"api","*.compensate.#",{durable:!0,priority:400})),{id:r,type:a,reference:{referenceType:"compensate"},execute:s?function(e){const t=rt(e.content),{executionId:n,parent:o}=t,s=o&&o.executionId;return c(`<${n} (${r})> throw compensate`),i.publish("event","activity.compensate",{...rt(t),executionId:s,parent:at(o),state:"throw"},{type:"compensate",delegate:!0}),i.publish("execution","execute.completed",{...t})}:function(e){let t;const n=rt(e.content),{executionId:o,parent:s}=n,a=s&&s.executionId;if(i.consume(u,d,{noAck:!0,consumerTag:`_oncompensate-${o}`}),t)return;if(i.subscribeTmp("api",`activity.#.${o}`,(function(e,r){switch(r.properties.type){case"compensate":return d(e,r);case"discard":return t=!0,m(),p.forEach(e=>{e.discard(it(r))}),i.publish("execution","execute.discard",{...n});case"stop":m()}}),{noAck:!0,consumerTag:`_api-${o}`}),t)return m();c(`<${o} (${r})> expect compensate`),i.assertExchange("compensate","topic");const l=i.assertQueue("compensate-q",{durable:!0,autoDelete:!1});function d(s,u){const d=u.content.message;t=!0,m(),c(`<${o} (${r})> caught compensate event`),i.publish("event","activity.catch",{...n,message:{...d},executionId:a,parent:at(e.content.parent)},{type:"catch"}),l.on("depleted",(function e(){l.off("depleted",e);return i.publish("execution","execute.completed",{...n,output:d,state:"catch"})})),l.consume(f,{noAck:!0,consumerTag:"_convey-messages"}),p.forEach(e=>{e.complete(it(u))})}function f(e,t){p.forEach(e=>{e.take(it(t))})}function m(){i.cancel(`_api-${o}`),i.cancel(`_oncompensate-${o}`),i.cancel("_oncollect-messages"),i.cancel("_convey-messages")}i.subscribeTmp("compensate","execute.#",(function(e,t){switch(e){case"execute.error":case"execute.completed":return l.queueMessage(t.fields,rt(t.content),t.properties)}}),{noAck:!0,consumerTag:"_oncollect-messages"}),i.publish("execution","execute.detach",rt({...n,bindExchange:"compensate"})),i.publish("event","activity.detach",{...n,executionId:a,parent:at(s),bindExchange:"compensate"})}}},ConditionalEventDefinition:function(e,t){const{id:n,broker:r,environment:i,attachedTo:o}=e,{type:s="ConditionalEventDefinition",behaviour:a={}}=t,{debug:c}=i.Logger(s.toLowerCase()),u=a.expression,p=!o;return{type:s,condition:u,execute:function(e){return p?function(e){const t=rt(e.content);t.condition=u;const{executionId:o,parent:s}=t,a=s&&s.executionId;if(l(e))return;function p(e,n){switch(n.properties.type){case"signal":return l(n);case"discard":return d(),r.publish("execution","execute.discard",{...t,state:"discard"});case"stop":d()}}function l(e){const s=i.resolveExpression(u,e);if(c(`<${o} (${n})> condition evaluated to`,!!s),r.publish("event","activity.condition",{...rt(t),conditionResult:s}),s)return d(),r.publish("execution","execute.completed",{...t,output:s})}function d(){r.cancel(`_api-${o}`),r.cancel(`_parent-signal-${o}`)}r.subscribeTmp("api",`activity.#.${o}`,p,{noAck:!0,consumerTag:`_api-${o}`}),r.subscribeTmp("api",`activity.signal.${a}`,p,{noAck:!0,consumerTag:`_parent-signal-${o}`}),r.publish("event","activity.wait",{...rt(t),executionId:a,parent:at(s)})}(e):function(e){const t=o.broker,s=rt(e.content),{executionId:a,index:p}=s;s.condition=u;const l=`_api-${a}_${p}`,d=`_onend-${a}_${p}`;function f(){t.cancel(d),r.cancel(l)}r.subscribeTmp("api",`activity.#.${a}`,(function(e,t){switch(t.properties.type){case"discard":return f(),c(`<${a} (${n})> discarded`),r.publish("execution","execute.discard",{...s,state:"discard"});case"stop":return f(),c(`<${a} (${n})> stopped`)}}),{noAck:!0,consumerTag:l}),c(`<${a} (${n})> listen for execute completed from <${o.id}>`),t.subscribeOnce("execution","execute.completed",(function(e,t){f();const o=i.resolveExpression(u,t);c(`<${a} (${n})> condition from <${t.content.executionId}> evaluated to`,!!o),r.publish("event","activity.condition",{...rt(s),conditionResult:o}),o&&r.publish("execution","execute.completed",{...s,output:o})}),{priority:300,consumerTag:d})}(e)}}},Context:function(e,t){return function e(t,n){const{id:r="Def",name:i,type:o="context"}=t;const s=ht(r);const a={},c={},u=[],p={},l={},d=[];const f={id:r,name:i,type:o,sid:s,definitionContext:t,environment:n,clone:function(r){return e(t,r||n)},getActivities:y,getActivityById:function(e){const n=a[e];if(n)return n;const r=t.getActivityById(e);return r?g(r):null},getAssociations:function(e){return(t.getAssociations(e)||[]).map(e=>b(e))},getExecutableProcesses:function(){return t.getExecutableProcesses().map(({id:e})=>v(e))},getDataObjectById:function(e){let n;if(n=c[e])return n;const r=t.getDataObjectById(e);if(!r)return;return n=c[r.id]=r.Behaviour(r,f)},getInboundAssociations:function(e){return(t.getInboundAssociations(e)||[]).map(e=>b(e))},getInboundSequenceFlows:function(e){return(t.getInboundSequenceFlows(e)||[]).map(e=>h(e))},getMessageFlows:function(e){if(!u.length){const e=t.getMessageFlows()||[];u.push(...e.map(e=>e.Behaviour(e,f)))}return u.filter(t=>t.source.processId===e)},getOutboundSequenceFlows:function(e){return(t.getOutboundSequenceFlows(e)||[]).map(e=>h(e))},getOutboundAssociations:function(e){return(t.getOutboundAssociations(e)||[]).map(e=>b(e))},getProcessById:v,getProcesses:function(){return t.getProcesses().map(({id:e})=>v(e))},getSequenceFlowById:function(e){const n=l[e];if(n)return n;const r=t.getSequenceFlowById(e);return r?h(r):null},getSequenceFlows:function(e){return(t.getSequenceFlows(e)||[]).map(e=>h(e))},getStartActivities:function(e,t){const{referenceId:n,referenceType:r="unknown"}=e||{};return y().filter(i=>!!i.isStart&&((!t||i.parent.id===t)&&(!e||!(!i.behaviour.eventDefinitions&&!i.behaviour.eventDefinitions)&&i.eventDefinitions.some(e=>e.reference&&e.reference.id===n&&e.reference.referenceType===r))))},loadExtensions:function(e){return m.get(e)}};const m=function(e){const{extensions:t}=e.environment,n=function(){const e=[];if(!t)return e;for(const n in t){const r=t[n];r&&e.push(r)}return e}();return{get:function(t){const r=n.reduce((function(n,r){const i=r(t,e);i&&n.push(i);return n}),[]);return{activate:function(e){r.forEach(t=>t.activate(e))},deactivate:function(e){r.forEach(t=>t.deactivate(e))}}}}}(f);return f;function g(e){let t=a[e.id];return t||(t=a[e.id]=e.Behaviour(e,f))}function y(e){return(t.getActivities(e)||[]).map(e=>g(e))}function h(e){let t=l[e.id];return t||(t=l[e.id]=e.Behaviour(e,f))}function b(e){let t=d[e.id];return t||(t=d[e.id]=e.Behaviour(e,f))}function v(e){let n=p[e];if(n)return n;const r=t.getProcessById(e);return r?n=p[e]=r.Behaviour(r,f):null}}(e,t=t?t.clone():Qt())},DataObject:function(e,{environment:t}){const{id:n,type:r,name:i,behaviour:o,parent:s}=e;return{id:n,name:i,type:r,behaviour:o,parent:s,read(e,o,s,a){const c=t.variables._data&&t.variables._data[n];return e.publish(o,`${s}response`,{id:n,name:i,type:r,value:c},a)},write:(e,o,s,a,c)=>(t.variables._data=t.variables._data||{},t.variables._data[n]=a,e.publish(o,`${s}response`,{id:n,name:i,type:r,value:a},c))}},Definition:function(e,t){if(!e)throw new Error("No context");const{id:n,name:r,type:i="definition"}=e;let o=e.environment;t&&(o=o.clone(t),e=e.clone(o));const s=o.Logger(i.toLowerCase());let a,c,u,p,l,d,f,m,g,y={completed:0,discarded:0};const h={id:n,name:r,type:i,logger:s,context:e,get counters(){return{...y}},get executionId(){return c},get status(){return g},get execution(){return a},get isRunning(){return!!m&&!!g},get environment(){return o},run:function(e){if(h.isRunning){const t=new Error("definition is already running");if(e)return e(t);throw t}R(e);const t=S({executionId:c=ht(n)});b.publish("run","run.enter",t),b.publish("run","run.start",rt(t)),b.publish("run","run.execute",rt(t)),s.debug(`<${c} (${n})> run`),k()},getApi:F,getState:function(){return S({executionId:c,status:g,stopped:f,counters:{...y},environment:o.getState(),execution:a&&a.getState(),broker:b.getState()})},getActivityById:function(e){let t;const n=M();for(let r=0;r<n.length;r++)if(t=n[r].getActivityById(e))return t;return t},getElementById:_,getPostponed:function(...e){return a?a.getPostponed(...e):[]},getProcesses:M,getExecutableProcesses:function(){u||B();return p},getProcessById:function(e){return M().find(t=>t.id===e)},sendMessage:function(e){const t={message:e};let n="message";const r=e&&e.id&&_(e.id);if(r&&r.resolve){const i=r.resolve(S({message:e}));n=i.messageType||n,t.message={...e,...i}}return F().sendApiMessage(n,t,{delegate:!0})},recover:function(e){if(h.isRunning)throw new Error("cannot recover running definition");if(!e)return h;f=e.stopped,g=e.status,c=e.executionId,e.counters&&(y={...y,...e.counters});e.environment&&o.recover(e.environment);e.execution&&(a=Kt(h).recover(e.execution));return b.recover(e.broker),h},resume:function(e){if(h.isRunning){const t=new Error("cannot resume running definition");if(e)return e(t);throw t}if(f=!1,!g)return h;R(e),s.debug(`<${c} (${n})> resume`);const t=S({executionId:c});return b.publish("run","run.resume",t,{persistent:!1}),k(),h},signal:function(e){return F().signal(e,{delegate:!0})},stop:function(){if(!h.isRunning)return;F().stop()}},{broker:b,on:v,once:x,waitFor:w,emit:$,emitFatal:E}=function(e,t){return St(e,"definition",t)}(h,T);h.on=v,h.once=x,h.waitFor=w,h.emit=$,h.emitFatal=E;const A=b.getQueue("run-q"),C=b.getQueue("execution-q");return Object.defineProperty(h,"broker",{enumerable:!0,get:()=>b}),Object.defineProperty(h,"stopped",{enumerable:!0,get:()=>a&&a.stopped}),h;function k(){m=!0,b.subscribeTmp("api",`definition.*.${c}`,N,{noAck:!0,consumerTag:"_definition-api"}),A.assertConsumer(O,{exclusive:!0,consumerTag:"_definition-run"})}function I(){b.cancel("_definition-api"),b.cancel("_definition-run"),b.cancel("_definition-execution"),m=!1}function R(e){function t(t,r){return n(),e(null,F(r))}function n(){b.cancel("_definition-callback-stop"),b.cancel("_definition-callback-leave"),b.cancel("_definition-callback-error"),b.on("return",T)}e&&(b.off("return",T),n(),b.subscribeOnce("event","definition.stop",t,{consumerTag:"_definition-callback-stop"}),b.subscribeOnce("event","definition.leave",t,{consumerTag:"_definition-callback-leave"}),b.subscribeOnce("event","definition.error",(function(t,r){n(),c=void 0,I(),A.purge(),C.purge();const i=Rt(r);return e(i)}),{consumerTag:"_definition-callback-error"}))}function S(e={}){return{id:n,type:i,name:r,...e}}function T(e){if("error"===e.properties.type){throw I(),Rt(e)}}function O(e,t){const{content:r,ack:i,fields:o}=t;if("run.resume"===e)return function(){switch(t.ack(),d.fields.routingKey){case"run.enter":case"run.start":case"run.discarded":case"run.end":case"run.leave":break;default:return}if(!d.fields.redelivered)return;return s.debug(`<${n}> resume from ${g}`),b.publish("run",d.fields.routingKey,rt(d.content),d.properties)}();switch(d=t,e){case"run.enter":if(s.debug(`<${c} (${n})> enter`),g="entered",o.redelivered)break;a=void 0,D("enter",r);break;case"run.start":s.debug(`<${c} (${n})> start`),g="start",D("start",r);break;case"run.execute":{g="executing";const e=it(t);return o.redelivered&&!a&&(e.fields.redelivered=void 0),l=t,C.assertConsumer(P,{exclusive:!0,consumerTag:"_definition-execution"}),(a=a||Kt(h)).execute(e)}case"run.error":D("error",rt(r,{error:o.redelivered?Rt(t):r.error}));break;case"run.end":if("end"===g)break;y.completed++,s.debug(`<${c} (${n})> completed`),g="end",b.publish("run","run.leave",r),D("end",r);break;case"run.discarded":if("discarded"===g)break;y.discarded++,g="discarded",b.publish("run","run.leave",r);break;case"run.leave":g=void 0,b.cancel("_definition-api"),i(),D("leave")}i()}function P(e,t){const{content:n,properties:r}=t,i=r.type;switch(t.ack(),i){case"stopped":return I(),D("stop");case"error":b.publish("run","run.error",n),b.publish("run","run.discarded",n);break;default:b.publish("run","run.end",n)}if(l){const e=l;l=null,e.ack()}}function D(e,t={}){const n={type:e,mandatory:"error"===e};b.publish("event",`definition.${e}`,a?a.createMessage(t):t,n)}function M(){return u||B(),u}function B(){if(u)return u;p=e.getExecutableProcesses()||[],u=e.getProcesses()||[],s.debug(`<${n}> found ${u.length} processes`)}function _(t){return e.getActivityById(t)}function F(e){return a?a.getApi(e):pt(b,e||d)}function N(e,t){switch(t.properties.type){case"stop":if(a&&!a.completed)return;f=!0,I(),D("stop")}}},Dummy:Gt,TextAnnotation:Gt,EndEvent:function(e,t){return Ot(Ut,{...e,isThrowing:!0},t)},Environment:Qt,ErrorEventDefinition:function(e,t){const{id:n,broker:r,environment:i,getActivityById:o,isThrowing:s}=e,{type:a="ErrorEventDefinition",behaviour:c={}}=t,{debug:u}=i.Logger(a.toLowerCase()),p=c.errorRef||{name:"anonymous"},l=p.id&&o(p.id),d=l?l.id:"anonymous",f=`error-${yt(n)}-${yt(d)}-q`;return s||(r.assertQueue(f,{autoDelete:!1,durable:!0}),r.bindQueue(f,"api","*.throw.#",{durable:!0,priority:300})),{type:a,reference:{...p,referenceType:"throw"},execute:s?function(e){const t=rt(e.content),{executionId:i,parent:o}=t,s=o&&o.executionId,{message:a,description:c}=m(e);return u(`<${i} (${n})> throw ${c}`),r.publish("event","activity.throw",{...rt(t),executionId:s,parent:at(o),message:{...a},state:"throw"},{type:"throw",delegate:!0}),r.publish("execution","execute.completed",{...t,message:a})}:function(e){let t;const o=rt(e.content),{executionId:s,parent:a}=o,c=a&&a.executionId,{message:p,description:d}=m(e);if(r.consume(f,(function(e,t){const n=t.content.message;if(!l)return g(e,t,n);if(p.id!==(n&&n.id))return;return g(e,t,n)}),{noAck:!0,consumerTag:`_onthrow-${s}`}),t)return;if(r.subscribeTmp("api",`activity.#.${s}`,(function(e,n){switch(n.properties.type){case"discard":return t=!0,y(),r.publish("execution","execute.discard",rt(o));case"stop":y()}}),{noAck:!0,consumerTag:`_api-${s}`}),!i.settings.strict){const e=`execute.throw.${s}`;r.publish("execution","execute.expect",{...rt(o),expectRoutingKey:e,expect:{...p}}),r.subscribeOnce("execution",e,(function(e,t){const n=t.content.error;if(!l)return g(e,t,n);if(!n)return;if(""+n.code!=""+p.code)return;return g(e,t,n)}),{consumerTag:`_onerror-${s}`})}if(t)return y();function g(i,a,p){return t=!0,y(),u(`<${s} (${n})> caught ${d}`),r.publish("event","activity.catch",{...o,source:{id:a.content.id,type:a.content.type,executionId:a.content.executionId},error:p,executionId:c,parent:at(e.content.parent)},{type:"catch"}),r.publish("execution","execute.completed",{...o,output:p,cancelActivity:!0,state:"catch"})}function y(){r.cancel(`_onthrow-${s}`),r.cancel(`_onerror-${s}`),r.cancel(`_api-${s}`),r.purgeQueue(f)}u(`<${s} (${n})> expect ${d}`),r.publish("event","activity.wait",{...o,executionId:c,parent:at(a),expect:{...p}})}};function m(e){if(!l)return{message:{...p},description:"anonymous error"};const t={message:l.resolve(e)};return t.description=`${t.message.name} <${t.message.id}>`,t.message.code&&(t.description+=` code ${t.message.code}`),t}},Escalation:function(e,t){const{id:n,type:r,name:i,parent:o}=e,{environment:s}=t,a={...o};return{id:n,type:r,name:i,parent:a,resolve:function(e){return{id:n,type:r,messageType:"escalation",name:i&&s.resolveExpression(i,e),parent:{...a}}}}},EscalationEventDefinition:function(e,t){const{id:n,broker:r,environment:i,isThrowing:o,getActivityById:s}=e,{type:a,behaviour:c={}}=t,{debug:u}=i.Logger(a.toLowerCase()),p=c.escalationRef||{name:"anonymous"},l=p.id&&s(p.id),d=l?l.id:"anonymous",f=`escalate-${yt(n)}-${yt(d)}-q`;return o||(r.assertQueue(f,{autoDelete:!1,durable:!0}),r.bindQueue(f,"api","*.escalate.#",{durable:!0,priority:400})),{id:n,type:a,reference:{...p,referenceType:"escalate"},execute:o?function(e){const t=rt(e.content),{executionId:i,parent:o}=t,s=o&&o.executionId,{message:a,description:c}=m(e);return u(`<${i} (${n})> escalate ${c}`),r.publish("event","activity.escalate",{...rt(t),executionId:s,parent:at(o),message:{...a},state:"throw"},{type:"escalate",delegate:!0}),r.publish("execution","execute.completed",{...t})}:function(e){let t;const i=rt(e.content),{executionId:o,parent:s}=i,a=s&&s.executionId,{message:c,description:p}=m(e);if(r.consume(f,l,{noAck:!0,consumerTag:`_onescalate-${o}`}),t)return;if(r.subscribeTmp("api",`activity.#.${o}`,(function(e,n){switch(n.properties.type){case"escalate":return l(e,n);case"discard":return t=!0,d(),r.publish("execution","execute.discard",{...i});case"stop":d()}}),{noAck:!0,consumerTag:`_api-${o}`}),t)return d();function l(s,l){if(Nt(l,"content.message.id")!==c.id)return;const f=l.content.message;return t=!0,d(),u(`<${o} (${n})> caught ${p}`),r.publish("event","activity.catch",{...i,message:{...f},executionId:a,parent:at(e.content.parent)},{type:"catch"}),r.publish("execution","execute.completed",{...i,output:f,state:"catch"})}function d(){r.cancel(`_api-${o}`),r.cancel(`_onescalate-${o}`)}u(`<${o} (${n})> expect ${p}`),r.publish("event","activity.wait",{...i,executionId:a,parent:at(s),escalation:{...c}})}};function m(e){if(!l)return{message:{...p},description:"anonymous escalation"};const t={message:l.resolve(e)};return t.description=`${t.message.name} <${t.message.id}>`,t}},EventBasedGateway:function(e,t){return Ot(Ht,{...e},t)},ExclusiveGateway:function(e,t){return Ot(Wt,e,t)},InclusiveGateway:function(e,t){return Ot(Xt,e,t)},InputOutputSpecification:function(e,t,n){const{id:r,type:i="iospecification",behaviour:o={}}=t,{broker:s}=e,a=yt(i).toLowerCase();let c;const{dataInputs:u,dataOutputs:p}=o;return{id:r,type:i,behaviour:o,activate:function(){if(c)return;c=s.subscribeTmp("event","activity.#",l,{noAck:!0})},deactivate:function(){c&&(c=c.cancel())}};function l(e,t){if((u||p)&&"activity.enter"===e)return function(){const e=`run.onstart.${a}`;if(!u)return s.publish("format",e,{ioSpecification:{dataOutputs:d()}});const{dataObjects:t,sources:r}=u.reduce((e,t,r)=>{const i={id:t.id,type:t.type,name:t.name};e.sources.push(i);const o=Nt(t,"behaviour.association.source.dataObject.id");if(!o)return e;const s=n.getDataObjectById(o);return s?(e.dataObjects.push({index:r,dataObject:s}),e):e},{dataObjects:[],sources:[]});if(!t.length)return s.publish("format",e,{ioSpecification:{dataInputs:r,dataOutputs:d()}});const i=`run.onstart.${a}.end`;return s.publish("format",`${e}.begin`,{endRoutingKey:i,ioSpecification:{dataInputs:r.map(e=>({...e})),dataOutputs:d()}}),function(e,t,n){const r=[];let i=0;const o=e.subscribeTmp("data","data.read.#",(function(e,s){const{index:a}=t.find(({dataObject:e})=>e.id===s.content.id);if(r.push({...s.content,index:a}),++i<t.length)return;return o.cancel(),n(null,r)}),{noAck:!0});for(let n=0;n<t.length;n++){const{dataObject:r}=t[n];r.read(e,"data","data.read.")}}(s,t,(e,t)=>{t.forEach(e=>{r[e.index].value=e.value}),s.publish("format",i,{ioSpecification:{dataInputs:r,dataOutputs:d()}})})}();p&&"activity.execution.completed"===e&&function(e){const t=Nt(e,"content.ioSpecification.dataInputs"),r=Nt(e,"content.output.ioSpecification.dataOutputs")||[],{dataObjects:i,sources:o}=p.reduce((e,t,i)=>{const{value:o}=r.find(e=>e.id===t.id)||{},s={id:t.id,type:t.type,name:t.name,value:o};e.sources.push(s);const a=Nt(t,"behaviour.association.target.dataObject.id");if(!a)return e;const c=n.getDataObjectById(a);return c?(e.dataObjects.push({index:i,dataObject:c,value:o}),e):e},{dataObjects:[],sources:[]}),c=`run.onend.${a}`;if(!i.length)return s.publish("format",c,{ioSpecification:{dataInputs:t,dataOutputs:o}});const u=`run.onend.${a}.end`;s.publish("format",`${c}.begin`,{endRoutingKey:u,ioSpecification:{dataInputs:o.map(e=>({...e})),dataOutputs:d()}}),function(e,t,n){const r=[];let i=0;const o=e.subscribeTmp("data","data.write.#",(function(e,s){const a=t.findIndex(e=>e.id===s.content.id);if(r[a]=s.content,++i<t.length)return;return o.cancel(),n(null,r)}),{noAck:!0});for(let n=0;n<t.length;n++){const{dataObject:r,value:i}=t[n];r.write(e,"data","data.write.",i)}}(s,i,(e,t)=>{t.forEach(e=>{o[e.index].value=e.value}),s.publish("format",u,{ioSpecification:{dataInputs:o,dataOutputs:d()}})})}(t)}function d(){if(p)return p.map(e=>({id:e.id,type:e.type,name:e.name}))}},IntermediateCatchEvent:function(e,t){return Ot(Jt,e,t)},IntermediateThrowEvent:function(e,t){return Ot(Yt,{...e,isThrowing:!0},t)},LinkEventDefinition:function(e,t){const{id:n,broker:r,environment:i,isThrowing:o}=e,{type:s}=t,{debug:a}=i.Logger(s.toLowerCase()),c={linkName:t.behaviour.name},u=`link-${yt(n)}-${yt(c.linkName)}-q`;return o?r.subscribeTmp("event","activity.discard",(function(e,t){r.publish("event","activity.link.discard",{...rt(t.content),message:{...c},state:"discard"},{type:"link",delegate:!0})}),{noAck:!0,consumerTag:"_link-parent-discard"}):(r.assertQueue(u,{autoDelete:!1,durable:!0}),r.bindQueue(u,"api","*.link.#",{durable:!0})),{id:n,type:s,reference:{...c,referenceType:"link"},execute:o?function(e){const t=rt(e.content),{executionId:i,parent:o}=t,s=o&&o.executionId,u=p();return a(`<${i} (${n})> throw ${u}`),r.publish("event","activity.link",{...rt(t),executionId:s,parent:at(o),message:{...c},state:"throw"},{type:"link",delegate:!0}),r.publish("execution","execute.completed",t)}:function(e){let t;const i=rt(e.content),{executionId:o,parent:s}=i,l=s&&s.executionId,d=p();if(r.consume(u,(function(e,t){if(Nt(t,"content.message.linkName")!==c.linkName)return;return"discard"===t.content.state?g():m("caught",t.content.message)}),{noAck:!0,consumerTag:`_api-link-${o}`}),t)return;function f(e,t){switch(t.properties.type){case"link":return m("got link with",t.content.message);case"discard":return g();case"stop":y()}}function m(s,u){return t=!0,y(),a(`<${o} (${n})> ${s} ${d}`),r.publish("event","activity.catch",{...i,link:{...c},message:{...u},executionId:l||o,parent:at(e.content.parent)},{type:"catch"}),r.publish("execution","execute.completed",{...i,output:u,state:"catch"})}function g(){return t=!0,y(),r.publish("execution","execute.discard",{...i})}function y(){r.cancel(`_api-link-${o}`),r.cancel(`_api-parent-${l}`),r.cancel(`_api-${o}`),r.purgeQueue(u)}r.subscribeTmp("api",`activity.stop.${l}`,f,{noAck:!0,consumerTag:`_api-parent-${l}`}),r.subscribeTmp("api",`activity.#.${o}`,f,{noAck:!0,consumerTag:`_api-${o}`}),a(`<${o} (${n})> expect ${d}`),r.publish("event","activity.wait",{...i,executionId:l,parent:at(s),link:{...c}})}};function p(){return`link ${c.linkName}`}},Message:function(e,t){const{id:n,type:r,name:i,parent:o}=e,{environment:s}=t,a={...o};return{id:n,type:r,name:i,parent:a,resolve:function(e){return{id:n,type:r,messageType:"message",name:i&&s.resolveExpression(i,e),parent:{...a}}}}},MessageEventDefinition:function(e,t){const{id:n,broker:r,environment:i,isThrowing:o,getActivityById:s}=e,{type:a="MessageEventDefinition",behaviour:c={}}=t,{debug:u}=i.Logger(a.toLowerCase()),p=c.messageRef||{name:"anonymous"},l=p.id&&s(p.id),d=l?l.id:"anonymous",f=`message-${yt(n)}-${yt(d)}-q`;return o||(r.assertQueue(f,{autoDelete:!1,durable:!0}),r.bindQueue(f,"api","*.message.#",{durable:!0})),{id:n,type:a,reference:{...p,referenceType:"message"},execute:o?function(e){const t=rt(e.content),{executionId:i,parent:o}=t,s=o&&o.executionId,{message:a,description:c}=m(e);return u(`<${i} (${n})> message ${c}`),r.publish("event","activity.message",{...rt(t),executionId:s||i,parent:at(o),message:{...a},state:"throw"},{type:"message",delegate:!0}),r.publish("execution","execute.completed",{...t})}:function(e){let t;const i=rt(e.content),{executionId:o,parent:s}=i,a=s&&s.executionId,{message:c,description:p}=m(e);if(r.consume(f,(function(e,t){if(Nt(t,"content.message.id")!==c.id)return;d("caught",t.content.message)}),{noAck:!0,consumerTag:`_onmessage-${o}`}),t)return;r.subscribeTmp("api",`activity.#.${o}`,l,{noAck:!0,consumerTag:`_api-${o}`,priority:400}),a&&r.subscribeTmp("api",`activity.#.${a}`,l,{noAck:!0,consumerTag:`_api-parent-${o}`,priority:400});function l(e,n){switch(n.properties.type){case"message":case"signal":return d("got signal with",n.content.message);case"discard":return t=!0,g(),r.publish("execution","execute.discard",{...i});case"stop":return g()}}function d(s,c){return t=!0,g(),u(`<${o} (${n})> ${s} ${p}`),r.publish("event","activity.catch",{...i,message:{...c},executionId:a||o,parent:at(e.content.parent)},{type:"catch"}),r.publish("execution","execute.completed",{...i,output:c,state:"catch"})}function g(){r.cancel(`_onmessage-${o}`),r.cancel(`_api-${o}`),r.cancel(`_api-parent-${o}`),r.purgeQueue(f)}u(`<${o} (${n})> expect ${p}`),r.publish("event","activity.wait",{...i,executionId:a||o,parent:at(s),message:{...c}})}};function m(e){if(!l)return{message:{...p},description:"anonymous message"};const t={message:l.resolve(e)};return t.description=`${t.message.name} <${t.message.id}>`,t}},MessageFlow:function(e,t){const{id:n,type:r="message",name:i,target:o,source:s,behaviour:a,parent:c}=e,u=t.getActivityById(s.id),p=`_message-on-end-${yt(n)}`,l=`_message-on-message-${yt(n)}`,{debug:d}=t.environment.Logger(r.toLowerCase());if(!u)return;const f={messages:0,discard:0},m={id:n,type:r,name:i,target:o,source:s,behaviour:a,get counters(){return{...f}},activate:function(){u.broker.subscribeTmp("event","activity.message",w,{consumerTag:l,noAck:!0}),u.broker.subscribeTmp("event","activity.end",x,{consumerTag:p,noAck:!0})},deactivate:$,getApi:function(){return m},getState:function(){return{id:n,type:r,counters:{...f}}},recover:function(e){Object.assign(f,e.counters),g.recover(e.broker)},resume:function(){g.resume()},stop:function(){$(),g.stop()}},{broker:g,on:y,once:h,emit:b,waitFor:v}=function(e){const t=Tt(e,{prefix:"messageflow",autoDelete:!1,durable:!1}),n=t.broker;return n.assertExchange("message","topic",{durable:!0,autoDelete:!1}),n.assertQueue("message-q",{durable:!0,autoDelete:!1}),n.bindQueue("message-q","message","message.#"),t}(m);return m.on=y,m.once=h,m.emit=b,m.waitFor=v,Object.defineProperty(m,"broker",{enumerable:!0,get:()=>g}),m;function x(e,{content:t}){var a;++f.messages,d(`<${n}> sending message from <${s.processId}.${s.id}> to`,o.id?`<${o.processId}.${o.id}>`:`<${o.processId}>`),g.publish("event","message.outbound",(a=t.message,{id:n,type:r,name:i,source:{...s},target:{...o},parent:c&&ot(c),message:a}))}function w(){$()}function $(){u.broker.cancel(l),u.broker.cancel(p)}},MultiInstanceLoopCharacteristics:Zt,ParallelGateway:function(e,t){return Ot(en,{...e,isParallelGateway:!0},t)},Process:function(e,t){const{id:n,type:r="process",name:i,parent:o,behaviour:s={}}=e,a=t.environment,{isExecutable:c}=s,u=a.Logger(r.toLowerCase());let p,l,d,f,m,g,y,h,b={completed:0,discarded:0,terminated:0};const v={id:n,type:r,name:i,isExecutable:c,behaviour:s,get counters(){return{...b}},get executionId(){return d},get status(){return f},get stopped(){return m},get execution(){return p},get isRunning(){return!!h&&!!f},context:t,environment:a,parent:{...o},logger:u,getApi:S,getActivities:function(){return p?p.getActivities():t.getActivities(n)},getActivityById:D,getSequenceFlows:function(){return p?p.getSequenceFlows():t.getSequenceFlows()},getPostponed:function(...e){return p?p.getPostponed(...e):[]},getStartActivities:M,getState:function(){return F({executionId:d,status:f,stopped:m,counters:{...b},broker:x.getState(),execution:p&&p.getState()})},init:function(){l=ht(n),u.debug(`<${n}> initialized with executionId <${l}>`),P("init",F({executionId:l}))},recover:function(e){if(v.isRunning)throw new Error(`cannot recover running process <${n}>`);if(!e)return v;m=e.stopped,f=e.status,d=e.executionId,e.counters&&(b={...b,...e.counters});e.execution&&(p=tn(v,t).recover(e.execution));return x.recover(e.broker),v},resume:function(){if(v.isRunning)throw new Error(`cannot resume running process <${n}>`);if(!f)return v;m=!1;const e=F({executionId:d});return x.publish("run","run.resume",e,{persistent:!1}),R(),v},run:I,sendMessage:function(e){const t=e.content;if(!t)return;let n=!1;t.target&&t.target.id&&D(t.target.id)?n=!0:t.message&&M({referenceId:t.message.id,referenceType:t.message.messageType}).length&&(n=!0);if(!n)return;f||I();S().sendApiMessage(e.properties.type||"message",rt(t),{delegate:!0})},signal:function(e){return S().signal(e,{delegate:!0})},stop:function(){if(!v.isRunning)return;S().stop()}},{broker:x,on:w,once:$,waitFor:E}=St(v,"process");v.on=w,v.once=$,v.waitFor=E;const A=x.getQueue("run-q"),C=x.getQueue("execution-q");Object.defineProperty(v,"broker",{enumerable:!0,get:()=>x});const k=t.loadExtensions(v);return Object.defineProperty(v,"extensions",{enumerable:!0,get:()=>k}),v;function I(e){if(v.isRunning)throw new Error(`process <${n}> is already running`);d=l||ht(n),l=void 0;const t=F({...e,executionId:d});x.publish("run","run.enter",t),x.publish("run","run.start",rt(t)),x.publish("run","run.execute",rt(t)),R()}function R(){h=!0,x.subscribeTmp("api",`process.*.${d}`,B,{noAck:!0,consumerTag:"_process-api",priority:100}),A.assertConsumer(T,{exclusive:!0,consumerTag:"_process-run"})}function S(e){return p?p.getApi(e):lt(x,e||y)}function T(e,r){const{content:i,ack:o,fields:s}=r;if("run.resume"===e)return function(){switch(r.ack(),y.fields.routingKey){case"run.enter":case"run.start":case"run.discarded":case"run.end":case"run.leave":break;default:return}if(!y.fields.redelivered)return;return u.debug(`<${n}> resume from ${f}`),x.publish("run",y.fields.routingKey,rt(y.content),y.properties)}();switch(y=r,e){case"run.enter":if(u.debug(`<${n}> enter`),f="entered",s.redelivered)break;p=void 0,P("enter",i);break;case"run.start":u.debug(`<${n}> start`),f="start",P("start",i);break;case"run.execute":{f="executing";const e=it(r);return s.redelivered&&!p&&(e.fields.redelivered=void 0),g=r,C.assertConsumer(O,{exclusive:!0,consumerTag:"_process-execution"}),(p=p||tn(v,t)).execute(e)}case"run.error":P("error",rt(i,{error:s.redelivered?Rt(r):i.error}));break;case"run.end":if(f="end",s.redelivered)break;u.debug(`<${n}> completed`),b.completed++,x.publish("run","run.leave",i),P("end",i);break;case"run.discarded":if(f="discarded",s.redelivered)break;b.discarded++,x.publish("run","run.leave",i);break;case"run.leave":f=void 0,x.cancel("_process-api"),P("leave")}o()}function O(e,t){const n=t.content,r=t.properties.type;switch(t.ack(),r){case"stopped":return _();case"error":x.publish("run","run.error",n),x.publish("run","run.discarded",n);break;case"discard":x.publish("run","run.discarded",n);break;default:x.publish("run","run.end",n)}if(g){const e=g;g=null,e.ack()}}function P(e,t){t||(t=F()),x.publish("event",`process.${e}`,{...t,state:e},{type:e,mandatory:"error"===e})}function D(e){return p?p.getActivityById(e):t.getActivityById(e)}function M(e){return t.getStartActivities(e,n)}function B(e,t){switch(t.properties.type){case"stop":if(p&&!p.completed)return;_()}}function _(){return m=!0,x.cancel("_process-api"),x.cancel("_process-run"),x.cancel("_process-execution"),h=!1,P("stop")}function F(e={}){return{id:n,type:r,name:i,parent:{...o},...e}}},ReceiveTask:function(e,t){const n=Ot(nn,e,t);return n.broker.assertQueue("message",{autoDelete:!1,durable:!0}),n.broker.bindQueue("message","api","*.message.#",{durable:!0}),n},ScriptTask:function(e,t){return Ot(on,e,t)},SequenceFlow:function(e,{environment:t}){const{id:n,type:r="sequenceflow",name:i,parent:o,targetId:s,sourceId:a,isDefault:c,behaviour:u={}}=e,p=ot(o),l=t.Logger(r.toLowerCase());t.registerScript({id:n,type:r,behaviour:u});const d={looped:0,take:0,discard:0},f={id:n,type:r,name:i,parent:p,behaviour:u,sourceId:a,targetId:s,isDefault:c,isSequenceFlow:!0,environment:t,get counters(){return{...d}},discard:function(e={}){const{sequenceId:t}=e,r=e.discardSequence=(e.discardSequence||[]).slice();if(r.indexOf(s)>-1)return++d.looped,l.debug(`<${n}> discard loop detected <${a}> -> <${s}>. Stop.`),v("looped",e);r.push(a),l.debug(`<${t} (${n})> discard, target <${s}>`),++d.discard,v("discard",e)},evaluateCondition:function(e,t){const r=w();if(!r)return!0;const i=r.execute(e,t);return l.debug(`<${n}> condition result evaluated to ${i}`),i},getApi:function(e){return dt(m,e||{content:x()})},getCondition:w,getState:function(){const e={id:n,type:r,name:i,sourceId:a,targetId:s,isDefault:c,counters:{...d}};return e.broker=m.getState(),e},preFlight:function(e){const t=ht(n);return m.publish("event","flow.pre-flight",x({action:e,sequenceId:t,state:"pre-flight"}),{type:"pre-flight"}),t},recover:function(e){Object.assign(d,e.counters),m.recover(e.broker)},shake:function(e){const t=rt(e.content);t.sequence=t.sequence||[],t.sequence.push({id:n,type:r,isSequenceFlow:!0,targetId:s});for(const r of e.content.sequence)if(r.id===n)return m.publish("event","flow.shake.loop",t,{persistent:!1,type:"shake"});m.publish("event","flow.shake",t,{persistent:!1,type:"shake"})},stop:function(){m.stop()},take:function(e={}){f.looped=void 0;const{sequenceId:t}=e;return l.debug(`<${t} (${n})> take, target <${s}>`),++d.take,v("take",e),!0}},{broker:m,on:g,once:y,waitFor:h,emitFatal:b}=Tt(f,{prefix:"flow",durable:!0,autoDelete:!1});return f.on=g,f.once=y,f.waitFor=h,Object.defineProperty(f,"broker",{enumerable:!0,get:()=>m}),l.debug(`<${n}> init, <${a}> -> <${s}>`),f;function v(e,t){const n=x({action:e,...t});m.publish("event",`flow.${e}`,n,{type:e})}function x(e={}){return{...e,id:n,type:r,name:i,sourceId:a,targetId:s,isSequenceFlow:!0,isDefault:c,parent:ot(p)}}function w(){const e=u.conditionExpression;if(!e)return null;if(!("language"in e))return r=e.body,{execute:e=>t.resolveExpression(r,x(e))};var r;return function(e,t){return{language:t,execute:(r,i)=>{if(!e){const e=new Error(`Script format ${t} is unsupported or was not registered (<${n}>)`);return l.error(`<${n}>`,e),b(e,x()),i&&i(e)}try{return e.execute(rn(f,r))}catch(e){if(!i)throw e;l.error(`<${n}>`,e),i(e)}}}}(t.getScript(e.language,f),e.language)}},ServiceImplementation:function(e){const{type:t,behaviour:n,environment:r}=e,i=n.implementation;return{type:`${t}:implementation`,implementation:i,execute:function(t,n){const o=r.resolveExpression(i,t);if("function"!=typeof o)return n(new Error(`Implementation ${i} did not resolve to a function`));o.call(e,rn(e,t),(e,...t)=>{n(e,t)})}}},SendTask:sn,ServiceTask:sn,Signal:function(e,t){const{id:n,type:r,name:i,parent:o}=e,{environment:s}=t,a={...o};return{id:n,type:r,name:i,parent:a,resolve:function(e){return{id:n,type:r,messageType:"signal",name:i&&s.resolveExpression(i,e),parent:{...a}}}}},SignalEventDefinition:function(e,t){const{id:n,broker:r,environment:i,isThrowing:o,getActivityById:s}=e,{type:a,behaviour:c={}}=t,{debug:u}=i.Logger(a.toLowerCase()),p=c.signalRef||{name:"anonymous"},l=p.id&&s(p.id),d=l?l.id:"anonymous",f=`signal-${yt(n)}-${yt(d)}-q`;return o||(r.assertQueue(f,{autoDelete:!1,durable:!0}),r.bindQueue(f,"api","*.signal.#",{durable:!0})),{id:n,type:a,reference:{...p,referenceType:"signal"},execute:o?function(e){const t=rt(e.content),{executionId:i,parent:o}=t,s=o&&o.executionId,{message:a,description:c}=m(e);return u(`<${i} (${n})> throw ${c}`),r.publish("event","activity.signal",{...rt(t),executionId:s,parent:at(o),message:{...a},state:"throw"},{type:"signal"}),r.publish("execution","execute.completed",t)}:function(e){let t;const i=rt(e.content),{executionId:o,parent:s}=i,a=s&&s.executionId,{message:c,description:p}=m(e);if(r.consume(f,(function(e,n){if(Nt(n,"content.message.id")!==c.id)return;return t=!0,g(),d(n.content.message)}),{noAck:!0,consumerTag:`_api-signal-${o}`}),t)return;function l(e,n){switch(n.properties.type){case"signal":return d(n.content.message);case"discard":return t=!0,g(),r.publish("execution","execute.discard",{...i});case"stop":g()}}function d(e){return t=!0,g(),u(`<${o} (${n})> signaled with`,p),r.publish("execution","execute.completed",{...i,output:e,state:"signal"})}function g(){r.cancel(`_api-signal-${o}`),r.cancel(`_api-parent-${a}`),r.cancel(`_api-${o}`),r.purgeQueue(f)}r.subscribeTmp("api",`activity.#.${a}`,l,{noAck:!0,consumerTag:`_api-parent-${a}`}),r.subscribeTmp("api",`activity.#.${o}`,l,{noAck:!0,consumerTag:`_api-${o}`}),u(`<${o} (${n})> expect ${p}`),r.publish("event","activity.wait",{...i,executionId:a,parent:at(s),signal:{...c}})}};function m(e){if(!l)return{message:{...p},description:"anonymous signal"};const t={message:l.resolve(e)};return t.description=`${t.message.name} <${t.message.id}>`,t}},ManualTask:cn,UserTask:cn,SignalTask:cn,StandardLoopCharacteristics:function(e,t){let{behaviour:n={}}=t;return n={...n,isSequential:!0},Zt(e,{...t,behaviour:n})},StartEvent:function(e,t){return Ot(pn,e,t)},SubProcess:function(e,t){const n=e.behaviour&&e.behaviour.triggeredByEvent,r=Ot(ln,{...e,isSubProcess:!0,triggeredByEvent:n},t);return r.getStartActivities=function(n){return t.getStartActivities(n,e.id)},r},Task:function(e,t){return Ot(dn,e,t)},TerminateEventDefinition:function(e,t={}){const{id:n,broker:r,environment:i}=e,{type:o="terminateeventdefinition"}=t,{debug:s}=i.Logger(o.toLowerCase());return{id:n,type:o,execute:function(e){const t=rt(e.content),n=rt(t);n.parent=at(n.parent),n.state="terminate",s(`<${t.executionId} (${t.id})> terminate`),r.publish("event","process.terminate",n,{type:"terminate"}),r.publish("execution","execute.completed",t)}}},TimerEventDefinition:function(e,t){const{id:n,broker:r,environment:i}=e,{type:o="TimerEventDefinition",behaviour:s={}}=t,{timeDuration:a}=s,{debug:c}=i.Logger(o.toLowerCase());let u;const p={type:o,timeDuration:a,execute:function(e){u&&(u=clearTimeout(u));const t=e.content,{executionId:o}=t,s=e.fields&&e.fields.redelivered;if(s&&"execute.timer"!==e.fields.routingKey)return c(`<${o} (${n})> resumed, waiting for timer message`);let p;return r.subscribeTmp("api",`activity.#.${o}`,(function(e,i){switch(i.properties.type){case"stop":return r.cancel(`_api-${o}`),u=clearTimeout(u),c(`<${o} (${n})> stopped`);case"discard":return r.cancel(`_api-${o}`),u=clearTimeout(u),c(`<${o} (${n})> discarded`),r.publish("execution","execute.discard",{...t,state:"discard"})}}),{noAck:!0,consumerTag:`_api-${o}`,priority:400}),s?function(){p=e.content;const{startedAt:t,isoDuration:i,timeout:s}=p,a=new Date(t);let d=s-(new Date-a);d<0&&(d=0);c(`<${o} (${n})> resume timer ${s}ms started at ${a.toISOString()}, duration ${i||"none"}, remaining ${d}ms`),r.publish("execution","execute.timer",rt(p)),r.publish("event","activity.timer",rt(p)),u=setTimeout(l,d)}():function(){const s=a&&i.resolveExpression(a,e),d=s?1e3*yn(gn(s)):0,f=new Date;c(`<${o} (${n})> start timer ${d}ms, duration ${s||"none"}`),p={...t,isoDuration:s,timeout:d,startedAt:f,state:"timer"},r.publish("execution","execute.timer",rt(p)),r.publish("event","activity.timer",rt(p)),u=setTimeout(l,d)}();function l(){r.cancel(`_api-${o}`),u=void 0;const e=new Date(p.startedAt),t=new Date,i=t.getTime()-e.getTime();c(`<${o} (${n})> completed in ${i}ms, duration ${p.isoDuration||"none"}`);const s={...p,stoppedAt:t,runningTime:i,state:"timeout"};r.publish("event","activity.timeout",rt(s)),r.publish("execution","execute.completed",rt(s))}},stop(){u&&(u=clearTimeout(u))}};return Object.defineProperty(p,"timer",{get:()=>u}),p}}),bn=function(e,t){let n;return"function"==typeof e?t=e:n=e,[n,t]};const{Script:vn}=i;var xn=function(){const e={};return{getScript:function(t,{id:n}){if(!/^javascript$/i.test(t))return;const r=e[n];if(!r)return;return{execute:function(e,t){return r.runInNewContext({...e,next:t})}}},register:function({id:t,type:n,behaviour:r}){let i,o="javascript";switch(n){case"bpmn:SequenceFlow":if(!r.conditionExpression)return;o=r.conditionExpression.language,i=r.conditionExpression.body;break;default:o=r.scriptFormat,i=r.script}if(!/^javascript$/i.test(o))return;e[t]=new vn(i,{filename:`${n}/${t}`})}}},wn=function(e,{environment:t}){const{id:n,type:r,name:i,behaviour:o,parent:s}=e;return{id:n,name:i,type:r,behaviour:o,parent:s,read(e,o,s,a){const c=t.variables.data&&t.variables.data[n];return e.publish(o,`${s}response`,{id:n,name:i,type:r,value:c},a)},write:(e,o,s,a,c)=>(t.variables.data=t.variables.data||{},t.variables.data[n]=a,t.output.data=t.output.data||{},t.output.data[n]=a,e.publish(o,`${s}response`,{id:n,name:i,type:r,value:a},c))}};var $n,En="BPMN 2.0 execution engine. Open source javascript workflow engine.",An="dist/index.js",Cn={type:"git",url:"git://github.com/paed01/bpmn-engine"},kn={name:"Pål Edman",url:"https://github.com/paed01"},In={node:">=10"},Rn=["lib/","index.js"],Sn={test:"mocha -R dot",posttest:"eslint . --cache && npm run toc",wintest:"node_modules/.bin/mocha",toc:"node scripts/generate-api-toc ./docs/API.md,./docs/Examples.md","test-md":"node scripts/test-markdown.js ./docs/API.md && node scripts/test-markdown.js ./docs/Examples.md",build:"rollup -c",server:"nodemon -r babel-register -r babel-polyfill  docs/examples/server.js",examples:"node -r babel-register -r babel-polyfill  docs/examples/run.js"},Tn=["workflow","engine","process","automation","bpmn","bpmn 2"],On=[{type:"MIT",url:"https://github.com/paed01/bpmn-engine/master/LICENSE"}],Pn={exclude:["test"]},Dn={"babel-polyfill":"^6.26.0","babel-preset-es2015":"^6.24.1","babel-preset-stage-3":"^6.24.1","babel-register":"^6.26.0",bent:"^7.0.2",chai:"^4.1.2",coveralls:"^3.0.7",eslint:"^6.5.1",express:"^4.17.1","markdown-toc":"^1.2.0",mocha:"^6.2.1","mocha-cakes-2":"^3.3.0",nock:"^11.4.0",nodemon:"^1.19.4","npm-run-all":"^4.1.5",nyc:"^14.1.1",rollup:"^1.25.2","rollup-plugin-commonjs":"^10.1.0","rollup-plugin-json":"^4.0.0","rollup-plugin-node-resolve":"^5.2.0","rollup-plugin-terser":"^5.1.2",unnecessary:"^1.3.4"},Mn={"bpmn-elements":"^0.11.0","camunda-bpmn-moddle":"^4.2.0","bpmn-moddle":"^6.0.0",debug:"^4.1.1","moddle-context-serializer":"^0.11.0",smqp:"^1.10.0"},Bn={name:"bpmn-engine",description:En,version:"8.4.0",main:An,source:"index.js",module:"dist/index.esm.js","umd:mainDist":"dist/bpmn-engine.umd.js",repository:Cn,author:kn,engines:In,files:Rn,scripts:Sn,keywords:Tn,license:"MIT",licenses:On,nyc:Pn,devDependencies:Dn,dependencies:Mn},_n=($n=Object.freeze({__proto__:null,name:"bpmn-engine",description:En,version:"8.4.0",main:An,source:"index.js",module:"dist/index.esm.js",repository:Cn,author:kn,engines:In,files:Rn,scripts:Sn,keywords:Tn,license:"MIT",licenses:On,nyc:Pn,devDependencies:Dn,dependencies:Mn,default:Bn}))&&$n.default||$n;const{Broker:Fn}=Ct,{default:Nn,deserialize:qn,TypeResolver:jn}=function(e,t){return function(e){const{activities:t,associations:n,dataObjects:r,definition:i,messageFlows:o,processes:s,sequenceFlows:a}=e;return{id:i.id,type:i.type,name:i.name,getActivities:function(e){return e?t.filter(t=>t.parent.id===e):t},getActivityById:function(e){return t.find(t=>t.id===e)},getAssociationById:function(e){return n.find(t=>t.id===e)},getAssociations:function(e){return e?n.filter(t=>t.parent.id===e):n},getDataObjects:function(){return r},getDataObjectById:function(e){return r.find(({id:t})=>t===e)},getExecutableProcesses:function(){return s.filter(e=>e.behaviour.isExecutable)},getInboundAssociations:function(e){return n.filter(t=>t.targetId===e)},getInboundSequenceFlows:function(e){return a.filter(t=>t.targetId===e)},getMessageFlows:function(e){return e?o.filter(t=>t.source.processId===e):o},getOutboundAssociations:function(e){return n.filter(t=>t.sourceId===e)},getOutboundSequenceFlows:function(e){return a.filter(t=>t.sourceId===e)},getProcessById:function(e){return s.find(({id:t})=>t===e)},getProcesses:function(){return s},getSequenceFlowById:function(e){return a.find(({id:t})=>t===e)},getSequenceFlows:function(e){return e?a.filter(t=>t.parent.id===e):a},serialize:function(){return JSON.stringify({id:i.id,type:i.type,name:i.name,activities:t,associations:n,dataObjects:r,definition:i,messageFlows:o,processes:s,sequenceFlows:a})}}}(function(e,t){const{activities:n,associations:r,dataObjects:i,definition:o,messageFlows:s,processes:a,sequenceFlows:c}=e;return o.Behaviour=t(o),a.forEach(t),n.forEach(t),i.forEach(t),s.forEach(t),c.forEach(t),r.forEach(t),e}(function(e){const{elementsById:t,references:n,rootHandler:r}=e,i=/^(?!\$).+?Ref$/,o={id:r.element.id,type:r.element.$type,name:r.element.name,targetNamespace:r.element.targetNamespace,exporter:r.element.exporter,exporterVersion:r.element.exporterVersion},{refs:s,dataInputAssociations:a,dataOutputAssociations:c,flowRefs:u,processRefs:p}=n.reduce((e,n)=>{const{property:r,element:i}=n;switch(r){case"bpmn:sourceRef":{const r=o(i.id,{id:i.id,$type:i.$type,sourceId:n.id,element:t[i.id]});(e.sourceRefs[n.id]=e.sourceRefs[n.id]||[]).push(r);break}case"bpmn:targetRef":{const t=o(i.id,{targetId:n.id});(e.targetRefs[n.id]=e.targetRefs[n.id]||[]).push(t);break}case"bpmn:default":o(n.id,{isDefault:!0});break;case"bpmn:dataObjectRef":e.refs.push(n);break;case"bpmn:processRef":e.processRefs[i.id]={id:n.id,$type:i.$type}}switch(i.$type){case"bpmn:OutputSet":case"bpmn:InputSet":break;case"bpmn:DataInputAssociation":e.dataInputAssociations.push(n);break;case"bpmn:DataOutputAssociation":e.dataOutputAssociations.push(n)}return e;function o(t,n){const r=e.flowRefs[t]=e.flowRefs[t]||{};return Object.assign(r,n),r}},{refs:[],dataInputAssociations:[],dataOutputAssociations:[],flowRefs:{},processRefs:{},sourceRefs:{},targetRefs:{}}),{activities:l,associations:d,dataObjects:f,messageFlows:m,processes:g,sequenceFlows:y}=function e(t,n){if(!n)return{};return n.reduce((n,r)=>{const{id:i,$type:o,name:a}=r;switch(r.$type){case"bpmn:DataObjectReference":break;case"bpmn:Collaboration":if(r.messageFlows){const{messageFlows:i}=e(t,r.messageFlows);n.messageFlows=n.messageFlows.concat(i)}break;case"bpmn:DataObject":n.dataObjects.push({id:i,name:a,type:o,parent:{id:t.id,type:t.type},references:s.filter(e=>e.id===r.id).map(e=>({id:e.element.id,type:e.element.$type,behaviour:{...e.element}})),behaviour:{...r}});break;case"bpmn:MessageFlow":{const e=u[r.id];n.messageFlows.push({...e,id:i,type:o,name:a,parent:{id:t.id,type:t.type},source:{processId:h(e.sourceId),id:e.sourceId},target:b(e.targetId),behaviour:{...r}});break}case"bpmn:Association":{const e=u[r.id];n.associations.push({id:i,name:a,type:o,parent:{id:t.id,type:t.type},targetId:e.targetId,sourceId:e.sourceId,behaviour:{...r}});break}case"bpmn:SequenceFlow":{const e=u[r.id];n.sequenceFlows.push({id:i,name:a,type:o,parent:{id:t.id,type:t.type},isDefault:e.isDefault,targetId:e.targetId,sourceId:e.sourceId,behaviour:{...r}});break}case"bpmn:SubProcess":case"bpmn:Process":{const s={id:i,type:o,name:a,parent:{id:t.id,type:t.type},behaviour:p()};"bpmn:Process"===o?n.processes.push(s):n.activities.push(s),[e({id:i,type:o},r.flowElements),e({id:i,type:o},r.artifacts)].forEach(e=>{e.activities&&(n.activities=n.activities.concat(e.activities)),e.sequenceFlows&&(n.sequenceFlows=n.sequenceFlows.concat(e.sequenceFlows)),e.dataObjects&&(n.dataObjects=n.dataObjects.concat(e.dataObjects)),e.associations&&(n.associations=n.associations.concat(e.associations))});break}case"bpmn:BoundaryEvent":{const e=A(r.attachedToRef);n.activities.push(c({attachedTo:e}));break}case"bpmn:ReceiveTask":{const e=A(r.messageRef);n.activities.push(c({messageRef:e}));break}default:n.activities.push(c())}return n;function c(e){return{id:i,type:o,name:a,parent:{id:t.id,type:t.type},behaviour:p(e)}}function p(e){const t=r.resources&&r.resources.map(v);return{...e,...r,eventDefinitions:r.eventDefinitions&&r.eventDefinitions.map(x),loopCharacteristics:r.loopCharacteristics&&x(r.loopCharacteristics),ioSpecification:r.ioSpecification&&x(r.ioSpecification),resources:t}}},{activities:[],associations:[],dataObjects:[],messageFlows:[],processes:[],sequenceFlows:[]})}(o,r.element.rootElements);return{activities:l,associations:d,dataObjects:f,definition:o,messageFlows:m,processes:g,sequenceFlows:y};function h(e){return r.element.rootElements.find(t=>"bpmn:Process"===t.$type&&t.flowElements.find(t=>t.id===e)).id}function b(e){const n=t[e];if(!n)return;const i={};switch(n.$type){case"bpmn:Participant":i.processId=p[e].id;break;default:{const t=r.element.rootElements.find(t=>"bpmn:Process"===t.$type&&t.flowElements.find(t=>t.id===e));i.processId=t.id,i.id=e}}return i}function v(e){if(!e)return;const{$type:t,resourceAssignmentExpression:n}=e;return{type:t,expression:n.expression&&n.expression.body,behaviour:{...e}}}function x(e){if(!e)return;const{$type:t}=e;let n={...e};const r=Object.getOwnPropertyNames(e);for(const t of r)i.test(t)&&(n[t]=A(e[t]));switch(t){case"bpmn:ConditionalEventDefinition":n.expression=n.condition&&n.condition.body;break;case"bpmn:InputOutputSpecification":n=function(e){const{dataInputs:t,dataOutputs:n}=e;return{dataInputs:t&&t.map(e=>({...e,type:e.$type,behaviour:w(e.id)})),dataOutputs:n&&n.map(e=>({...e,type:e.$type,behaviour:E(e.id)}))}}(e);break;case"bpmn:MultiInstanceLoopCharacteristics":n.loopCardinality=e.loopCardinality&&e.loopCardinality.body,n.completionCondition=e.completionCondition&&e.completionCondition.body;break;case"bpmn:StandardLoopCharacteristics":n.loopCondition=e.loopCondition&&e.loopCondition.body;break;case"bpmn:TimerEventDefinition":n.timeDuration=e.timeDuration&&e.timeDuration.body}return{type:t,behaviour:n}}function w(e){const t=a.find(t=>"bpmn:targetRef"===t.property&&t.id===e&&t.element),n=t&&a.find(e=>"bpmn:sourceRef"===e.property&&e.element&&e.element.id===t.element.id);return{association:{source:n&&{...n,dataObject:$(n.id)},target:t&&{...t}}}}function $(e){const t=s.find(t=>t.element&&t.element.id===e);if(t)return{...t}}function E(e){const t=c.find(t=>"bpmn:sourceRef"===t.property&&t.id===e&&t.element),n=t&&c.find(e=>"bpmn:targetRef"===e.property&&e.element&&e.element.id===t.element.id);return{association:{source:t&&{...t},target:n&&{...n,dataObject:$(n.id)}}}}function A(e){if(!e)return;const{id:t,$type:n,name:r}=e;return{id:t,type:n,name:r}}}(e),t))},{EventEmitter:Ln}=o,{version:Qn}=_n;var Vn={Engine:function(e={}){e={Logger:nt,scripts:xn(),...e};let t,n,{name:r,Logger:i}=e;const o=i("engine"),s=jn({...hn,...e.elements||{}},(function(t){if(e.typeResolver)return e.typeResolver(t);t["bpmn:DataObject"]=wn}));const a=[];e.source&&a.push(async function(t){return m(await function(t){return new Promise((n,r)=>{new Fe(e.moddleOptions).fromXML(Buffer.isBuffer(t)?t.toString():t.trim(),(e,t,i)=>{if(e)return r(e);n(i)})})}(t))}(e.source));e.moddleContext&&a.push(m(e.moddleContext));let c=hn.Environment(e);const u=new Ln,p=Object.assign(u,{execute:async function(...t){const[r,i]=bn(...t);let o;try{o=await Promise.all(a)}catch(e){if(i)return i(e);throw e}const s=o.map(e=>f(e,r));return(n=zn(p,s,e)).execute(r,i)},logger:o,getDefinitionById:async function(e){return(await d()).find(t=>t.id===e)},getDefinitions:d,getState:async function(){if(n)return n.getState();const t=await d();return zn(p,t,e).getState()},recover:function(e,n){if(!e)return p;o.debug(`<${r}> recover`),r||(r=e.name);n&&(c=hn.Environment(n));e.environment&&(c=c.recover(e.environment));return e.definitions?(t=e.definitions.map(e=>{const t=qn(JSON.parse(e.source),s);o.debug(`<${r}> recover ${e.type} <${e.id}>`);const n=f(t);return n.recover(e),n}),p):p},resume:async function(...t){const[r,i]=bn(...t);if(!n){const t=await d();n=zn(p,t,e)}return n.resume(r,i)},stop:async function(){if(!n)return;return n.stop()},waitFor:async function(e){return new Promise((t,n)=>{function r(t){p.removeListener(e,r),n(t)}p.once(e,(function(e){p.removeListener("error",r),t(e)})),p.once("error",r)})}}),l=Fn(p);return l.assertExchange("event","topic",{autoDelete:!1}),Object.defineProperty(p,"broker",{enumerable:!0,get:()=>l}),Object.defineProperty(p,"name",{enumerable:!0,get:()=>r,set(e){r=e}}),Object.defineProperty(p,"environment",{enumerable:!0,get:()=>c}),Object.defineProperty(p,"state",{enumerable:!0,get:()=>n?n.state:"idle"}),Object.defineProperty(p,"stopped",{enumerable:!0,get:()=>!!n&&n.stopped}),Object.defineProperty(p,"execution",{enumerable:!0,get:()=>n}),p;async function d(e){return t&&t.length?t:Promise.all(a).then(t=>t.map(t=>f(t,e)))}function f(e,t){const n=hn.Context(e,c.clone({listener:c.options.listener,...t,source:e}));return hn.Definition(n)}function m(e){return Nn(e,s)}}};function zn(e,t,n){const{environment:r,logger:i,waitFor:o,broker:s}=e;s.on("return",y);let a,c="idle";return{get state(){return c},get stopped(){return a},execute:function(n,r){return l(n),a=!1,i.debug(`<${e.name}> execute`),u(r),t.forEach(e=>e.run()),h()},getState:m,resume:function(n,r){return l(n),a=!1,i.debug(`<${e.name}> resume`),u(r),t.forEach(e=>e.resume()),h()},stop:p};function u(e){function t(){return n(),e(null,h())}function n(){s.cancel("ctag-cb-stop"),s.cancel("ctag-cb-end"),s.cancel("ctag-cb-error"),s.on("return",y)}e&&(s.off("return",y),n(),s.subscribeOnce("event","engine.stop",t,{consumerTag:"ctag-cb-stop"}),s.subscribeOnce("event","engine.end",t,{consumerTag:"ctag-cb-end"}),s.subscribeOnce("event","engine.error",(function(t,r){return n(),e(r.content)}),{consumerTag:"ctag-cb-error"}))}function p(){const e=o("stop");return t.forEach(e=>e.stop()),e}function l(e={}){const r=e.listener||n.listener;if(r&&"function"!=typeof r.emit)throw new Error("listener.emit is not a function");t.forEach((function(e){r&&(e.environment.options.listener=r);e.broker.subscribeTmp("event","definition.#",d,{noAck:!0,consumerTag:"_engine_definition"}),e.broker.subscribeTmp("event","process.#",d,{noAck:!0,consumerTag:"_engine_process"}),e.broker.subscribeTmp("event","activity.#",d,{noAck:!0,consumerTag:"_engine_activity"}),e.broker.subscribeTmp("event","flow.#",d,{noAck:!0,consumerTag:"_engine_flow"})}))}function d(n,o,u){const{environment:p}=u,l=p.options&&p.options.listener;let d,m,g;c="running";const y=u.getApi&&u.getApi(o);switch(n){case"definition.stop":if(f(u),t.some(e=>e.isRunning))break;d=!0,a=!0;break;case"definition.leave":if(f(u),t.some(e=>e.isRunning))break;m=!0;break;case"definition.error":f(u),g=!0;break;case"activity.wait":x("wait",u.getApi(o),h());break;case"process.end":if(!o.content.output)break;for(const e in o.content.output)switch(e){case"data":r.output.data=r.output.data||{},r.output.data={...r.output.data,...o.content.output.data};break;default:r.output[e]=o.content.output[e]}}var b;function v(t){s.publish("event",`engine.${t}`,{},{type:t}),e.emit(t,h())}function x(...e){l&&l.emit(...e)}x(n,y,h()),s.publish("event",n,{...o.content},{...o.properties,mandatory:!1}),d?(c="stopped",i.debug(`<${e.name}> stopped`),v("stop")):m?(c="idle",i.debug(`<${e.name}> completed`),v("end")):g&&(c="error",i.debug(`<${e.name}> error`),b=o.content.error,s.publish("event","engine.error",b,{type:"error",mandatory:!0}))}function f(e){e.broker.cancel("_engine_definition"),e.broker.cancel("_engine_process"),e.broker.cancel("_engine_activity"),e.broker.cancel("_engine_flow")}function m(){return{name:e.name,state:c,stopped:a,engineVersion:Qn,environment:r.getState(),definitions:t.map(g)}}function g(e){return{...e.getState(),source:e.environment.options.source.serialize()}}function y(t){"error"===t.properties.type&&e.emit("error",t.content)}function h(){return{name:e.name,get state(){return c},get stopped(){return a},environment:r,definitions:t,stop:p,getState:m,getPostponed:()=>t.reduce((e,t)=>e=e.concat(t.getPostponed()),[]),waitFor:o}}}var Kn=Vn.Engine;e.Engine=Kn,e.default=Vn,Object.defineProperty(e,"__esModule",{value:!0})}));
